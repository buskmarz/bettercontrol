<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Better Mood Coffee · Control de Cafetería</title>
<link rel="icon" href="assets/bettermood_logo-10.png" />
<style>
/* BMC: Reset & base */
*{box-sizing:border-box}html,body{height:100%}body{margin:0;min-height:100%;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;position:relative;overflow-x:hidden}
body::before{content:'';position:fixed;inset:-20%;z-index:-2;background:
  radial-gradient(58% 58% at 18% 18%,rgba(56,189,248,0.22),transparent 60%),
  radial-gradient(50% 50% at 82% -10%,rgba(129,140,248,0.18),transparent 65%),
  linear-gradient(160deg,rgba(4,6,14,0.95),rgba(2,3,8,0.96));
pointer-events:none;}
body::after{content:'';position:fixed;inset:0;z-index:-1;background:radial-gradient(120% 140% at 50% 0%,rgba(255,255,255,0.04),transparent 65%);pointer-events:none;}
body.light-mode::before{background:
  radial-gradient(62% 62% at 14% 18%,rgba(56,189,248,0.18),transparent 62%),
  radial-gradient(48% 48% at 82% -6%,rgba(139,92,246,0.18),transparent 66%),
  linear-gradient(150deg,rgba(250,252,255,0.92),rgba(232,236,245,0.94));}
body.light-mode::after{background:radial-gradient(120% 140% at 50% 0%,rgba(15,23,42,0.06),transparent 68%);}
:root{
  /* BMC: Branding variables */
  --bg:#05060c; --panel:rgba(24,28,44,0.7); --muted:#9CA3AF; --text:#F4F6FB;
  --brand:#FFD74B; --brand-2:#231F20; --warn:#FFD74B; --danger:#F87171;
  --ok:#22D3EE; --card:rgba(26,32,52,0.58); --border:rgba(148,163,184,0.22);
  --glow:0 26px 64px rgba(8,12,24,0.45);
}
body.light-mode{
  --bg:#eef2f9; --panel:rgba(255,255,255,0.82); --muted:#4B5563; --text:#0f172a;
  --brand:#111827; --brand-2:#E5E7EB; --warn:#F97316; --danger:#DC2626;
  --ok:#0EA5E9; --card:rgba(255,255,255,0.9); --border:rgba(148,163,184,0.28);
  --glow:0 24px 58px rgba(15,23,42,0.14);
}
.hidden{display:none!important}
body.auth-locked header,body.auth-locked main,body.auth-locked footer{filter:blur(6px);pointer-events:none;user-select:none}
.auth-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:24px;background:rgba(4,6,14,0.8);backdrop-filter:blur(14px);z-index:9999}
.auth-card{width:min(380px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:22px 22px 18px;box-shadow:var(--glow)}
.auth-card h2{margin:0 0 6px 0;font-size:18px;letter-spacing:0.3px}
.auth-card p{margin:0 0 12px 0}
.auth-card label{display:block;margin-bottom:10px;font-size:12px;color:var(--muted)}
.auth-card input{margin-top:4px}
.auth-actions{display:flex;align-items:center;gap:8px;margin-top:8px}
.auth-actions .muted{font-size:12px}
.auth-error{min-height:16px;font-size:12px;color:var(--danger)}
body.light-mode .auth-overlay{background:rgba(235,238,246,0.82)}
body.light-mode .auth-card{background:rgba(255,255,255,0.92)}
.muted{color:var(--muted)}
.container{max-width:min(1500px,96vw);margin:0 auto;padding:20px}
body.light-mode .container{padding:24px}
header{background:linear-gradient(0deg,var(--panel),var(--panel));border-bottom:1px solid var(--border)}
header .wrap{display:flex;align-items:center;gap:18px;padding:20px 24px;background:rgba(255,255,255,0.02);backdrop-filter:blur(26px);border-radius:24px;margin-top:18px;box-shadow:var(--glow)}
header img{width:60px;height:60px;border-radius:20px;object-fit:cover;background:linear-gradient(135deg,rgba(255,215,75,0.25),rgba(255,215,75,0.05));border:2px solid rgba(255,215,75,0.8);box-shadow:0 12px 32px rgba(255,215,75,0.12);padding:8px}
header h1{font-size:18px;margin:0;color:var(--brand);letter-spacing:0.4px}
body.light-mode header h1{color:#111827}
body.light-mode header{background:linear-gradient(0deg,#f9fafb,#ffffff)}
body.light-mode header img{background:linear-gradient(135deg,rgba(255,215,75,0.3),rgba(255,215,75,0.08));box-shadow:0 8px 18px rgba(17,24,39,0.12)}
nav{display:flex;flex-wrap:wrap;gap:8px;padding:8px 16px;border-bottom:1px solid var(--border);background:var(--panel);position:sticky;top:0;z-index:10}
body.light-mode nav{background:rgba(255,255,255,0.82);backdrop-filter:blur(20px)}
nav button{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 18px;border-radius:999px;cursor:pointer;transition:transform .18s ease, box-shadow .24s ease}
nav button:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(17,24,39,0.24)}
nav button.active{background:var(--brand);color:#111111;border-color:rgba(255,215,75,0.9);box-shadow:0 18px 42px rgba(255,215,75,0.35)}
body.light-mode nav button{background:#ffffff;border-color:#d1d5db;color:#111827}
body.light-mode nav button.active{color:#ffffff;background:#111827;border-color:#111827}
main{padding:24px 16px}
section.panel{background:linear-gradient(140deg,rgba(28,34,58,0.82),rgba(12,16,28,0.72));border:1px solid rgba(255,255,255,0.08);border-radius:24px;padding:24px;margin-bottom:24px;backdrop-filter:blur(28px);box-shadow:0 24px 64px rgba(6,10,22,0.45)}
.panel h2{margin:0 0 16px 0;font-size:20px;letter-spacing:0.6px;color:var(--text)}
body.light-mode section.panel{background:linear-gradient(140deg,rgba(255,255,255,0.9),rgba(241,244,250,0.94));border:1px solid rgba(148,163,184,0.24);box-shadow:0 20px 46px rgba(15,23,42,0.18)}
.card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.card{background:linear-gradient(160deg,rgba(255,255,255,0.08),rgba(18,23,36,0.52));border:1px solid rgba(255,255,255,0.08);border-radius:20px;padding:18px;overflow:hidden;backdrop-filter:blur(24px);box-shadow:var(--glow)}
body.light-mode .card{background:linear-gradient(160deg,rgba(255,255,255,0.92),rgba(241,245,249,0.92));border:1px solid rgba(148,163,184,0.22);box-shadow:0 18px 40px rgba(15,23,42,0.16)}
.card h3{margin:0 0 6px 0;font-size:13px;color:var(--muted);font-weight:600}
.card .big{font-size:22px;font-weight:700}
.card canvas{display:block;width:100%;height:320px;cursor:zoom-in;transition:transform .2s ease}
.card canvas:hover{transform:scale(1.01)}
.collapsible-card .collapsible-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.collapsible-card .btn-compact{padding:4px 10px;font-size:12px;border-radius:999px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.12);color:#f8fafc}
.collapsible-card .btn-compact:hover{background:rgba(255,255,255,0.12)}
body.light-mode .collapsible-card .btn-compact{background:rgba(17,24,39,0.06);border:1px solid rgba(148,163,184,0.24);color:#0f172a}
.collapsible-card .collapsible-body{max-height:620px;overflow:auto;transition:max-height .28s ease, opacity .24s ease, margin .24s ease;opacity:1;margin-top:4px}
.collapsible-card .collapsible-body.collapsed{max-height:0;opacity:0;margin-top:0;overflow:hidden}
.collapsible-card .collapsible-body.collapsed table{pointer-events:none}
.card-title-flex{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.title-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:999px;font-size:11px;text-transform:uppercase;letter-spacing:0.6px;background:rgba(255,255,255,0.08);color:#f8fafc;border:1px solid rgba(255,255,255,0.12);backdrop-filter:blur(12px)}
body.light-mode .title-chip{background:rgba(17,24,39,0.08);color:#0f172a;border:1px solid rgba(148,163,184,0.3)}
.sales-weekday-card{display:flex;flex-direction:column;gap:18px;padding:22px}
.sales-weekday-head{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap}
.sales-weekday-head h3{margin-bottom:4px;font-size:16px;color:#f8fafc}
.sales-weekday-head .muted{font-size:12px}
.sales-weekday-pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.sales-weekday-pill{padding:6px 12px;border-radius:999px;background:rgba(255,255,255,0.08);color:#f8fafc;font-size:12px;border:1px solid rgba(255,255,255,0.14);backdrop-filter:blur(10px)}
.sales-weekday-pill strong{display:block;font-size:13px}
.sales-weekday-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;align-items:center}
#ventas-weekday-summary{display:grid;gap:10px}
#ventas-weekday-summary .summary-card{padding:12px;border-radius:14px;background:rgba(15,23,42,0.32);border:1px solid rgba(255,255,255,0.08);backdrop-filter:blur(12px);box-shadow:0 10px 28px rgba(8,14,24,0.28)}
#ventas-weekday-summary .summary-card strong{display:block;font-size:18px;color:#f8fafc}
#ventas-weekday-summary .summary-card small{display:block;font-size:11px;color:rgba(226,232,240,0.7);letter-spacing:0.6px;text-transform:uppercase}
#ventas-weekday-summary .summary-card span{display:block;font-size:12px;color:rgba(226,232,240,0.8);margin-top:6px}
#chart-ventas-weekday{height:280px}
#chart-ventas-weektrend{height:320px;margin-top:12px}
#chart-platform-weekly{height:280px}
#chart-weekly-metodos{height:300px}
.platform-weekly-legend{display:flex;gap:12px;align-items:center;margin:10px 0 6px;font-size:12px;color:var(--muted);flex-wrap:wrap}
.platform-weekly-legend .legend-item{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12)}
.platform-weekly-legend .legend-item .dot{width:10px;height:10px;border-radius:50%}
.platform-weekly-legend .legend-item.rappi .dot{background:var(--rappi-color,#EF4444)}
.platform-weekly-legend .legend-item.uber .dot{background:var(--uber-color,#F59E0B)}
.platform-weekly-legend .legend-item.total .dot{background:#FFD74B}
.platform-weekly-legend .legend-item.efectivo .dot{background:var(--efectivo-color,#10B981)}
.platform-weekly-legend .legend-item.tarjeta .dot{background:var(--tarjeta-color,#3B82F6)}
body.light-mode .platform-weekly-legend .legend-item{background:rgba(15,23,42,0.06);border-color:rgba(148,163,184,0.18);color:#475569}
.weekly-methods-insights{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;font-size:12px}
.insight-chip{padding:4px 10px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,0.04);color:var(--text)}
.insight-chip.up{border-color:#22C55E;color:#22C55E}
.insight-chip.down{border-color:#F87171;color:#F87171}
.insight-chip.flat{border-color:var(--border);color:var(--muted)}
body.light-mode .insight-chip{background:rgba(15,23,42,0.02)}
body.light-mode .sales-weekday-card h3{color:#0f172a}
body.light-mode .sales-weekday-card .muted{color:#475569}
body.light-mode .sales-weekday-card .sales-weekday-pill{background:rgba(17,24,39,0.08);color:#0f172a;border-color:rgba(148,163,184,0.28)}
body.light-mode .sales-weekday-card #ventas-weekday-summary .summary-card{background:rgba(248,250,252,0.92);border-color:rgba(148,163,184,0.24);box-shadow:0 14px 30px rgba(15,23,42,0.18)}
body.light-mode .sales-weekday-card #ventas-weekday-summary .summary-card strong{color:#0f172a}
body.light-mode .sales-weekday-card #ventas-weekday-summary .summary-card small{color:#64748b}
body.light-mode .sales-weekday-card #ventas-weekday-summary .summary-card span{color:#334155}
.ledger-card{padding:0;border-radius:20px;background:transparent;border:none;position:relative;overflow:hidden}
.ledger-card .ledger-inner{position:relative;padding:20px;border-radius:20px;background:linear-gradient(160deg,rgba(255,255,255,0.08),rgba(15,23,42,0.24));border:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(18px);box-shadow:0 24px 60px rgba(9,9,15,0.35);transition:transform .25s ease, box-shadow .25s ease;border-bottom:1px solid rgba(255,255,255,0.08)}
.ledger-card:hover .ledger-inner{transform:translateY(-6px);box-shadow:0 28px 70px rgba(9,9,15,0.45)}
.ledger-card .ledger-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:16px}
.ledger-card .ledger-header h3{font-size:15px;letter-spacing:0.2px;color:#fff;margin-bottom:4px}
.ledger-card .ledger-range{display:block;font-size:11px;color:rgba(255,255,255,0.68);text-transform:uppercase;letter-spacing:1px}
.ledger-card .ledger-header-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.ledger-card .ledger-balance{padding:6px 12px;border-radius:999px;background:rgba(255,255,255,0.08);font-size:12px;font-weight:600;color:#fff;box-shadow:inset 0 1px 0 rgba(255,255,255,0.18)}
.ledger-card .ledger-body{position:relative;border-radius:14px;background:rgba(15,23,42,0.4);border:1px solid rgba(255,255,255,0.06);overflow:hidden}
.ledger-card .ledger-scroll{max-height:220px;overflow:auto;scrollbar-width:thin;padding:6px 0}
.ledger-card .ledger-scroll::-webkit-scrollbar{width:6px}
.ledger-card .ledger-scroll::-webkit-scrollbar-thumb{background:rgba(148,163,184,0.35);border-radius:999px}
.card .table-scroll{max-height:260px;overflow:auto;scrollbar-width:thin;margin-top:8px;padding-right:6px}
.card .table-scroll::-webkit-scrollbar{width:6px;height:6px}
.card .table-scroll::-webkit-scrollbar-thumb{background:rgba(148,163,184,0.35);border-radius:999px}
body.light-mode .card .table-scroll::-webkit-scrollbar-thumb{background:rgba(30,41,59,0.28)}
.ledger-card table{margin:0;font-size:12px}
.ledger-card table th{background:rgba(255,255,255,0.05);color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:0.6px}
.ledger-card table td{color:rgba(226,232,240,0.96)}
.ledger-card .btn.ledger-expand{font-size:12px;padding:6px 12px;border-color:rgba(255,255,255,0.18);color:#fff;background:rgba(255,255,255,0.06);backdrop-filter:blur(14px)}
.ledger-card .btn.ledger-expand:hover{background:rgba(255,255,255,0.12);border-color:rgba(255,255,255,0.22)}
body.light-mode .ledger-card .ledger-inner{background:linear-gradient(160deg,rgba(255,255,255,0.85),rgba(229,231,235,0.92));border:1px solid rgba(148,163,184,0.25);box-shadow:0 20px 40px rgba(15,23,42,0.18)}
body.light-mode .ledger-card:hover .ledger-inner{box-shadow:0 26px 60px rgba(15,23,42,0.24)}
body.light-mode .ledger-card .ledger-header h3{color:#0f172a}
body.light-mode .ledger-card .ledger-range{color:#5b6474}
body.light-mode .ledger-card .ledger-balance{background:rgba(17,24,39,0.06);color:#0f172a;box-shadow:none;border:1px solid rgba(148,163,184,0.3)}
body.light-mode .ledger-card .ledger-body{background:rgba(248,250,252,0.94);border:1px solid rgba(148,163,184,0.24)}
body.light-mode .ledger-card table th{background:rgba(226,232,240,0.65);color:#475569}
body.light-mode .ledger-card table td{color:#0f172a}
body.light-mode .ledger-card .btn.ledger-expand{color:#0f172a;background:rgba(15,23,42,0.06);border-color:rgba(148,163,184,0.3)}
body.light-mode .ledger-card .btn.ledger-expand:hover{background:rgba(15,23,42,0.12)}
.chart-grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:16px}
.chart-grid-2.wide{grid-template-columns:repeat(auto-fit,minmax(360px,1fr))}
.chart-grid-2.tight{grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
.table th{color:var(--muted);font-weight:600}
.table tr:hover{background:rgba(255,255,255,0.04)}
body.light-mode .table tr:hover{background:rgba(17,24,39,0.05)}
#ledger-summary-card table{margin-top:6px}
#ledger-summary-card td:first-child{color:var(--muted)}
#ledger-summary-card td:last-child{text-align:right;font-weight:600}
.led-anticipo td{background:rgba(239,68,68,0.08)}
.led-nomina td{background:rgba(16,185,129,0.08)}
.led-compra td{background:rgba(59,130,246,0.06)}
.led-deposito td{background:rgba(245,158,11,0.08)}
.row{display:flex;gap:8px;flex-wrap:wrap}
.row>.grow{flex:1}
input,select,textarea{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text)}
body.light-mode input,body.light-mode select,body.light-mode textarea{background:#fff}
label{font-size:12px;color:var(--muted)}
.btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
.btn.primary{background:var(--brand);color:#111111;border-color:var(--brand)}
.btn.warn{background:var(--warn);color:#111}
.btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
.btn.ghost{background:transparent}
.btn-group{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.btn-group .btn{white-space:nowrap}
#dash-quick .btn.active,
#gastos-quick .btn.active,
.btn-group .btn.active{background:var(--brand);color:#111111;border-color:var(--brand)}
body.light-mode #dash-quick .btn.active,
body.light-mode #gastos-quick .btn.active,
body.light-mode .btn-group .btn.active{background:#111827;color:#ffffff;border-color:#111827}
#panel-sobres .sobres-summary{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
#panel-sobres .sobres-summary strong{font-size:18px;color:var(--text)}
#panel-sobres .table input[type="number"]{min-width:120px}
#panel-sobres .table td{vertical-align:middle}
#panel-sobres .table td.checkbox-cell{text-align:center;width:110px}
#panel-sobres .table td.actions-cell{text-align:right}
#dash-quick .btn{padding:6px 10px;font-size:12px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px 0}
.dashboard-meta{display:flex;flex-wrap:wrap;gap:12px;margin:8px 0 16px 0;color:var(--muted);font-size:12px}
.dashboard-meta span{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,0.04);padding:6px 12px;border-radius:999px;border:1px solid var(--border)}
body.light-mode .dashboard-meta span{background:rgba(17,24,39,0.05)}
footer{color:var(--muted);border-top:1px solid var(--border);padding:12px 16px;text-align:center;background:var(--panel)}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
.badge.ok{color:#10B981;border-color:rgba(16,185,129,0.4)}
.badge.warn{color:#F59E0B;border-color:rgba(245,158,11,0.4)}
.badge.err{color:#F87171;border-color:rgba(248,113,113,0.4)}
.kpi{display:flex;align-items:flex-end;justify-content:space-between}
.kpi small{color:var(--muted)}
.kpi strong{font-size:22px}
hr.sep{border:none;border-top:1px solid var(--border);margin:12px 0}
.idea-list{list-style:disc;margin:0;padding-left:18px;color:var(--muted)}
.idea-list li{margin-bottom:6px;color:var(--text);font-size:13px}
details.panel-block{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin-bottom:16px;box-shadow:0 6px 16px rgba(0,0,0,0.12)}
body.light-mode details.panel-block{box-shadow:0 8px 20px rgba(15,23,42,0.06)}
details.panel-block summary{cursor:pointer;font-weight:600;color:var(--text);display:flex;align-items:center;justify-content:space-between;gap:12px;list-style:none;padding:2px 0}
details.panel-block summary::-webkit-details-marker{display:none}
details.panel-block summary::after{content:'▾';font-size:14px;transition:transform .2s ease}
details.panel-block[open] > summary{border-bottom:1px solid var(--border);margin-bottom:12px;padding-bottom:8px}
.calendar-toolbar{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
.calendar-toolbar strong{flex:1;text-align:center;text-transform:capitalize;font-size:14px}
.calendar-nav{display:flex;align-items:center;gap:8px}
.calendar-filter{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
.calendar-filter select{min-width:140px}
.calendar-wrapper{overflow:auto}
.calendar-grid{display:grid;grid-template-columns:repeat(7,minmax(120px,1fr));gap:6px}
.calendar-head{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;padding:4px 6px}
.calendar-legend{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 4px;font-size:11px;color:var(--muted)}
.calendar-legend .legend{display:flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,0.04)}
.calendar-legend .legend::before{content:'';width:10px;height:10px;border-radius:4px;background:var(--border)}
.calendar-legend .legend.marketing::before{background:#8B5CF6}
.calendar-legend .legend.oficial::before{background:#F97316}
.calendar-legend .legend.agenda::before{background:#38BDF8}
.calendar-legend .legend.nota::before{background:#94A3B8}
.calendar-day{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px;min-height:92px;display:flex;flex-direction:column;gap:4px;cursor:pointer;transition:transform .1s ease, border-color .2s}
.calendar-day.empty{background:transparent;border-style:dashed;cursor:default;pointer-events:none;opacity:0.35}
.calendar-day:hover{transform:translateY(-2px);border-color:var(--brand)}
.calendar-day.today{outline:2px solid var(--brand)}
.calendar-day .date{font-weight:600;font-size:12px;color:var(--muted)}
.calendar-day .events{font-size:11px;color:var(--text);line-height:1.35;overflow:hidden}
.calendar-day .event-tag{display:block;margin-bottom:2px;padding:2px 4px;border-radius:6px;background:rgba(255,255,255,0.04)}
.calendar-day .event-tag.marketing{background:rgba(129,76,241,0.26);color:#E0D7FF;font-weight:600}
.calendar-day .event-tag.oficial{background:rgba(249,115,22,0.18);color:#FED7AA;font-weight:600}
.calendar-day .event-tag.agenda{background:rgba(56,189,248,0.18);color:#BAE6FD}
.calendar-day .event-tag.nota{background:rgba(148,163,184,0.16);color:#E2E8F0}
.calendar-day .event-tag.muted{background:transparent;color:var(--muted);font-style:italic}
.calendar-day.official{background:rgba(249,115,22,0.08);border-color:#f97316}
.calendar-day.marketing{background:rgba(129,76,241,0.16);border-color:#7C3AED}
.calendar-day.agenda{background:rgba(56,189,248,0.1);border-color:#38BDF8}
.calendar-day.filtered-out{opacity:0.6}
body.light-mode .calendar-day{background:#fff}
body.light-mode .calendar-day .event-tag{background:rgba(15,23,42,0.04);color:inherit}
body.light-mode .calendar-day .event-tag.marketing{background:rgba(129,76,241,0.18);color:#4C1D95}
body.light-mode .calendar-day .event-tag.oficial{background:rgba(249,115,22,0.2);color:#9A3412}
body.light-mode .calendar-day .event-tag.agenda{background:rgba(56,189,248,0.22);color:#0C4A6E}
body.light-mode .calendar-day .event-tag.nota{background:rgba(148,163,184,0.22);color:#1F2937}
.ledger-modal{position:fixed;inset:0;z-index:9998;display:flex;align-items:center;justify-content:center;padding:24px;background:rgba(9,9,15,0.65);backdrop-filter:blur(14px);transition:opacity .2s ease;opacity:0;pointer-events:none}
.ledger-modal.open{opacity:1;pointer-events:auto}
.ledger-modal .ledger-modal-dialog{position:relative;width:min(1200px,92vw);max-height:90vh;border-radius:28px;padding:28px;background:linear-gradient(150deg,rgba(255,255,255,0.09),rgba(15,23,42,0.75));border:1px solid rgba(255,255,255,0.12);box-shadow:0 40px 120px rgba(0,0,0,0.45);backdrop-filter:blur(18px);display:flex;flex-direction:column;gap:18px;overflow:hidden}
.ledger-modal .ledger-modal-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
.ledger-modal .ledger-modal-header h3{margin:0;font-size:18px;color:#fff}
.ledger-modal .ledger-modal-meta{font-size:12px;color:rgba(226,232,240,0.8)}
.ledger-modal .ledger-modal-table{flex:1;min-height:0;overflow:auto;border-radius:16px;border:1px solid rgba(255,255,255,0.08);background:rgba(9,9,15,0.55);padding:12px}
.ledger-modal .ledger-modal-table table{width:100%;border-collapse:collapse;font-size:13px}
.ledger-modal .ledger-modal-close{border:none;background:rgba(255,255,255,0.08);color:#fff;padding:6px 10px;border-radius:999px;cursor:pointer;font-size:12px;transition:background .2s ease}
.ledger-modal .ledger-modal-close:hover{background:rgba(255,255,255,0.18)}
body.light-mode .ledger-modal{background:rgba(15,23,42,0.45)}
body.light-mode .ledger-modal .ledger-modal-dialog{background:linear-gradient(150deg,rgba(255,255,255,0.9),rgba(229,231,235,0.95));border:1px solid rgba(148,163,184,0.25)}
body.light-mode .ledger-modal .ledger-modal-header h3{color:#0f172a}
body.light-mode .ledger-modal .ledger-modal-meta{color:#475569}
body.light-mode .ledger-modal .ledger-modal-table{background:rgba(241,245,249,0.8);border:1px solid rgba(148,163,184,0.24)}
body.light-mode .ledger-modal .ledger-modal-close{background:rgba(15,23,42,0.08);color:#0f172a}
body.light-mode .ledger-modal .ledger-modal-close:hover{background:rgba(15,23,42,0.14)}
body.light-mode .calendar-day .event-tag.muted{color:#6B7280}
body.light-mode .calendar-legend .legend{background:rgba(15,23,42,0.06);color:#4B5563}
@media (max-width:1200px){
  .calendar-grid{grid-template-columns:repeat(7,minmax(90px,1fr))}
}
@media (max-width:900px){
  .calendar-grid{grid-template-columns:repeat(7,minmax(70px,1fr))}
}
.chart-modal{position:fixed;inset:0;background:rgba(0,0,0,0.78);display:none;align-items:center;justify-content:center;z-index:9999;padding:24px}
.chart-modal.active{display:flex}
.chart-modal .modal-content{background:var(--panel);border:1px solid var(--brand);border-radius:18px;max-width:92vw;max-height:92vh;padding:20px;display:flex;flex-direction:column;gap:18px;box-shadow:0 18px 48px rgba(0,0,0,0.45)}
.chart-modal header{display:flex;align-items:center;gap:12px;justify-content:space-between;background:transparent;border:none;padding:0}
.chart-modal header h3{margin:0;font-size:18px;color:var(--text)}
.chart-modal .meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
.chart-modal .meta div{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:12px;color:var(--muted)}
.chart-modal .meta strong{display:block;color:var(--text);font-size:14px}
.chart-modal canvas{width:100%;height:480px;cursor:default}
.chart-modal .close-btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer}
.chart-modal .close-btn:hover{background:var(--brand);color:#111}
/* BMC: Toaster */
#toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:9999}
.toast{background:var(--panel);border:1px solid var(--border);padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.2);color:var(--text)}
.toast.success{border-color:var(--ok)}
.toast.error{border-color:var(--danger)}
#panel-dashboard .card{background:linear-gradient(180deg,#161616,#101010);box-shadow:0 12px 28px rgba(0,0,0,0.28);border-color:#1f1f1f}
#panel-dashboard .card h3{color:#F9FAFB}
#panel-dashboard canvas{background:rgba(255,255,255,0.02);border-radius:10px;padding:8px}
#panel-dashboard .chart-grid-2{gap:16px}
body.light-mode #panel-dashboard .card{background:linear-gradient(180deg,#ffffff,#f3f4f6);box-shadow:0 12px 28px rgba(15,23,42,0.12);border-color:#e5e7eb}
body.light-mode #panel-dashboard .card h3{color:#1f2937}
body.light-mode #panel-dashboard canvas{background:#FFFFFF;border:1px solid #e5e7eb}
/* BMC: Chart tooltip */
.chart-tooltip{position:fixed;pointer-events:none;background:var(--panel);border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:6px;font-size:12px;box-shadow:0 8px 24px rgba(0,0,0,.25);z-index:9999}
.chart-tooltip.hidden{display:none}
/* BMC: Print */
@media print{nav,header,footer,#toast,.toolbar .btn{display:none!important}body{background:#fff;color:#000}.panel{border:none}.card{border:1px solid #ddd}}
</style>
</head>
<body class="auth-locked">
<div id="auth-overlay" class="auth-overlay" role="dialog" aria-modal="true" aria-labelledby="auth-title">
  <div class="auth-card">
    <h2 id="auth-title">Iniciar sesion</h2>
    <p class="muted">Acceso restringido</p>
    <label>Usuario<input type="text" id="auth-user" autocomplete="username" spellcheck="false"></label>
    <label>Contrasena<input type="password" id="auth-pass" autocomplete="current-password"></label>
    <div class="auth-error" id="auth-error"></div>
    <div class="auth-actions">
      <button class="btn primary" id="auth-login-btn" type="button">Entrar</button>
      <span class="muted" id="auth-status"></span>
    </div>
  </div>
</div>
<header>
  <div class="wrap container">
    <img id="app-logo" alt="logo" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'72\' height=\'72\'><rect width=\'100%\' height=\'100%\' fill=\'%23231F20\'/><circle cx=\'36\' cy=\'36\' r=\'22\' fill=\'%23FFD74B\'/></svg>'" src="assets/bettermood_logo-10.png"/>
    <h1>Better Mood Coffee · Control de Cafetería</h1>
    <div class="grow"></div>
    <span class="badge" id="mode-badge">Modo: local</span>
    <span class="badge" id="sync-badge">Sync: local</span>
    <button class="btn ghost" id="theme-toggle" onclick="toggleTheme()">Modo noche</button>
    <button class="btn ghost hidden" id="logout-btn" type="button" onclick="Auth.logout()">Cerrar sesion</button>
  </div>
  <nav class="container" id="top-nav"></nav>
</header>
<main class="container">
  <!-- BMC: Panels -->
  <section id="panel-dashboard" class="panel"><h2>Dashboard</h2>
    <div class="toolbar">
      <label>Desde<input type="date" id="dash-desde"></label>
      <label>Hasta<input type="date" id="dash-hasta"></label>
      <label>Agrupar<select id="dash-group"><option value="dia">Día</option><option value="semana">Semana</option><option value="mes" selected>Mes</option></select></label>
      <label>Canal<select id="dash-origen"><option value="todos">Todos</option><option value="local">Punto de venta</option><option value="plataformas">Plataformas</option><option value="Efectivo">Efectivo</option><option value="Tarjeta">Tarjeta</option><option value="Uber">Uber</option><option value="Rappi">Rappi</option></select></label>
      <div class="btn-group" id="dash-quick">
        <button class="btn ghost" data-preset="mes" onclick="setDashboardRange('mes')">Este mes</button>
        <button class="btn ghost" data-preset="mesPasado" onclick="setDashboardRange('mesPasado')">Mes pasado</button>
        <button class="btn ghost" data-preset="30" onclick="setDashboardRange('30')">Últimos 30d</button>
        <button class="btn ghost" data-preset="7" onclick="setDashboardRange('7')">Últimos 7d</button>
      </div>
      <button class="btn" onclick="renderDashboard()">Aplicar</button>
      <div class="grow"></div>
      <button class="btn" onclick="seedEjemplo()">Cargar datos de ejemplo</button>
      <button class="btn" onclick="exportCSV.dashboard()">Exportar CSV</button>
    </div>
    <div class="dashboard-meta" id="dash-meta"></div>
    <div class="card-grid" id="kpi-grid"></div>
    <div class="card">
      <h3>Ventas por método (periodo)</h3>
      <table class="table" id="tbl-ventas-metodo"><thead><tr><th>Método</th><th>Ventas</th><th>Ingreso neto</th><th>Participación</th></tr></thead><tbody></tbody></table>
    </div>
    <details class="panel-block" id="dash-ledger-block" open>
      <summary>Estado de cuenta &amp; depósitos</summary>
      <div class="toolbar" id="ledger-controls">
        <label>Desde<input type="date" id="ld-desde"></label>
        <label>Hasta<input type="date" id="ld-hasta"></label>
        <button class="btn" onclick="renderLedgers()">Aplicar</button>
        <div class="grow"></div>
        <label>Saldo inicial caja<input type="number" id="ld-saldo-efec" step="0.01"></label>
        <label>Saldo inicial banco<input type="number" id="ld-saldo-banco" step="0.01"></label>
        <button class="btn" onclick="saveLedgerSaldos()">Guardar saldos</button>
      </div>
      <div class="card-grid">
        <div class="card" id="ledger-summary-card">
          <h3>Resumen de ingresos</h3>
          <div class="ledger-summary-body muted">Selecciona un rango para ver el resumen.</div>
        </div>
        <div class="card ledger-card" data-ledger="efectivo">
          <div class="ledger-inner">
            <div class="ledger-header">
              <div>
                <h3>Estado de cuenta — Efectivo</h3>
                <span class="ledger-range" id="ld-efec-range">Rango sin definir</span>
              </div>
              <div class="ledger-header-actions">
                <span class="ledger-balance" id="ld-efec-badge">Saldo: $0.00</span>
                <button class="btn ghost ledger-expand" data-ledger="efectivo">Ver completo</button>
              </div>
            </div>
            <div class="ledger-body">
              <div class="ledger-scroll">
                <table class="table" id="tbl-ledger-efec"><thead><tr><th>Fecha</th><th>Concepto</th><th>Entrada</th><th>Salida</th><th>Saldo</th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </div>
        </div>
        <div class="card ledger-card" data-ledger="banco">
          <div class="ledger-inner">
            <div class="ledger-header">
              <div>
                <h3>Estado de cuenta — Banco</h3>
                <span class="ledger-range" id="ld-banco-range">Rango sin definir</span>
              </div>
              <div class="ledger-header-actions">
                <span class="ledger-balance" id="ld-banco-badge">Saldo: $0.00</span>
                <button class="btn ghost ledger-expand" data-ledger="banco">Ver completo</button>
              </div>
            </div>
            <div class="ledger-body">
              <div class="ledger-scroll">
                <table class="table" id="tbl-ledger-banco"><thead><tr><th>Fecha</th><th>Concepto</th><th>Entrada</th><th>Salida</th><th>Saldo</th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </div>
        </div>
        <div class="card card-depos">
          <h3>Calendario de depósitos</h3>
          <div class="toolbar">
            <label>Ver<select id="dep-scope"><option value="proximos" selected>Próximos</option><option value="pasados">Pasados</option><option value="todos">Todos</option></select></label>
            <div class="grow"></div>
            <small class="muted">Calculado con el rango del dashboard</small>
          </div>
          <div class="table-scroll">
            <table class="table" id="tbl-depositos"><thead><tr><th>Fecha</th><th>Plataforma</th><th>Monto</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </details>
    <details class="panel-block" id="dash-trends-block">
      <summary>Gráficas de tendencia y análisis</summary>
      <div class="chart-grid-2 tight">
        <div class="card">
          <h3>Total de ventas (diario)</h3>
          <canvas id="chart-total"></canvas>
        </div>
        <div class="card">
          <h3>Efectivo (diario)</h3>
          <canvas id="chart-efectivo"></canvas>
        </div>
        <div class="card">
          <h3>Tarjeta (diario)</h3>
          <canvas id="chart-tarjeta"></canvas>
        </div>
        <div class="card">
          <h3>Uber (diario)</h3>
          <canvas id="chart-uber"></canvas>
        </div>
        <div class="card">
          <h3>Rappi (diario)</h3>
          <canvas id="chart-rappi"></canvas>
        </div>
        <div class="card">
          <h3>Pagos semanales plataformas</h3>
          <small class="muted" id="platform-weekly-meta">Analiza Uber y Rappi semana a semana.</small>
          <div class="platform-weekly-legend">
            <span class="legend-item rappi"><span class="dot"></span>Rappi</span>
            <span class="legend-item uber"><span class="dot"></span>Uber</span>
            <span class="legend-item total"><span class="dot" style="background:#FFD74B"></span>Total combinado</span>
          </div>
          <canvas id="chart-platform-weekly"></canvas>
        </div>
        <div class="card">
          <h3>Ventas semanales por método</h3>
          <small class="muted" id="weekly-methods-meta">Obtén la lectura semanal total e identifica qué método impulsa o frena el crecimiento.</small>
          <div class="platform-weekly-legend weekly-methods-legend">
            <span class="legend-item efectivo"><span class="dot"></span>Efectivo</span>
            <span class="legend-item tarjeta"><span class="dot"></span>Tarjeta</span>
            <span class="legend-item uber"><span class="dot"></span>Uber</span>
            <span class="legend-item rappi"><span class="dot"></span>Rappi</span>
            <span class="legend-item total"><span class="dot" style="background:#FFD74B"></span>Total semanal</span>
          </div>
          <canvas id="chart-weekly-metodos"></canvas>
          <div class="weekly-methods-insights" id="weekly-methods-insights"></div>
        </div>
        <div class="card">
          <h3>Propinas (diario)</h3>
          <canvas id="chart-propinas"></canvas>
        </div>
        <div class="card">
          <h3>Ventas por método (apilado)</h3>
          <canvas id="chart-metodos-stacked"></canvas>
        </div>
        <div class="card">
          <h3>Costos y gastos (apilado)</h3>
          <canvas id="chart-costos-gastos"></canvas>
        </div>
        <div class="card">
          <h3>Utilidad neta por periodo</h3>
          <canvas id="chart-utilidad"></canvas>
        </div>
        <div class="card">
          <h3>KPIs del periodo</h3>
          <table class="table" id="tbl-kpis-periodo"><thead><tr><th>Métrica</th><th>Valor</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="card">
          <h3>Resumen por periodo</h3>
          <table class="table" id="tbl-resumen"><thead><tr><th>Periodo</th><th>Ventas</th><th>Comisión</th><th>Ingreso neto</th><th>Costos</th><th>Gastos</th><th>Utilidad</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </details>
    <div class="card" id="dash-calendar-card">
      <h3>Calendario estratégico</h3>
      <div class="calendar-toolbar">
        <div class="calendar-nav">
          <button class="btn ghost" onclick="marketingCalendar.prev()">◀</button>
          <button class="btn ghost" onclick="marketingCalendar.today()">Hoy</button>
          <button class="btn ghost" onclick="marketingCalendar.next()">▶</button>
        </div>
        <strong id="calendar-label">-</strong>
        <label class="calendar-filter">Ver
          <select id="calendar-filter" onchange="marketingCalendar.setFilter(this.value)">
            <option value="todos">Todos</option>
            <option value="marketing">Marketing</option>
            <option value="oficial">Oficiales</option>
            <option value="agenda">Agenda</option>
            <option value="nota">Notas</option>
          </select>
        </label>
      </div>
      <div class="calendar-wrapper"><div class="calendar-grid" id="calendar-grid"></div></div>
      <div class="calendar-legend">
        <span class="legend marketing">Marketing</span>
        <span class="legend oficial">Oficial</span>
        <span class="legend agenda">Agenda</span>
        <span class="legend nota">Notas</span>
      </div>
      <small class="muted">Haz clic en un día para añadir o editar comentarios. Los eventos oficiales y de marketing se resaltan automáticamente.</small>
    </div>
    <div class="card" id="dashboard-action-card"></div>
    <div class="card" id="marketing-autopilot-card"></div>
    <div class="card" id="growth-insights-card"></div>
  </section>

  <section id="panel-nomina" class="panel hidden"><h2>Generador de Nómina</h2>
    <div class="toolbar">
      <label class="grow">Colaborador<select id="nom-emp"></select></label>
      <label>Semana inicia<input type="date" id="nom-week"></label>
      <label>Fecha de pago<input type="date" id="nom-pago" data-autofill="1"></label>
      <label>Método<select id="nom-met"><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></label>
      <label>Pagado por<input id="nom-pay" placeholder=""></label>
      <span class="badge" id="nom-folio-badge">Folio: -</span>
      <button class="btn" onclick="nominaGen.preloadHorario()">Precargar horario</button>
    </div>
    <div class="card">
      <h3>Jornadas (Lun–Dom)</h3>
      <table class="table" id="tbl-nomina"><thead><tr><th>Día</th><th>Fecha</th><th>Entrada</th><th>Salida</th><th>Horas</th><th>Comisión</th><th>Bono</th><th>Deducción</th><th>Anticipo</th><th>Método anticipo</th></tr></thead>
        <tbody>
          <tr><td>Lunes</td><td id="nom-fecha-lun">-</td><td><input type="time" id="nom-lun-ini"></td><td><input type="time" id="nom-lun-fin"></td><td id="nom-lun-hrs">0.00</td><td><input type="number" min="0" step="0.01" id="nom-lun-com"></td><td><input type="number" min="0" step="0.01" id="nom-lun-bono"></td><td><input type="number" min="0" step="0.01" id="nom-lun-ded"></td><td><input type="number" min="0" step="0.01" id="nom-lun-adv"></td><td><select id="nom-lun-advm"><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></td></tr>
          <tr><td>Martes</td><td id="nom-fecha-mar">-</td><td><input type="time" id="nom-mar-ini"></td><td><input type="time" id="nom-mar-fin"></td><td id="nom-mar-hrs">0.00</td><td><input type="number" min="0" step="0.01" id="nom-mar-com"></td><td><input type="number" min="0" step="0.01" id="nom-mar-bono"></td><td><input type="number" min="0" step="0.01" id="nom-mar-ded"></td><td><input type="number" min="0" step="0.01" id="nom-mar-adv"></td><td><select id="nom-mar-advm"><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></td></tr>
          <tr><td>Miércoles</td><td id="nom-fecha-mie">-</td><td><input type="time" id="nom-mie-ini"></td><td><input type="time" id="nom-mie-fin"></td><td id="nom-mie-hrs">0.00</td><td><input type="number" min="0" step="0.01" id="nom-mie-com"></td><td><input type="number" min="0" step="0.01" id="nom-mie-bono"></td><td><input type="number" min="0" step="0.01" id="nom-mie-ded"></td><td><input type="number" min="0" step="0.01" id="nom-mie-adv"></td><td><select id="nom-mie-advm"><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></td></tr>
          <tr><td>Jueves</td><td id="nom-fecha-jue">-</td><td><input type="time" id="nom-jue-ini"></td><td><input type="time" id="nom-jue-fin"></td><td id="nom-jue-hrs">0.00</td><td><input type="number" min="0" step="0.01" id="nom-jue-com"></td><td><input type="number" min="0" step="0.01" id="nom-jue-bono"></td><td><input type="number" min="0" step="0.01" id="nom-jue-ded"></td><td><input type="number" min="0" step="0.01" id="nom-jue-adv"></td><td><select id="nom-jue-advm"><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></td></tr>
          <tr><td>Viernes</td><td id="nom-fecha-vie">-</td><td><input type="time" id="nom-vie-ini"></td><td><input type="time" id="nom-vie-fin"></td><td id="nom-vie-hrs">0.00</td><td><input type="number" min="0" step="0.01" id="nom-vie-com"></td><td><input type="number" min="0" step="0.01" id="nom-vie-bono"></td><td><input type="number" min="0" step="0.01" id="nom-vie-ded"></td><td><input type="number" min="0" step="0.01" id="nom-vie-adv"></td><td><select id="nom-vie-advm"><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></td></tr>
          <tr><td>Sábado</td><td id="nom-fecha-sab">-</td><td><input type="time" id="nom-sab-ini"></td><td><input type="time" id="nom-sab-fin"></td><td id="nom-sab-hrs">0.00</td><td><input type="number" min="0" step="0.01" id="nom-sab-com"></td><td><input type="number" min="0" step="0.01" id="nom-sab-bono"></td><td><input type="number" min="0" step="0.01" id="nom-sab-ded"></td><td><input type="number" min="0" step="0.01" id="nom-sab-adv"></td><td><select id="nom-sab-advm"><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></td></tr>
          <tr><td>Domingo</td><td id="nom-fecha-dom">-</td><td><input type="time" id="nom-dom-ini"></td><td><input type="time" id="nom-dom-fin"></td><td id="nom-dom-hrs">0.00</td><td><input type="number" min="0" step="0.01" id="nom-dom-com"></td><td><input type="number" min="0" step="0.01" id="nom-dom-bono"></td><td><input type="number" min="0" step="0.01" id="nom-dom-ded"></td><td><input type="number" min="0" step="0.01" id="nom-dom-adv"></td><td><select id="nom-dom-advm"><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></td></tr>
        </tbody>
      </table>
      <div class="row">
        <div class="grow"></div>
        <div style="min-width:260px">
          <div class="kpi"><small>Sueldo por hora</small><strong id="nom-sueldo">$0.00</strong></div>
          <div class="kpi"><small>Horas totales</small><strong id="nom-horas">0.00</strong></div>
          <div class="kpi"><small>Comisiones</small><strong id="nom-coms">$0.00</strong></div>
          <div class="kpi"><small>Bonos</small><strong id="nom-bonos">$0.00</strong></div>
          <div class="kpi"><small>Deducciones admin</small><strong id="nom-deds">$0.00</strong></div>
          <div class="kpi"><small>Anticipos (semana)</small><strong id="nom-anticipos">$0.00</strong></div>
          <div class="kpi"><small>Total neto a pagar</small><strong id="nom-total">$0.00</strong></div>
          <hr class="sep">
          <div class="kpi"><small>Ventas semana (colaborador)</small><strong id="nom-kpi-ventas">$0.00</strong></div>
          <div class="kpi"><small>Comisión sugerida 4%</small><strong id="nom-kpi-com-sug">$0.00</strong></div>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="grow">Notas/Retroalimentación<textarea id="nom-notas" rows="3" placeholder="Comentarios para el colaborador"></textarea></label>
      </div>
      <div class="toolbar">
        <button id="nom-guardar" class="btn primary" onclick="nominaGen.guardar()">Registrar gasto de nómina</button>
        <button class="btn" onclick="nominaGen.exportPDF()">Exportar PDF</button>
      </div>
    </div>
    <div class="card collapsible-card" id="nom-hist-card">
      <div class="collapsible-head">
        <h3>Historial de nóminas</h3>
        <button class="btn ghost btn-compact" id="nom-hist-toggle" type="button" onclick="toggleNominaHistorial()">Contraer</button>
      </div>
      <div class="collapsible-body" id="nom-hist-body">
        <table class="table" id="tbl-nominas"><thead><tr>
          <th>Folio</th><th>Colaborador</th><th>Semana</th><th>Horas</th><th>Comisiones</th><th>Bonos</th><th>Anticipos</th><th>Nómina real</th><th>Neto</th><th>Pago</th><th>Método</th><th>Acciones</th>
        </tr></thead><tbody></tbody></table>
      </div>
    </div>
    <div class="card">
      <h3>Indicadores y gráficas</h3>
      <div class="toolbar">
        <label>Desde<input type="date" id="nom-v-desde"></label>
        <label>Hasta<input type="date" id="nom-v-hasta"></label>
        <label>Agrupar<select id="nom-v-group"><option value="dia">Día</option><option value="semana" selected>Semana</option><option value="mes">Mes</option><option value="colaborador">Colaborador</option></select></label>
        <label>Colaborador<select id="nom-v-emp"><option value="">(Todos)</option></select></label>
        <button class="btn" onclick="renderNominaInsights()">Aplicar</button>
        <div class="grow"></div>
        <small class="muted">La comisión estimada es 4% del subtotal</small>
      </div>
      <div class="card-grid" id="nom-v-kpis" style="margin-bottom:8px"></div>
      <div class="card" id="nom-v-formula" style="margin-bottom:12px"></div>
      <div class="chart-grid-2 tight" id="nom-v-charts">
        <div class="card"><h3>Comisiones por periodo</h3><canvas id="chart-nomina-com-periodo"></canvas></div>
        <div class="card"><h3>Ventas estimadas por periodo</h3><canvas id="chart-nomina-ventas-periodo"></canvas></div>
        <div class="card"><h3>Nómina real por periodo</h3><canvas id="chart-nomina-real-periodo"></canvas></div>
        <div class="card"><h3>Comisiones diarias</h3><canvas id="chart-nomina-com-dia"></canvas></div>
        <div class="card"><h3>Comisiones semanales</h3><canvas id="chart-nomina-com-semana"></canvas></div>
        <div class="card"><h3>Comisiones por colaborador</h3><canvas id="chart-nomina-com-col"></canvas></div>
        <div class="card"><h3>Ventas estimadas por colaborador</h3><canvas id="chart-nomina-ventas-col"></canvas></div>
        <div class="card"><h3>Ventas comisionadas (diario)</h3><canvas id="chart-ventas-com-dia"></canvas></div>
        <div class="card"><h3>% ventas comisionadas vs totales</h3><canvas id="chart-ventas-com-pct"></canvas></div>
      </div>
      <div class="card">
        <h3>Ventas estimadas totales</h3>
        <canvas id="chart-nomina-ventas-total"></canvas>
      </div>
      <div class="card">
        <h3>Productos más vendidos (filtrado actual)</h3>
        <div id="nom-v-productos"></div>
      </div>
      <div class="card">
        <h3>Ideas para potenciar comisiones</h3>
        <ul id="nom-v-ideas" class="idea-list"></ul>
      </div>
      <div class="card" id="nom-team-card">
        <h3>Team Pulse</h3>
        <div id="nom-team-body"></div>
      </div>
    </div>
  </section>

  <section id="panel-ventas" class="panel hidden"><h2>Ventas</h2>
      <div class="toolbar">
      <button class="btn primary" onclick="ventas.nuevoTicket()">Nuevo ticket</button>
      <label class="btn">Importar ventas (Excel)
        <input type="file" accept=".xlsx,.xls" style="display:none" onchange="importVentasExcel(this.files)" />
      </label>
      <button class="btn" onclick="exportCSV.ventas()">Exportar CSV</button>
    </div>
    <div id="venta-form" class="card hidden"></div>
    <div class="card">
      <h3>Filtros</h3>
      <div class="row" style="margin-bottom:8px">
        <label>Desde<input type="date" id="v-desde"></label>
        <label>Hasta<input type="date" id="v-hasta"></label>
        <label>Método<select id="v-met"><option value="">(Todos)</option><option>Efectivo</option><option>Tarjeta</option><option>Uber</option><option>Rappi</option></select></label>
        <div class="grow"></div>
        <button class="btn" onclick="renderVentas()">Aplicar</button>
      </div>
    </div>
    <div class="card sales-weekday-card">
      <div class="sales-weekday-head">
        <div>
          <h3>Ritmo por día de la semana</h3>
          <span class="muted" id="ventas-weekday-range">Selecciona un rango para ver el comportamiento.</span>
        </div>
        <div class="sales-weekday-pills" id="ventas-weekday-pills"></div>
      </div>
      <div class="sales-weekday-grid">
        <div id="ventas-weekday-summary"></div>
        <canvas id="chart-ventas-weekday"></canvas>
      </div>
    </div>
    <div class="card">
      <h3>Tendencia semanal de ventas</h3>
      <span class="muted" id="ventas-weektrend-meta">Sin datos suficientes.</span>
      <canvas id="chart-ventas-weektrend"></canvas>
    </div>
    <div class="card" id="ventas-rapidas-card">
      <h3>Ventas diarias (resumen rápido)</h3>
      <div class="row">
        <label>Fecha<input type="date" id="vd-fecha" value=""></label>
        <label>Efectivo<input type="number" id="vd-efectivo" step="0.01" min="0" placeholder="0.00"></label>
        <label>Tarjeta<input type="number" id="vd-tarjeta" step="0.01" min="0" placeholder="0.00"></label>
        <label>Uber<input type="number" id="vd-uber" step="0.01" min="0" placeholder="0.00"></label>
        <label>Rappi<input type="number" id="vd-rappi" step="0.01" min="0" placeholder="0.00"></label>
      </div>
      <div class="row">
        <label>Propinas Tarjeta<input type="number" id="vd-p-tarjeta" step="0.01" min="0" placeholder="0.00"></label>
      </div>
      <div class="toolbar">
        <button class="btn primary" onclick="ventasRapidas.guardar()">Guardar/Actualizar</button>
        <button class="btn ghost" onclick="ventasRapidas.prefill()">Recargar</button>
      </div>
      <small class="muted">Tip: Deja en 0 para conservar el registro editable; usa “Eliminar” si quieres borrarlo.</small>
    </div>
    <div class="card" id="vd-registros-card">
      <h3>Registros del día</h3>
      <table class="table" id="tbl-vd"><thead><tr><th>Método</th><th>Total</th><th>A recibir</th><th>Acciones</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h3>Historial de ventas</h3>
      <table class="table" id="tbl-ventas"><thead><tr><th>Fecha/Hora</th><th>Folio</th><th>Estación</th><th>Barista</th><th>Método</th><th>Subtotal</th><th>Impuestos</th><th>Total</th><th>Acciones</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="panel-recetas" class="panel hidden"><h2>Recetas / Costeo</h2>
    <div class="toolbar">
      <button class="btn primary" onclick="recetas.nueva()">Nueva receta</button>
      <label class="grow">Buscar receta<input id="rc-buscar" placeholder="Nombre, palabra clave…"></label>
      <button class="btn" onclick="recetasCalcularCosto()">Recalcular costos</button>
      <button class="btn" onclick="recetas.exportPDF()">Exportar PDF</button>
    </div>
    <div class="card" id="abc-config-card"></div>
    <div class="card" id="abc-breakeven"></div>
    <div id="receta-form" class="card hidden"></div>
    <div class="card">
      <h3>Recetas</h3>
      <table class="table" id="tbl-recetas"><thead><tr><th>Nombre</th><th>Porciones</th><th>Insumos/porción</th><th>ABC/porción</th><th>Costo/porción</th><th>Precio sugerido</th><th>Acciones</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <div class="toolbar">
        <button class="btn" onclick="costosInsumos.nuevo()">Nuevo insumo (costo)</button>
      </div>
      <h3>Insumos (costos para recetas)</h3>
      <table class="table" id="tbl-costos"><thead><tr><th>Insumo</th><th>Proveedor</th><th>Unidad</th><th>Costo unitario</th><th>Acciones</th></tr></thead><tbody></tbody></table>
    </div>
    <div id="costeo-form" class="card hidden"></div>
  </section>

  <section id="panel-nomina-charts" class="panel hidden"></section>

  <section id="panel-inventario" class="panel hidden"><h2>Inventario</h2>
    <div class="toolbar">
      <button class="btn" onclick="inventario.nuevoInsumo()">Nuevo insumo</button>
      <button class="btn" onclick="exportCSV.kardex()">Exportar Kardex CSV</button>
    </div>
    <div class="card">
      <h3>Insumos</h3>
      <table class="table" id="tbl-insumos"><thead><tr><th>Insumo</th><th>Unidad</th><th>Existencia</th><th>Costo Prom.</th><th>Min</th><th>Max</th><th>Acciones</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h3>Kardex</h3>
      <div class="row">
        <label>Desde<input type="date" id="kdx-desde"></label>
        <label>Hasta<input type="date" id="kdx-hasta"></label>
        <label class="grow">Insumo<select id="kdx-insumo"></select></label>
        <button class="btn" onclick="inventario.renderKardex()">Filtrar</button>
      </div>
      <table class="table" id="tbl-kardex"><thead><tr><th>Fecha</th><th>Insumo</th><th>Tipo</th><th>Cantidad</th><th>Costo</th><th>Ref.</th><th>Notas</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="panel-compras" class="panel hidden"><h2>Insumos / Compras</h2>
    <div class="toolbar">
      <button class="btn" onclick="compras.nueva()">Nueva compra</button>
      <button class="btn" onclick="exportCSV.compras()">Exportar CSV</button>
    </div>
    <div id="compra-form" class="card hidden"></div>
    <div class="card">
      <h3>KPIs de compras (filtrado)</h3>
      <div class="toolbar">
        <label>Desde<input type="date" id="c-desde"></label>
        <label>Hasta<input type="date" id="c-hasta"></label>
        <label>Proveedor<select id="c-prov"><option value="">(Todos)</option></select></label>
        <label>Método<select id="c-met"><option value="">(Todos)</option><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></label>
        <button class="btn" onclick="renderCompras()">Aplicar</button>
      </div>
      <div class="card-grid" id="compras-kpis"></div>
    </div>
    <div class="card">
      <h3>Compras</h3>
      <table class="table" id="tbl-compras"><thead><tr><th>Fecha/Hora</th><th>Proveedor</th><th>Folio</th><th>Método</th><th>Total</th><th>Acciones</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="panel-gastos" class="panel hidden"><h2>Gastos</h2>
    <div class="toolbar">
      <button class="btn" onclick="gastos.nuevo()">Nuevo gasto</button>
      <button class="btn" onclick="exportCSV.gastos()">Exportar CSV</button>
    </div>
    <div id="gasto-form" class="card hidden"></div>
    <div class="card">
      <div class="card-title-flex">
        <h3>KPIs y gráficas de gastos</h3>
        <span class="title-chip" id="gastos-mix-chip">--</span>
      </div>
      <div class="row" style="margin-bottom:8px">
        <label>Desde<input type="date" id="g-desde"></label>
        <label>Hasta<input type="date" id="g-hasta"></label>
        <label>Método<select id="g-met"><option value="">(Todos)</option><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></label>
        <label>Tipo<select id="g-tipo"><option value="">(Todos)</option><option>Nómina</option><option>Insumos</option><option>Productos</option><option>Luz</option><option>Contabilidad</option><option>Propina</option><option>Marketing</option><option>Impuestos</option><option>Renta</option><option>Seguridad</option><option>Transporte</option><option>Mantenimiento</option><option>Otros</option><option>Compra</option><option>Ajuste</option></select></label>
        <label>Proveedor<select id="g-prov"><option value="">(Todos)</option></select></label>
        <label>Fuente<select id="g-source"><option value="">(Todas)</option><option value="Gasto">Gasto</option><option value="Compra">Compra</option><option value="Ajuste">Ajuste</option></select></label>
        <label><input type="checkbox" id="g-inc-comp" checked> Incluir compras</label>
        <label><input type="checkbox" id="g-inc-aj" checked> Incluir ajustes</label>
        <div class="btn-group" id="gastos-quick">
          <button class="btn ghost" data-preset="mes" onclick="setGastosRange('mes')">Este mes</button>
          <button class="btn ghost" data-preset="mesPasado" onclick="setGastosRange('mesPasado')">Mes pasado</button>
          <button class="btn ghost" data-preset="30" onclick="setGastosRange('30')">Últimos 30d</button>
          <button class="btn ghost" data-preset="7" onclick="setGastosRange('7')">Últimos 7d</button>
        </div>
        <div class="grow"></div>
        <button class="btn" onclick="renderGastos()">Filtrar</button>
      </div>
      <div class="card-grid" id="g-kpis"></div>
      <div class="chart-grid-2">
        <div class="card"><h3>Distribución porcentual por categoría</h3><canvas id="chart-gastos-cat"></canvas></div>
        <div class="card"><h3>Gasto por método</h3><canvas id="chart-gastos-met"></canvas></div>
        <div class="card"><h3>Gasto diario</h3><canvas id="chart-gastos-diario"></canvas></div>
        <div class="card"><h3>Top proveedores</h3><canvas id="chart-gastos-prov"></canvas></div>
      </div>
    </div>
    <div class="card">
      <h3>Listado</h3>
      <div class="toolbar">
        <label class="grow">Buscar<input type="search" id="g-buscar" placeholder="Descripción, proveedor o folio" oninput="renderGastos()"></label>
      </div>
      <table class="table" id="tbl-gastos"><thead><tr><th>Fecha</th><th>Tipo</th><th>Descripción</th><th>Proveedor/Pagado por</th><th>Método</th><th>Importe</th><th>Folio</th><th>Fuente</th><th>Acciones</th></tr></thead><tbody></tbody></table>
    </div>
    
  </section>

  <section id="panel-sobres" class="panel hidden"><h2>Sobres</h2>
    <p class="muted">Registra el efectivo diario que permanece en la cafetería, marca cuándo lo retiras y controla los pendientes.</p>
    <div class="toolbar">
      <label>Desde<input type="date" id="sobres-desde"></label>
      <label>Hasta<input type="date" id="sobres-hasta"></label>
      <button class="btn" onclick="sobresManager.generar()">Generar lista</button>
      <div class="btn-group" id="sobres-quick">
        <button class="btn ghost" data-preset="mes" onclick="sobresManager.setPreset('mes')">Este mes</button>
        <button class="btn ghost" data-preset="prox7" onclick="sobresManager.setPreset('prox7')">Próx. 7 días</button>
      </div>
      <div class="grow"></div>
      <span class="sobres-summary">Pendiente por retirar: <strong id="sobres-pendiente">--</strong></span>
    </div>
    <div class="card">
      <div class="card-title-flex">
        <h3>Mini dashboard de efectivo</h3>
      </div>
      <div class="toolbar">
        <label>Semana<input type="week" id="sobres-week"></label>
        <div class="btn-group">
          <button class="btn ghost" data-week="current" onclick="sobresManager.setWeekPreset('current')">Semana actual</button>
          <button class="btn ghost" data-week="prev" onclick="sobresManager.setWeekPreset('prev')">Semana pasada</button>
          <button class="btn ghost" data-week="range30" onclick="sobresManager.setPreset('30')">Últimos 30d</button>
        </div>
        <div class="grow"></div>
        <button class="btn" onclick="sobresManager.applyWeek()">Aplicar semana</button>
      </div>
      <div class="card-grid" id="sobres-kpis"></div>
      <div class="chart-grid-2 tight">
        <div class="card">
          <h3>Planificado vs retirado</h3>
          <canvas id="chart-sobres-plan"></canvas>
        </div>
        <div class="card">
          <h3>Evolución pendiente</h3>
          <canvas id="chart-sobres-pend"></canvas>
        </div>
      </div>
    </div>
    <div class="card">
      <h3>Control diario de sobres</h3>
      <table class="table" id="tbl-sobres"><thead><tr><th>Fecha</th><th>Monto a retirar</th><th class="checkbox-cell">¿Retirado?</th><th class="actions-cell">Última actualización</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="panel-cortes" class="panel hidden"><h2>Cortes de caja</h2>
    <div class="toolbar">
      <label class="btn">Importar corte (PDF)
        <input type="file" accept="application/pdf" style="display:none" onchange="importCortePdf(this.files[0])" />
      </label>
      <button class="btn" onclick="cortes.manual()">Entrada manual</button>
      <button class="btn" onclick="cortes.cerrarTurno()">Cerrar turno</button>
    </div>
    <div id="corte-form" class="card hidden"></div>
    <div class="card">
      <h3>Historial</h3>
      <table class="table" id="tbl-cortes"><thead><tr><th>Fecha</th><th>Turno</th><th>Efectivo</th><th>Tarjeta</th><th>Vales</th><th>Propinas</th><th>Cancel.</th><th>Devol.</th><th>Diferencia</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="panel-agenda" class="panel hidden"><h2>Agenda</h2>
    <div class="toolbar">
      <button class="btn" onclick="agenda.nuevo()">Nuevo evento</button>
    </div>
    <div class="card">
      <table class="table" id="tbl-agenda"><thead><tr><th>Fecha</th><th>Título</th><th>Estado</th><th>Notas</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="panel-catalogos" class="panel hidden"><h2>Catálogos</h2>
    <div class="card-grid">
      <div class="card"><h3>Proveedores</h3><button class="btn" onclick="catalogos.editar('proveedores')">Editar</button></div>
      <div class="card"><h3>Estaciones</h3><button class="btn" onclick="catalogos.editar('estaciones')">Editar</button></div>
      <div class="card"><h3>Empleados</h3><button class="btn" onclick="catalogos.editar('empleados')">Editar</button></div>
      <div class="card"><h3>Clientes</h3><button class="btn" onclick="catalogos.editar('clientes')">Editar</button></div>
      <div class="card"><h3>Productos/Recetas</h3><button class="btn" onclick="catalogos.editar('recetas')">Editar</button></div>
    </div>
    <div id="catalogo-modal" class="card hidden"></div>
  </section>

  <section id="panel-config" class="panel hidden"><h2>Config</h2>
    <div class="card">
      <div class="row">
        <label class="grow">Modo<select id="cfg-modo"><option value="local">local</option><option value="api">api (mock)</option></select></label>
        <label>IVA %<input type="number" id="cfg-iva" value="16" step="0.01"></label>
        <label>Margen %<input type="number" id="cfg-margen" value="60" step="0.01"></label>
        <label>Decimales<input type="number" id="cfg-dec" value="2" min="0" max="4"></label>
        <label>Alertas (días)<input type="number" id="cfg-alert" value="7" min="0"></label>
        <label>Saldo inicial efectivo<input type="number" id="cfg-saldo-efec" value="0" step="0.01"></label>
        <label>Saldo inicial banco<input type="number" id="cfg-saldo-banco" value="0" step="0.01"></label>
      </div>
      <div class="toolbar">
        <button class="btn" onclick="mockApiTest()">Probar API</button>
        <button class="btn" onclick="backup.export()">Exportar backup JSON</button>
        <label class="btn">Importar backup JSON<input type="file" accept="application/json" style="display:none" onchange="backup.import(this.files[0])"></label>
        <button class="btn danger" onclick="if(confirm('¿Borrar todos los datos locales?')) LocalDB.clearAll()">Borrar todo</button>
      </div>
    </div>
  </section>
</main>
<footer>
  © Better Mood Coffee · Control de Cafetería — Ventas, recetas, inventario y cortes · Offline listo.
</footer>
<div id="toast"></div>
<div id="chart-tooltip" class="chart-tooltip hidden"></div>
<div id="chart-modal" class="chart-modal">
  <div class="modal-content">
    <header>
      <h3 id="chart-modal-title">Detalle de gráfica</h3>
      <button class="close-btn" onclick="closeChartModal()">Cerrar</button>
    </header>
    <div class="meta" id="chart-modal-meta"></div>
    <div class="modal-canvas-wrap"><canvas id="chart-modal-canvas"></canvas></div>
  </div>
</div>
<div id="ledger-modal" class="ledger-modal" aria-hidden="true">
  <div class="ledger-modal-dialog">
    <div class="ledger-modal-header">
      <div>
        <h3 id="ledger-modal-title">Estado de cuenta</h3>
        <div class="ledger-modal-meta" id="ledger-modal-meta">Vista detallada</div>
      </div>
      <button class="ledger-modal-close" type="button" onclick="LedgerModal.close()">Cerrar</button>
    </div>
    <div class="ledger-modal-table" id="ledger-modal-table"></div>
  </div>
</div>

<!-- BMC: Allowed libs -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script>
// BMC: PDF.js worker setup
if (window['pdfjsLib']) { pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.worker.min.js'; }
</script>
<script>
/***************************
 * BMC: Helpers & Framework *
 ***************************/
// Localización CDMX y utilidades de fecha/hora
const TZ='America/Mexico_City';
function pad2(n){return String(n).padStart(2,'0');}
function toLocalParts(d){ const dt=new Date(d); const f=new Intl.DateTimeFormat('sv-SE',{timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false}); const parts=f.formatToParts(dt); const map=Object.fromEntries(parts.map(p=>[p.type,p.value])); return map; }
function normalizeDateInput(value){
  if(!value) return null;
  if(value instanceof Date) return value;
  if(typeof value==='number') return new Date(value);
  if(typeof value==='string'){
    const hasTime=value.includes('T');
    return new Date(hasTime? value : value+'T00:00:00');
  }
  try{ return new Date(value); }catch(_){ return null; }
}
function localDateTime(d){
  const raw=d;
  const dt=normalizeDateInput(d); if(!dt || Number.isNaN(dt.getTime())) return String(raw??'');
  const parts=toLocalParts(dt);
  const hasTime = raw instanceof Date || (typeof raw==='string' && raw.includes('T'));
  const time = hasTime? ` ${parts.hour}:${parts.minute}` : '';
  return `${parts.day}/${parts.month}/${parts.year}${time}`;
}
function localDateDMY(d){
  const raw=d;
  const dt=normalizeDateInput(d); if(!dt || Number.isNaN(dt.getTime())) return String(raw??'');
  const parts=toLocalParts(dt);
  return `${parts.day}/${parts.month}/${parts.year}`;
}
function formatShortDate(iso){
  if(!iso) return '';
  const dt=normalizeDateInput(iso); if(!dt || Number.isNaN(dt.getTime())) return String(iso);
  const parts=new Intl.DateTimeFormat('es-MX',{day:'2-digit',month:'short',year:'2-digit'}).formatToParts(dt);
  const map=Object.fromEntries(parts.map(p=>[p.type,p.value]));
  const month=(map.month||'').replace('.', '').slice(0,3).toLowerCase();
  return `${map.day||''}/${month}/${map.year||''}`.replace(/\/+/g,'/');
}
function localDateISO(d){ const p=toLocalParts(d); return `${p.year}-${p.month}-${p.day}`; }
// Día de negocio con cierre a las 22:00 local (configurable)
function businessDateISO(d){ const p=toLocalParts(d); const hour=Number(p.hour||'0'); let y=Number(p.year), m=Number(p.month), day=Number(p.day); const cierre=(cfg.cierreHora??22); if(hour>=cierre){ const tmp=new Date(`${p.year}-${p.month}-${p.day}T00:00:00`); tmp.setDate(tmp.getDate()+1); const pp=toLocalParts(tmp); y=Number(pp.year); m=Number(pp.month); day=Number(pp.day); } return `${y}-${pad2(m)}-${pad2(day)}`; }
const fmt={money:n=> (n??0).toLocaleString('es-MX',{style:'currency',currency:'MXN'}), num:(n,dec=cfg.decimales)=>Number(n??0).toFixed(dec), date:d=> localDateTime(d), dateOnly:d=> localDateDMY(d) };
const max0=(n)=> Number(n||0);
const uid=()=> Math.random().toString(36).slice(2)+Date.now().toString(36).slice(4);
const notify=(msg,type='')=>{const el=document.createElement('div');el.className='toast '+(type||'');el.textContent=msg;document.getElementById('toast').appendChild(el);setTimeout(()=>el.remove(),3500)};
const todayISO=()=> localDateISO(new Date());
const addDaysISO=(iso,n)=>{ const base=iso||todayISO(); const d=new Date(base+'T00:00:00'); d.setDate(d.getDate()+Number(n||0)); return localDateISO(d); };
const inRange=(d,desde,hasta)=>{const x=new Date(d).getTime();return (!desde||x>=new Date(desde).getTime()) && (!hasta||x<=new Date(hasta).getTime()+86400000-1)}

/***************************
 * BMC: Auth & Remote Sync *
 ***************************/
const AUTH_USER='better';
const AUTH_PASS='nube';

const RemoteSync=(()=>{
  const ENDPOINT='/.netlify/functions/bmc-blobs';
  const KEY_PREFIX='bm_';
  const SKIP_PREFIXES=['bm_auth_','bm_remote_'];
  const LOCAL_STAMP_KEY='bm_remote_local_stamp';
  const rawGet=localStorage.getItem.bind(localStorage);
  const rawSet=localStorage.setItem.bind(localStorage);
  const rawRemove=localStorage.removeItem.bind(localStorage);
  const rawClear=localStorage.clear.bind(localStorage);
  let authToken='';
  let suppress=false;
  let syncTimer=null;
  let syncing=false;
  let pending=false;

  function isSyncKey(key){
    if(!key || !key.startsWith(KEY_PREFIX)) return false;
    return !SKIP_PREFIXES.some(prefix=> key.startsWith(prefix));
  }
  function updateBadge(text,tone){
    const el=document.getElementById('sync-badge');
    if(!el) return;
    el.textContent=text;
    el.classList.remove('ok','warn','err');
    if(tone) el.classList.add(tone);
  }
  function setLocalStamp(ts){ rawSet(LOCAL_STAMP_KEY, String(ts||0)); }
  function getLocalStamp(){ return Number(rawGet(LOCAL_STAMP_KEY)||0); }
  function collectLocal(){
    const data={};
    Object.keys(localStorage).forEach((key)=>{
      if(isSyncKey(key)){ data[key]=rawGet(key); }
    });
    return data;
  }
  function applyRemote(data){
    suppress=true;
    try{
      const safe=data && typeof data==='object'? data:{};
      const remoteKeys=new Set(Object.keys(safe));
      Object.keys(localStorage).forEach((key)=>{
        if(isSyncKey(key) && !remoteKeys.has(key)){ rawRemove(key); }
      });
      Object.entries(safe).forEach(([key,value])=>{
        if(isSyncKey(key)){ rawSet(key, value); }
      });
    }finally{
      suppress=false;
    }
    try{ invalidateCaches(); }catch(_){}
  }
  async function request(method, body){
    if(!authToken) throw new Error('missing_auth');
    const headers={Authorization:`Basic ${authToken}`};
    if(body){ headers['Content-Type']='application/json'; }
    const res=await fetch(ENDPOINT, {method, headers, body: body? JSON.stringify(body): undefined});
    let payload={};
    try{ payload=await res.json(); }catch(_){}
    if(!res.ok){
      const err=new Error(payload.error||'request_failed');
      err.status=res.status;
      throw err;
    }
    return payload;
  }
  async function pushLocal(forcedStamp){
    if(syncing){ pending=true; return false; }
    syncing=true;
    const stamp=forcedStamp||Date.now();
    setLocalStamp(stamp);
    updateBadge('Sync: guardando','warn');
    try{
      const payload=await request('POST', {data: collectLocal(), updatedAt: stamp});
      if(payload.updatedAt){ setLocalStamp(payload.updatedAt); }
      updateBadge('Sync: listo','ok');
      return true;
    }catch(err){
      updateBadge(err.status===401? 'Sync: auth':'Sync: offline', err.status===401? 'err':'warn');
      return false;
    }finally{
      syncing=false;
      if(pending){
        pending=false;
        scheduleSync();
      }
    }
  }
  async function pullOrPush(){
    if(!authToken) return false;
    updateBadge('Sync: conectando','warn');
    let remote=null;
    try{
      remote=await request('GET');
    }catch(err){
      if(err.status===401){ updateBadge('Sync: auth','err'); throw err; }
      updateBadge('Sync: offline','warn');
      return false;
    }
    const remoteUpdated=Number(remote.updatedAt||0);
    const localStamp=getLocalStamp();
    if(remoteUpdated>localStamp){
      applyRemote(remote.data||{});
      setLocalStamp(remoteUpdated);
      updateBadge('Sync: listo','ok');
      return true;
    }
    if(remoteUpdated===0 && Object.keys(remote.data||{}).length===0 && Object.keys(collectLocal()).length===0){
      updateBadge('Sync: listo','ok');
      return true;
    }
    if(localStamp>=remoteUpdated){
      await pushLocal(localStamp||Date.now());
    } else {
      updateBadge('Sync: listo','ok');
    }
    return true;
  }
  function scheduleSync(){
    if(!authToken || suppress) return;
    const stamp=Date.now();
    setLocalStamp(stamp);
    updateBadge('Sync: guardando','warn');
    if(syncTimer) clearTimeout(syncTimer);
    syncTimer=setTimeout(()=>{ pushLocal(stamp); }, 1200);
  }
  async function flushNow(){
    if(!authToken) return false;
    return pushLocal(Date.now());
  }
  function patchStorage(){
    if(window.__bmcStoragePatched) return;
    window.__bmcStoragePatched=true;
    localStorage.setItem=(key,value)=>{ rawSet(key,value); if(!suppress && isSyncKey(key)) scheduleSync(); };
    localStorage.removeItem=(key)=>{ rawRemove(key); if(!suppress && isSyncKey(key)) scheduleSync(); };
    localStorage.clear=()=>{ const keys=Object.keys(localStorage); rawClear(); if(!suppress && keys.some(isSyncKey)) scheduleSync(); };
  }
  function init(){ patchStorage(); updateBadge('Sync: local',''); }
  function setAuth(token){ authToken=token||''; if(!authToken){ updateBadge('Sync: local',''); } }
  function clearAuth(){ authToken=''; updateBadge('Sync: local',''); }
  return { init, setAuth, clearAuth, pullOrPush, scheduleSync, applyRemote, flushNow };
})();
RemoteSync.init();

const Auth=(()=>{
  const TOKEN_KEY='bm_auth_token';
  let booting=false;
  function getToken(){ return localStorage.getItem(TOKEN_KEY)||''; }
  function setToken(token){ localStorage.setItem(TOKEN_KEY, token); }
  function clearToken(){ localStorage.removeItem(TOKEN_KEY); }
  function setOverlayVisible(show){
    document.body.classList.toggle('auth-locked', show);
    const overlay=document.getElementById('auth-overlay');
    if(overlay) overlay.classList.toggle('hidden', !show);
    const logoutBtn=document.getElementById('logout-btn');
    if(logoutBtn) logoutBtn.classList.toggle('hidden', show);
  }
  function setError(msg){
    const el=document.getElementById('auth-error');
    if(el) el.textContent=msg||'';
  }
  function setStatus(msg){
    const el=document.getElementById('auth-status');
    if(el) el.textContent=msg||'';
  }
  async function login(user, pass){
    if(booting) return false;
    setError('');
    setStatus('Validando...');
    if(user!==AUTH_USER || pass!==AUTH_PASS){
      setStatus('');
      setError('Credenciales invalidas');
      return false;
    }
    const token=btoa(`${user}:${pass}`);
    setToken(token);
    RemoteSync.setAuth(token);
    setStatus('Sincronizando...');
    booting=true;
    try{
      await RemoteSync.pullOrPush();
      await bootApp();
      setOverlayVisible(false);
      setStatus('');
      return true;
    }catch(err){
      if(err && err.status===401){
        clearToken();
        RemoteSync.clearAuth();
        setStatus('');
        setError('Acceso denegado');
        setOverlayVisible(true);
        return false;
      }
      await bootApp();
      setStatus('Sin conexion, usando datos locales');
      setOverlayVisible(false);
      return true;
    }finally{
      booting=false;
    }
  }
  function logout(){
    clearToken();
    RemoteSync.clearAuth();
    setError('');
    setStatus('');
    setOverlayVisible(true);
  }
  function bindUI(){
    const btn=document.getElementById('auth-login-btn');
    const userEl=document.getElementById('auth-user');
    const passEl=document.getElementById('auth-pass');
    if(btn){
      btn.addEventListener('click', ()=>{
        login((userEl?.value||'').trim(), passEl?.value||'');
      });
    }
    [userEl, passEl].forEach((el)=>{
      if(!el) return;
      el.addEventListener('input', ()=>{ setError(''); setStatus(''); });
      el.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){ btn?.click(); }
      });
    });
  }
  async function autoLogin(){
    const token=getToken();
    if(!token){
      setOverlayVisible(true);
      return;
    }
    RemoteSync.setAuth(token);
    setStatus('Sincronizando...');
    try{
      await RemoteSync.pullOrPush();
      await bootApp();
      setOverlayVisible(false);
      setStatus('');
    }catch(err){
      if(err && err.status===401){
        logout();
        setError('Acceso denegado');
        return;
      }
      await bootApp();
      setStatus('Sin conexion, usando datos locales');
      setOverlayVisible(false);
    }
  }
  function init(){ bindUI(); }
  return { init, login, logout, autoLogin };
})();
window.Auth=Auth;

const THEME_KEY='bm_theme_mode';
function applyTheme(mode){
  const body=document.body;
  if(mode==='light'){ body.classList.add('light-mode'); }
  else { body.classList.remove('light-mode'); mode='dark'; }
  localStorage.setItem(THEME_KEY, mode);
  const btn=document.getElementById('theme-toggle');
  if(btn) btn.textContent = mode==='light'? 'Modo noche':'Modo día';
}
function initTheme(){
  const saved=localStorage.getItem(THEME_KEY)||'dark';
  applyTheme(saved);
}
function toggleTheme(){
  const current=document.body.classList.contains('light-mode')?'light':'dark';
  applyTheme(current==='light'?'dark':'light');
}

// tiny debounce
function debounce(fn,ms){let t; return (...args)=>{clearTimeout(t); t=setTimeout(()=>fn.apply(null,args), ms);} }

// Métodos de venta y colores
const METHODS=['Efectivo','Tarjeta','Uber','Rappi'];
const METHOD_COLORS={Efectivo:'#10B981', Tarjeta:'#3B82F6', Uber:'#F59E0B', Rappi:'#EF4444'};
const COMM_RATE=0.04;
const CHART_THEME={
  dark:{grid:'#1f2630', axis:'#9CA3AF', label:'#F8FAFC', avg:'#FACC15', trend:'#38BDF8', markerUp:'#22D3EE', markerDown:'#F87171', highlight:'#F97316', donutCenter:'rgba(12,16,24,0.92)'},
  light:{grid:'#DCE2EC', axis:'#4B5563', label:'#0f172a', avg:'#F97316', trend:'#0284C7', markerUp:'#0EA5E9', markerDown:'#DC2626', highlight:'#334155', donutCenter:'rgba(255,255,255,0.96)'}
};
const CHART_PALETTE=['#FFD74B','#38BDF8','#FB7185','#A855F7','#34D399','#FDBA74','#60A5FA','#FACC15'];
function chartPalette(idx){ return CHART_PALETTE[idx % CHART_PALETTE.length]; }
function currentChartTheme(){ return document.body.classList.contains('light-mode')? CHART_THEME.light : CHART_THEME.dark; }
function adjustColor(hex, amount){
  if(typeof hex!=='string' || !hex.startsWith('#') || hex.length!==7) return hex;
  const num=parseInt(hex.slice(1),16);
  const clamp=(v)=> Math.max(0, Math.min(255, v));
  const r=clamp((num>>16)+amount);
  const g=clamp(((num>>8)&0xFF)+amount);
  const b=clamp((num&0xFF)+amount);
  return `#${((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1)}`;
}
// Colores por categoría de gasto
const EXPENSE_COLORS={
  'Nómina':'#10B981', 'Compra':'#3B82F6', 'Insumos':'#60A5FA', 'Productos':'#4ADE80', 'Luz':'#F59E0B', 'Contabilidad':'#8B5CF6', 'Propina':'#F472B6',
  'Marketing':'#06B6D4', 'Impuestos':'#FACC15', 'Renta':'#F87171', 'Seguridad':'#14B8A6', 'Transporte':'#0EA5E9', 'Mantenimiento':'#F97316', 'Ajuste':'#6B7280', 'Otros':'#9CA3AF'
};
function invalidateCaches(){ if(typeof dailySeriesCache!=='undefined'){ dailySeriesCache.key=''; } }

const CAL_STATIC_EVENTS=[
  {md:'01-01', label:'Año Nuevo', type:'oficial'},
  {md:'01-06', label:'Día de Reyes (chocolate caliente)', type:'marketing'},
  {md:'02-05', label:'Constitución Mexicana', type:'oficial'},
  {md:'02-14', label:'Campaña San Valentín', type:'marketing'},
  {md:'03-08', label:'Día Internacional de la Mujer', type:'marketing'},
  {md:'03-18', label:'Natalicio de Benito Juárez', type:'oficial'},
  {md:'04-07', label:'Semana Santa · Bebidas frías', type:'marketing'},
  {md:'04-30', label:'Día del Niño', type:'marketing'},
  {md:'05-01', label:'Día del Trabajo', type:'oficial'},
  {md:'05-10', label:'Día de las Madres', type:'marketing'},
  {md:'05-15', label:'Día del Maestro', type:'marketing'},
  {md:'05-23', label:'Hot Sale', type:'marketing'},
  {md:'06-01', label:'Inicio temporada graduaciones', type:'marketing'},
  {md:'06-21', label:'Verano Cold Brew', type:'marketing'},
  {md:'07-04', label:'Turistas verano', type:'marketing'},
  {md:'07-20', label:'Semana Frappes', type:'marketing'},
  {md:'08-01', label:'Back to School', type:'marketing'},
  {md:'09-16', label:'Independencia de México', type:'oficial'},
  {md:'09-29', label:'Día Internacional del Café', type:'marketing'},
  {md:'10-04', label:'Semana del café de especialidad', type:'marketing'},
  {md:'10-31', label:'Halloween', type:'marketing'},
  {md:'11-01', label:'Día de Muertos', type:'marketing'},
  {md:'11-15', label:'Buen Fin', type:'marketing'},
  {md:'11-24', label:'Cyber Monday', type:'marketing'},
  {md:'11-27', label:'Black Friday', type:'marketing'},
  {md:'11-20', label:'Revolución Mexicana', type:'oficial'},
  {md:'12-12', label:'Virgen de Guadalupe', type:'marketing'},
  {md:'12-24', label:'Nochebuena', type:'marketing'},
  {md:'12-25', label:'Navidad', type:'oficial'},
  {md:'12-31', label:'Fin de año', type:'marketing'}
];
const CAL_MARKETING_EVENTS=[
  {date:'2025-10-01', label:'MKT · Día Internacional del Café', type:'marketing'},
  {date:'2025-10-04', label:'MKT · Día Mundial de los Animales', type:'marketing'},
  {date:'2025-10-05', label:'MKT · Día Mundial de los Docentes', type:'marketing'},
  {date:'2025-10-06', label:'MKT · Aniversario de Instagram', type:'marketing'},
  {date:'2025-10-10', label:'MKT · Día Mundial de la Salud Mental', type:'marketing'},
  {date:'2025-10-19', label:'MKT · Lucha contra el Cáncer de Mama', type:'marketing'},
  {date:'2025-10-20', label:'MKT · Día Internacional del Chef', type:'marketing'},
  {date:'2025-10-24', label:'MKT · Día Internacional de las Bibliotecas', type:'marketing'},
  {date:'2025-10-25', label:'MKT · Día Mundial de la Pasta', type:'marketing'},
  {date:'2025-10-28', label:'MKT · Día Mundial de la Animación', type:'marketing'},
  {date:'2025-10-31', label:'MKT · Halloween / Día Mundial de las Ciudades', type:'marketing'},
  {date:'2025-11-01', label:'MKT · Todos los Santos / Día del Veganismo', type:'marketing'},
  {date:'2025-11-02', label:'MKT · Día de Muertos', type:'marketing'},
  {date:'2025-11-04', label:'MKT · Día Internacional del Marketing', type:'marketing'},
  {date:'2025-11-10', label:'MKT · Ciencia para la Paz y el Desarrollo', type:'marketing'},
  {date:'2025-11-11', label:'MKT · Día de las Librerías / Veterans Day (EE. UU.)', type:'marketing'},
  {date:'2025-11-14', label:'MKT · Día Mundial de la Diabetes', type:'marketing'},
  {date:'2025-11-16', label:'MKT · Flamenco / Gastronomía Mexicana', type:'marketing'},
  {date:'2025-11-17', label:'MKT · Día del Estudiante', type:'marketing'},
  {date:'2025-11-21', label:'MKT · Día de la Televisión / de la Pesca', type:'marketing'},
  {date:'2025-11-25', label:'MKT · Eliminación de la Violencia contra la Mujer', type:'marketing'},
  {date:'2025-11-28', label:'MKT · Black Friday', type:'marketing'},
  {date:'2025-11-30', label:'MKT · Día del Influencer / Cyber Monday', type:'marketing'},
  {date:'2025-12-01', label:'MKT · Lucha contra el SIDA / Cyber Monday', type:'marketing'},
  {date:'2025-12-03', label:'MKT · Personas con Discapacidad', type:'marketing'},
  {date:'2025-12-05', label:'MKT · Voluntariado', type:'marketing'},
  {date:'2025-12-07', label:'MKT · Algodón de Azúcar', type:'marketing'},
  {date:'2025-12-09', label:'MKT · Informática / Contra la Corrupción', type:'marketing'},
  {date:'2025-12-10', label:'MKT · Derechos Humanos / Derechos de los Animales', type:'marketing'},
  {date:'2025-12-11', label:'MKT · Montañas', type:'marketing'},
  {date:'2025-12-18', label:'MKT · Migrante', type:'marketing'},
  {date:'2025-12-20', label:'MKT · Solidaridad Humana', type:'marketing'},
  {date:'2025-12-21', label:'MKT · Solsticio de Invierno', type:'marketing'},
  {date:'2025-12-24', label:'MKT · Nochebuena', type:'marketing'},
  {date:'2025-12-25', label:'MKT · Navidad', type:'marketing'},
  {date:'2025-12-28', label:'MKT · Día de los Inocentes', type:'marketing'},
  {date:'2025-12-31', label:'MKT · Nochevieja', type:'marketing'},
  {date:'2026-01-01', label:'MKT · Año Nuevo', type:'marketing'},
  {date:'2026-01-04', label:'MKT · Braille', type:'marketing'},
  {date:'2026-01-06', label:'MKT · Reyes', type:'marketing'},
  {date:'2026-01-13', label:'MKT · Lucha contra la Depresión', type:'marketing'},
  {date:'2026-01-15', label:'MKT · Compositor', type:'marketing'},
  {date:'2026-01-16', label:'MKT · Croqueta', type:'marketing'},
  {date:'2026-01-18', label:'MKT · Nieve', type:'marketing'},
  {date:'2026-01-19', label:'MKT · Blue Monday / Palomitas', type:'marketing'},
  {date:'2026-01-21', label:'MKT · Mariachi / Abrazo', type:'marketing'},
  {date:'2026-01-24', label:'MKT · Cultura Africana y Afrodescendiente / Educación', type:'marketing'},
  {date:'2026-01-26', label:'MKT · Educación Ambiental / Community Manager', type:'marketing'},
  {date:'2026-01-27', label:'MKT · Tarta de Chocolate / Conservador-Restaurador', type:'marketing'},
  {date:'2026-01-28', label:'MKT · Protección de Datos / LEGO / Reducción de CO2', type:'marketing'},
  {date:'2026-01-30', label:'MKT · No Violencia y Paz (escolar) / Croissant', type:'marketing'},
  {date:'2026-01-31', label:'MKT · Mago', type:'marketing'},
  {date:'2026-02-02', label:'MKT · Marmota / Humedales', type:'marketing'},
  {date:'2026-02-04', label:'MKT · Cáncer', type:'marketing'},
  {date:'2026-02-05', label:'MKT · Constitución Mexicana / Nutella', type:'marketing'},
  {date:'2026-02-08', label:'MKT · Super Bowl', type:'marketing'},
  {date:'2026-02-09', label:'MKT · Pizza', type:'marketing'},
  {date:'2026-02-10', label:'MKT · Legumbres', type:'marketing'},
  {date:'2026-02-11', label:'MKT · Mujer y Niña en la Ciencia / Mujer Médica', type:'marketing'},
  {date:'2026-02-12', label:'MKT · Darwin', type:'marketing'},
  {date:'2026-02-13', label:'MKT · Soltero / Radio', type:'marketing'},
  {date:'2026-02-14', label:'MKT · San Valentín / Aniv. YouTube / Cine', type:'marketing'},
  {date:'2026-02-15', label:'MKT · Cáncer Infantil', type:'marketing'},
  {date:'2026-02-16', label:'MKT · Crush', type:'marketing'},
  {date:'2026-02-17', label:'MKT · Año Nuevo Chino / Inventor Mexicano / Juego Responsable', type:'marketing'},
  {date:'2026-02-19', label:'MKT · Contra la Homofobia en el Deporte', type:'marketing'},
  {date:'2026-02-20', label:'MKT · Amar a tu Mascota / Justicia Social', type:'marketing'},
  {date:'2026-02-24', label:'MKT · Bandera Mexicana', type:'marketing'},
  {date:'2026-02-26', label:'MKT · Pistacho', type:'marketing'},
  {date:'2026-02-27', label:'MKT · ONG', type:'marketing'},
  {date:'2026-02-28', label:'MKT · Enfermedades Raras', type:'marketing'},
  {date:'2026-03-01', label:'MKT · Cero Discriminación', type:'marketing'},
  {date:'2026-03-03', label:'MKT · Vida Silvestre', type:'marketing'},
  {date:'2026-03-05', label:'MKT · Abstinencia Digital', type:'marketing'},
  {date:'2026-03-08', label:'MKT · Día de la Mujer', type:'marketing'},
  {date:'2026-03-09', label:'MKT · DJ', type:'marketing'},
  {date:'2026-03-10', label:'MKT · Mario Bros.', type:'marketing'},
  {date:'2026-03-12', label:'MKT · Tuiteros', type:'marketing'},
  {date:'2026-03-15', label:'MKT · Derechos del Consumidor', type:'marketing'},
  {date:'2026-03-17', label:'MKT · San Patricio', type:'marketing'},
  {date:'2026-03-20', label:'MKT · Felicidad / Equinoccio de Primavera', type:'marketing'},
  {date:'2026-03-21', label:'MKT · Poesía / Síndrome de Down / Aniv. X (Twitter) / Tiramisú / Bosques / Natalicio B. Juárez', type:'marketing'},
  {date:'2026-03-22', label:'MKT · Agua', type:'marketing'},
  {date:'2026-03-23', label:'MKT · Meteorológico Mundial', type:'marketing'},
  {date:'2026-03-26', label:'MKT · Clima', type:'marketing'},
  {date:'2026-03-27', label:'MKT · Teatro / Queso', type:'marketing'},
  {date:'2026-03-28', label:'MKT · Hora del Planeta', type:'marketing'},
  {date:'2026-03-31', label:'MKT · Día del Taco', type:'marketing'},
  {date:'2026-04-02', label:'MKT · Autismo / Gelatina', type:'marketing'},
  {date:'2026-04-03', label:'MKT · Arcoíris', type:'marketing'},
  {date:'2026-04-06', label:'MKT · Actividad Física / Deporte para el Desarrollo y la Paz', type:'marketing'},
  {date:'2026-04-07', label:'MKT · Salud', type:'marketing'},
  {date:'2026-04-11', label:'MKT · Parkinson', type:'marketing'},
  {date:'2026-04-13', label:'MKT · Beso / Scrabble', type:'marketing'},
  {date:'2026-04-14', label:'MKT · Américas', type:'marketing'},
  {date:'2026-04-15', label:'MKT · Arte', type:'marketing'},
  {date:'2026-04-16', label:'MKT · Emprendimiento', type:'marketing'},
  {date:'2026-04-18', label:'MKT · Monumentos y Sitios', type:'marketing'},
  {date:'2026-04-19', label:'MKT · Los Simpson', type:'marketing'},
  {date:'2026-04-21', label:'MKT · Creatividad e Innovación', type:'marketing'},
  {date:'2026-04-22', label:'MKT · Tierra', type:'marketing'},
  {date:'2026-04-23', label:'MKT · Libro', type:'marketing'},
  {date:'2026-04-25', label:'MKT · Aniv. Metricool', type:'marketing'},
  {date:'2026-04-26', label:'MKT · Propiedad Intelectual', type:'marketing'},
  {date:'2026-04-27', label:'MKT · Diseño Gráfico', type:'marketing'},
  {date:'2026-04-28', label:'MKT · Seguridad y Salud en el Trabajo', type:'marketing'},
  {date:'2026-04-29', label:'MKT · Danza', type:'marketing'},
  {date:'2026-04-30', label:'MKT · Jazz / Niñas y Niños', type:'marketing'},
  {date:'2026-05-01', label:'MKT · Trabajo', type:'marketing'},
  {date:'2026-05-02', label:'MKT · Contra el Acoso Escolar', type:'marketing'},
  {date:'2026-05-03', label:'MKT · Libertad de Prensa / Risa', type:'marketing'},
  {date:'2026-05-04', label:'MKT · Star Wars', type:'marketing'},
  {date:'2026-05-05', label:'MKT · Aniv. LinkedIn', type:'marketing'},
  {date:'2026-05-08', label:'MKT · Cruz Roja', type:'marketing'},
  {date:'2026-05-09', label:'MKT · Aves Migratorias', type:'marketing'},
  {date:'2026-05-10', label:'MKT · Día de la Madre (MX)', type:'marketing'},
  {date:'2026-05-13', label:'MKT · Hummus', type:'marketing'},
  {date:'2026-05-15', label:'MKT · Familias / Maestro', type:'marketing'},
  {date:'2026-05-16', label:'MKT · Luz / Heavy Metal', type:'marketing'},
  {date:'2026-05-17', label:'MKT · Internet / IDAHOTB / Reciclaje / Repostería', type:'marketing'},
  {date:'2026-05-18', label:'MKT · Museos', type:'marketing'},
  {date:'2026-05-20', label:'MKT · Publicista', type:'marketing'},
  {date:'2026-05-21', label:'MKT · Diversidad Cultural / Té', type:'marketing'},
  {date:'2026-05-22', label:'MKT · Pac-Man', type:'marketing'},
  {date:'2026-05-23', label:'MKT · Estudiante', type:'marketing'},
  {date:'2026-05-25', label:'MKT · Orgullo Friki', type:'marketing'},
  {date:'2026-05-28', label:'MKT · Hamburguesa', type:'marketing'},
  {date:'2026-05-31', label:'MKT · Sin Tabaco', type:'marketing'},
  {date:'2026-06-01', label:'MKT · Madres y Padres / Arrecifes', type:'marketing'},
  {date:'2026-06-03', label:'MKT · Bicicleta / Running', type:'marketing'},
  {date:'2026-06-05', label:'MKT · Medio Ambiente', type:'marketing'},
  {date:'2026-06-08', label:'MKT · Océanos', type:'marketing'},
  {date:'2026-06-10', label:'MKT · LSM (Lengua de Señas Mexicana)', type:'marketing'},
  {date:'2026-06-14', label:'MKT · Donante de Sangre', type:'marketing'},
  {date:'2026-06-18', label:'MKT · Sushi', type:'marketing'},
  {date:'2026-06-20', label:'MKT · Yellow Day / Surf / Selfie / Yoga / Llevar al Perro al Trabajo', type:'marketing'},
  {date:'2026-06-21', label:'MKT · Día del Padre (MX) / Solsticio de Verano', type:'marketing'},
  {date:'2026-06-28', label:'MKT · Orgullo LGBTQIA+', type:'marketing'},
  {date:'2026-06-30', label:'MKT · Redes Sociales', type:'marketing'},
  {date:'2026-07-01', label:'MKT · Chiste / Reggae', type:'marketing'},
  {date:'2026-07-02', label:'MKT · OVNI', type:'marketing'},
  {date:'2026-07-03', label:'MKT · Libre de Bolsas de Plástico', type:'marketing'},
  {date:'2026-07-04', label:'MKT · eBook', type:'marketing'},
  {date:'2026-07-05', label:'MKT · Bikini', type:'marketing'},
  {date:'2026-07-07', label:'MKT · Cacao', type:'marketing'},
  {date:'2026-07-08', label:'MKT · Alergia', type:'marketing'},
  {date:'2026-07-09', label:'MKT · Árbol', type:'marketing'},
  {date:'2026-07-11', label:'MKT · Población', type:'marketing'},
  {date:'2026-07-13', label:'MKT · Rock', type:'marketing'},
  {date:'2026-07-17', label:'MKT · Emoji', type:'marketing'},
  {date:'2026-07-18', label:'MKT · Nelson Mandela', type:'marketing'},
  {date:'2026-07-19', label:'MKT · Iberoamérica', type:'marketing'},
  {date:'2026-07-20', label:'MKT · Luna / Ajedrez', type:'marketing'},
  {date:'2026-07-21', label:'MKT · Perro', type:'marketing'},
  {date:'2026-07-22', label:'MKT · Cerebro', type:'marketing'},
  {date:'2026-07-24', label:'MKT · Tequila', type:'marketing'},
  {date:'2026-07-30', label:'MKT · Amistad / Contra la Trata', type:'marketing'},
  {date:'2026-07-31', label:'MKT · Aguacate', type:'marketing'},
  {date:'2026-08-07', label:'MKT · Cerveza', type:'marketing'},
  {date:'2026-08-08', label:'MKT · Gato', type:'marketing'},
  {date:'2026-08-09', label:'MKT · Coworking', type:'marketing'},
  {date:'2026-08-10', label:'MKT · León', type:'marketing'},
  {date:'2026-08-12', label:'MKT · Disco de Vinilo / Juventud', type:'marketing'},
  {date:'2026-08-13', label:'MKT · Zurdos', type:'marketing'},
  {date:'2026-08-15', label:'MKT · Relajación', type:'marketing'},
  {date:'2026-08-17', label:'MKT · Peatón', type:'marketing'},
  {date:'2026-08-19', label:'MKT · Fotografía / Asistencia Humanitaria', type:'marketing'},
  {date:'2026-08-22', label:'MKT · Folclore', type:'marketing'},
  {date:'2026-08-23', label:'MKT · Hashtag / Internauta', type:'marketing'},
  {date:'2026-08-26', label:'MKT · Actriz y Actor', type:'marketing'},
  {date:'2026-08-28', label:'MKT · Abuelos', type:'marketing'},
  {date:'2026-08-29', label:'MKT · Gamer', type:'marketing'},
  {date:'2026-08-31', label:'MKT · Blog', type:'marketing'},
  {date:'2026-09-04', label:'MKT · Taekwondo', type:'marketing'},
  {date:'2026-09-05', label:'MKT · Hermano', type:'marketing'},
  {date:'2026-09-13', label:'MKT · Programadores / Chocolate', type:'marketing'},
  {date:'2026-09-16', label:'MKT · Independencia de México', type:'marketing'},
  {date:'2026-09-18', label:'MKT · Igualdad Salarial', type:'marketing'},
  {date:'2026-09-19', label:'MKT · Playas', type:'marketing'},
  {date:'2026-09-21', label:'MKT · Alzheimer', type:'marketing'},
  {date:'2026-09-22', label:'MKT · Equinoccio de Otoño / Día Mundial Sin Coche', type:'marketing'},
  {date:'2026-09-23', label:'MKT · Lenguas de Señas (ONU)', type:'marketing'},
  {date:'2026-09-24', label:'MKT · Investigación contra el Cáncer', type:'marketing'},
  {date:'2026-09-27', label:'MKT · Aniv. Google / Turismo / Personas Sordas', type:'marketing'},
  {date:'2026-09-29', label:'MKT · Corazón', type:'marketing'},
  {date:'2026-09-30', label:'MKT · Pódcast', type:'marketing'},
  {date:'2026-10-01', label:'MKT · Café / Personas Mayores', type:'marketing'},
  {date:'2026-10-02', label:'MKT · No Violencia', type:'marketing'},
  {date:'2026-10-03', label:'MKT · Sonrisa', type:'marketing'},
  {date:'2026-10-04', label:'MKT · Animales / Hábitat / Docentes', type:'marketing'},
  {date:'2026-10-06', label:'MKT · Aniv. Instagram', type:'marketing'},
  {date:'2026-10-09', label:'MKT · Huevo', type:'marketing'},
  {date:'2026-10-10', label:'MKT · Salud Mental / Mejor Amigo', type:'marketing'},
  {date:'2026-10-11', label:'MKT · Niña', type:'marketing'},
  {date:'2026-10-17', label:'MKT · Erradicación de la Pobreza', type:'marketing'},
  {date:'2026-10-19', label:'MKT · Cáncer de Mama', type:'marketing'},
  {date:'2026-10-20', label:'MKT · Chef', type:'marketing'},
  {date:'2026-10-21', label:'MKT · Ahorro de Energía', type:'marketing'},
  {date:'2026-10-24', label:'MKT · Contra el Cambio Climático', type:'marketing'},
  {date:'2026-10-25', label:'MKT · Pasta', type:'marketing'},
  {date:'2026-10-28', label:'MKT · Animación', type:'marketing'},
  {date:'2026-10-31', label:'MKT · Halloween / Ciudades', type:'marketing'},
  {date:'2026-11-01', label:'MKT · Todos los Santos / Veganismo', type:'marketing'},
  {date:'2026-11-02', label:'MKT · Día de Muertos', type:'marketing'},
  {date:'2026-11-03', label:'MKT · Sándwich / Reservas de la Biosfera', type:'marketing'},
  {date:'2026-11-04', label:'MKT · Marketing / UNESCO', type:'marketing'},
  {date:'2026-11-10', label:'MKT · Ciencia para la Paz y el Desarrollo', type:'marketing'},
  {date:'2026-11-12', label:'MKT · Libro (MX)', type:'marketing'},
  {date:'2026-11-13', label:'MKT · Bondad', type:'marketing'},
  {date:'2026-11-16', label:'MKT · Gastronomía Mexicana / Flamenco', type:'marketing'},
  {date:'2026-11-19', label:'MKT · Mujer Emprendedora', type:'marketing'},
  {date:'2026-11-20', label:'MKT · Revolución Mexicana', type:'marketing'},
  {date:'2026-11-21', label:'MKT · Televisión / Pesca', type:'marketing'},
  {date:'2026-11-27', label:'MKT · Black Friday', type:'marketing'},
  {date:'2026-11-30', label:'MKT · Día del Influencer / Cyber Monday', type:'marketing'},
  {date:'2026-12-01', label:'MKT · Lucha contra el SIDA', type:'marketing'},
  {date:'2026-12-02', label:'MKT · Abolición de la Esclavitud / Futuros', type:'marketing'},
  {date:'2026-12-03', label:'MKT · Cine 3D / Personas con Discapacidad', type:'marketing'},
  {date:'2026-12-05', label:'MKT · Voluntariado', type:'marketing'},
  {date:'2026-12-07', label:'MKT · Algodón de Azúcar', type:'marketing'},
  {date:'2026-12-09', label:'MKT · Informática / Contra la Corrupción', type:'marketing'},
  {date:'2026-12-10', label:'MKT · Derechos Humanos / Derechos de los Animales', type:'marketing'},
  {date:'2026-12-11', label:'MKT · Montañas', type:'marketing'},
  {date:'2026-12-18', label:'MKT · Migrante', type:'marketing'},
  {date:'2026-12-20', label:'MKT · Solidaridad Humana', type:'marketing'},
  {date:'2026-12-21', label:'MKT · Cultura Maya (MX) / Solsticio de Invierno', type:'marketing'},
  {date:'2026-12-24', label:'MKT · Nochebuena', type:'marketing'},
  {date:'2026-12-25', label:'MKT · Navidad', type:'marketing'},
  {date:'2026-12-28', label:'MKT · Día de los Inocentes', type:'marketing'},
  {date:'2026-12-31', label:'MKT · Nochevieja', type:'marketing'}
];
const CAL_NOTES_KEY='bm_calendar_notes_v1';
const marketingCalendar={
  month:new Date().getMonth(),
  year:new Date().getFullYear(),
  notes:{},
  _ready:false,
  filterType:'todos',
  loadNotes(){
    try{ return JSON.parse(localStorage.getItem(CAL_NOTES_KEY)||'{}')||{}; }catch(e){ return{}; }
  },
  saveNotes(){ localStorage.setItem(CAL_NOTES_KEY, JSON.stringify(this.notes)); },
  setFilter(type='todos'){
    this.filterType=type;
    this.render();
  },
  applyFilter(events){
    if(this.filterType==='todos') return events;
    return events.filter(ev=> (ev.type||'')===this.filterType);
  },
  goto(year, month){
    this.year=year;
    this.month=month;
    this.render();
  },
  today(){
    const now=new Date();
    this.goto(now.getFullYear(), now.getMonth());
  },
  init(){
    if(!document.getElementById('calendar-grid')) return;
    if(!this._ready){
      this.notes=this.loadNotes();
      this._ready=true;
    }
    this._agendaCache = (LocalDB.get('agenda_items')||[]).filter(it=> it && it.fecha);
    const filter=document.getElementById('calendar-filter');
    if(filter && filter.value && filter.value!==this.filterType) this.filterType=filter.value;
    this.render();
  },
  prev(){
    const month=this.month===0? 11 : this.month-1;
    const year=this.month===0? this.year-1 : this.year;
    this.goto(year, month);
  },
  next(){
    const month=this.month===11? 0 : this.month+1;
    const year=this.month===11? this.year+1 : this.year;
    this.goto(year, month);
  },
  eventsFor(dateIso){
    const md=dateIso.slice(5);
    const baseEvents=CAL_STATIC_EVENTS.filter(ev=> ev.md===md).map(ev=>({...ev}));
    const datedEvents=CAL_MARKETING_EVENTS.filter(ev=> ev.date===dateIso).map(ev=>({...ev}));
    const evs=[...baseEvents, ...datedEvents];
    if(this.notes[dateIso]) evs.push({label:this.notes[dateIso], type:'nota'});
    const agenda=(this._agendaCache||[]).filter(it=> it.fecha===dateIso);
    agenda.forEach(it=> evs.push({label:`Agenda: ${it.titulo||it.notas||'Evento'}`, type:'agenda'}));
    return evs;
  },
  render(){
    const grid=document.getElementById('calendar-grid'); const label=document.getElementById('calendar-label');
    if(!grid || !label) return;
    const filterSelect=document.getElementById('calendar-filter');
    if(filterSelect && filterSelect.value!==this.filterType) filterSelect.value=this.filterType;
    grid.innerHTML='';
    const weekDays=['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
    weekDays.forEach(d=>{
      const head=document.createElement('div');
      head.className='calendar-head';
      head.textContent=d;
      grid.appendChild(head);
    });
    const first=new Date(this.year, this.month, 1);
    const start=(first.getDay()+6)%7;
    for(let i=0;i<start;i++){
      const empty=document.createElement('div');
      empty.className='calendar-day empty';
      grid.appendChild(empty);
    }
    const daysInMonth=new Date(this.year, this.month+1, 0).getDate();
    const today=todayISO();
    for(let day=1; day<=daysInMonth; day++){
      const iso=`${this.year}-${String(this.month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const cell=document.createElement('div');
      cell.className='calendar-day';
      if(iso===today) cell.classList.add('today');
      const events=this.eventsFor(iso);
      const filtered=this.applyFilter(events);
      if(filtered.some(ev=> ev.type==='oficial')) cell.classList.add('official');
      if(filtered.some(ev=> ev.type==='marketing')) cell.classList.add('marketing');
      if(filtered.some(ev=> ev.type==='agenda')) cell.classList.add('agenda');
      if(!filtered.length && this.filterType!=='todos' && events.length) cell.classList.add('filtered-out');
      cell.title = events.length? events.map(ev=>ev.label).join('\n') : 'Haz clic para agregar nota';
      const dateSpan=document.createElement('span');
      dateSpan.className='date';
      dateSpan.textContent=day;
      cell.appendChild(dateSpan);
      const eventsWrap=document.createElement('div');
      eventsWrap.className='events';
      if(filtered.length){
        filtered.forEach(ev=>{
          const span=document.createElement('span');
          span.className='event-tag'+(ev.type?` ${ev.type}`:'');
          span.textContent=ev.label;
          eventsWrap.appendChild(span);
        });
      } else if(events.length){
        const span=document.createElement('span');
        span.className='event-tag muted';
        span.textContent='Sin eventos del filtro';
        eventsWrap.appendChild(span);
      } else {
        const span=document.createElement('span');
        span.className='event-tag muted';
        span.textContent='Agregar nota';
        eventsWrap.appendChild(span);
      }
      cell.appendChild(eventsWrap);
      cell.addEventListener('click', ()=> marketingCalendar.addNote(iso));
      grid.appendChild(cell);
    }
    label.textContent = new Intl.DateTimeFormat('es-MX',{month:'long',year:'numeric'}).format(new Date(this.year, this.month, 1));
  },
  addNote(iso){
    const current=this.notes[iso]||'';
    const note=prompt(`Nota para ${iso}`, current);
    if(note===null) return;
    if(note.trim()){ this.notes[iso]=note.trim(); }
    else { delete this.notes[iso]; }
    this.saveNotes();
    this.render();
  },
  nextEvent(referenceDate){
    const ref = referenceDate? new Date(referenceDate): new Date();
    ref.setHours(0,0,0,0);
    const year=ref.getFullYear();
    const baseList=CAL_STATIC_EVENTS.map(ev=>{
      const [m,d]=ev.md.split('-').map(Number);
      let date=new Date(year, m-1, d);
      if(date<ref) date=new Date(year+1, m-1, d);
      return {...ev, date};
    });
    const datedList=CAL_MARKETING_EVENTS.map(ev=>({
      ...ev,
      date:new Date(`${ev.date}T00:00:00`)
    })).filter(ev=> ev.date >= ref);
    const list=[...baseList, ...datedList].filter(ev=> ev.date>=ref).sort((a,b)=> a.date-b.date);
    return list[0] || null;
  }
};

// BMC: Config
let cfg={iva:16, margen:60, decimales:2, alertas:7, modo:'local', saldoIniEfectivo:0, saldoIniBanco:0, cierreHora:22}; // persisted in LocalDB (cierre 22:00 CDMX)

// BMC: Simple LocalDB wrapper over localStorage
const LocalDB={
  ns:'bm_',
  key:(c)=> LocalDB.ns+c,
  get:(c)=> JSON.parse(localStorage.getItem(LocalDB.key(c))||'[]'),
  set:(c,arr)=>{ localStorage.setItem(LocalDB.key(c), JSON.stringify(arr||[])); invalidateCaches(); },
  list:(c)=> LocalDB.get(c),
  byId:(c,id)=> LocalDB.get(c).find(x=>x.id===id),
  create:(c,obj)=>{const arr=LocalDB.get(c); arr.push(obj); LocalDB.set(c,arr); return obj},
  update:(c,id,patch)=>{const arr=LocalDB.get(c); const i=arr.findIndex(x=>x.id===id); if(i>-1){arr[i]={...arr[i],...patch}; LocalDB.set(c,arr);return arr[i]}},
  remove:(c,id)=>{LocalDB.set(c, LocalDB.get(c).filter(x=>x.id!==id))},
  listBy:(c,pred)=> LocalDB.get(c).filter(pred),
  clearAll:()=>{
    Object.keys(localStorage).filter(k=>k.startsWith(LocalDB.ns)).forEach(k=>localStorage.removeItem(k));
    invalidateCaches();
    notify('Datos borrados');
    const reload=()=> location.reload();
    const pending=(typeof RemoteSync!=='undefined' && RemoteSync.flushNow)? RemoteSync.flushNow() : null;
    if(pending && typeof pending.then==='function'){ pending.then(reload).catch(reload); }
    else { reload(); }
  }
};

// ABC: Activity Based Costing (costos fijos mensuales prorrateados por minuto productivo)
const abc={
  key:()=> LocalDB.key('abc'),
  load(){ try{ return JSON.parse(localStorage.getItem(this.key())||'{}')||{} }catch(e){ return {} } },
  save(cfg){ localStorage.setItem(this.key(), JSON.stringify(cfg||{})); notify('Costos ABC actualizados','success'); recetasCalcularCosto(true); renderABCConfig(); renderBreakevenCard(); },
  total(){
    const c=this.load();
    const base=(Number(c.luz)||0)+(Number(c.nominas)||0)+(Number(c.renta)||0)+(Number(c.internet)||0)+(Number(c.otros)||0)+(Number(c.agenciaMarketing)||0)+(Number(c.pautas)||0);
    const extra=(Array.isArray(c.items)? c.items.reduce((a,x)=> a+Number(x.monto||0),0):0);
    return base+extra;
  },
  rate(){ const total=this.total(); const c=this.load(); const min=Number(c.minutos)||0; return min>0? (total/min) : 0; },
  breakeven(){
    const fixed=this.total();
    const margin=Math.max(0, Number(cfg.margen||0)/100);
    const salesNeeded = margin>0? fixed / margin : 0;
    const tickets=Data.get(Data.col.ventas_ticket)||[];
    const totalVentas=tickets.reduce((s,t)=> s+Number(t.total||0),0);
    const avgTicket=tickets.length? totalVentas/tickets.length : 0;
    const ticketsNecesarios = avgTicket>0? salesNeeded/avgTicket : 0;
    const dias=new Set(tickets.map(t=> (t.fechaHora||'').slice(0,10)).filter(Boolean));
    const promDiario = dias.size? totalVentas/dias.size : 0;
    const diasNecesarios = promDiario>0? salesNeeded/promDiario : 0;
    return {fixed,salesNeeded,avgTicket,ticketsNecesarios,promDiario,diasNecesarios,totalVentas};
  }
};

function renderABCConfig(){
  const el=document.getElementById('abc-config-card'); if(!el) return; const c=abc.load(); const rate=abc.rate();
  const items=(Array.isArray(c.items)? c.items : []);
  const rowsHTML = items.map((it,i)=>`<tr>
      <td><input class='abc-item-name' value="${(it.nombre||'')}"></td>
      <td><input type='number' step='0.01' min='0' class='abc-item-amt' value='${Number(it.monto||0)}'></td>
      <td><button class='btn' onclick='this.closest("tr").remove(); (window._abcUpd&&_abcUpd())'>✕</button></td>
    </tr>`).join('');
  el.innerHTML=`
    <h3>Costos Fijos Mensuales (ABC)</h3>
    <div class="row">
      <label>Luz<input type="number" id="abc-luz" step="0.01" min="0" value="${c.luz||0}"></label>
      <label>Nóminas<input type="number" id="abc-nominas" step="0.01" min="0" value="${c.nominas||0}"></label>
      <label>Renta<input type="number" id="abc-renta" step="0.01" min="0" value="${c.renta||0}"></label>
      <label>Internet<input type="number" id="abc-internet" step="0.01" min="0" value="${c.internet||0}"></label>
      <label>Agencia marketing<input type="number" id="abc-agencia" step="0.01" min="0" value="${c.agenciaMarketing||0}"></label>
      <label>Gastos en pautas<input type="number" id="abc-pautas" step="0.01" min="0" value="${c.pautas||0}"></label>
      <label>Otros<input type="number" id="abc-otros" step="0.01" min="0" value="${c.otros||0}"></label>
      <label>Minutos productivos/mes<input type="number" id="abc-min" step="1" min="1" value="${c.minutos||10000}"></label>
    </div>
    <div class="card" style="margin-top:8px">
      <h3>Otros costos (personalizados)</h3>
      <table class='table' id='abc-items'>
        <thead><tr><th>Concepto</th><th>Monto mensual</th><th></th></tr></thead>
        <tbody>${rowsHTML || ''}</tbody>
      </table>
      <div class='toolbar'>
        <button class='btn' id='abc-add-item-btn'>Agregar costo</button>
      </div>
    </div>
    <div class="toolbar">
      <span class="muted">Tarifa por minuto: <strong id='abc-rate'>${fmt.money(rate)}</strong></span>
      <button class="btn" onclick="(function(){
        const cfg={
          luz:Number(document.getElementById('abc-luz').value||0),
          nominas:Number(document.getElementById('abc-nominas').value||0),
          renta:Number(document.getElementById('abc-renta').value||0),
          internet:Number(document.getElementById('abc-internet').value||0),
          agenciaMarketing:Number(document.getElementById('abc-agencia').value||0),
          pautas:Number(document.getElementById('abc-pautas').value||0),
          otros:Number(document.getElementById('abc-otros').value||0),
          minutos:Number(document.getElementById('abc-min').value||0),
          items:[...document.querySelectorAll('#abc-items tbody tr')].map(tr=>({nombre:tr.querySelector('.abc-item-name')?.value||'', monto:Number(tr.querySelector('.abc-item-amt')?.value||0)}))
        };
        abc.save(cfg);
      })()">Actualizar ABC</button>
    </div>
    <small class="muted">Define costos fijos mensuales y los minutos productivos del mes. Puedes añadir conceptos personalizados. Se prorratean por minuto y por el tiempo invertido en cada receta.</small>
  `;
  window._abcUpd = debounce(()=>{
    const c2={
      luz:Number(document.getElementById('abc-luz')?.value||0),
      nominas:Number(document.getElementById('abc-nominas')?.value||0),
      renta:Number(document.getElementById('abc-renta')?.value||0),
      internet:Number(document.getElementById('abc-internet')?.value||0),
      agenciaMarketing:Number(document.getElementById('abc-agencia')?.value||0),
      pautas:Number(document.getElementById('abc-pautas')?.value||0),
      otros:Number(document.getElementById('abc-otros')?.value||0),
      minutos:Number(document.getElementById('abc-min')?.value||0),
      items:[...document.querySelectorAll('#abc-items tbody tr')].map(tr=>({nombre:tr.querySelector('.abc-item-name')?.value||'', monto:Number(tr.querySelector('.abc-item-amt')?.value||0)}))
    };
    const total=c2.luz+c2.nominas+c2.renta+c2.internet+c2.otros + c2.items.reduce((a,x)=>a+Number(x.monto||0),0);
    const min=c2.minutos||1; const r=total/min; const span=el.querySelector('#abc-rate'); if(span) span.textContent=fmt.money(r); recetas.recalcCosteo?.();
  }, 150);
  ['abc-luz','abc-nominas','abc-renta','abc-internet','abc-agencia','abc-pautas','abc-otros','abc-min'].forEach(id=> document.getElementById(id)?.addEventListener('input', window._abcUpd));
  el.querySelectorAll('#abc-items input')?.forEach(inp=> inp.addEventListener('input', window._abcUpd));
  // Handler: agregar fila ABC
  const addBtn=el.querySelector('#abc-add-item-btn');
  if(addBtn){
    addBtn.addEventListener('click', ()=>{
      const tb=el.querySelector('#abc-items tbody'); if(!tb) return;
      const tr=document.createElement('tr');
      tr.innerHTML = "<td><input class='abc-item-name' placeholder='Concepto'></td>"+
        "<td><input class='abc-item-amt' type='number' step='0.01' min='0' value='0'></td>"+
        "<td><button class='btn abc-item-del'>✕</button></td>";
      tb.appendChild(tr);
      tr.querySelectorAll('input').forEach(inp=> inp.addEventListener('input', window._abcUpd));
      tr.querySelector('.abc-item-del')?.addEventListener('click', (e)=>{ e.preventDefault(); tr.remove(); window._abcUpd&&window._abcUpd(); });
      window._abcUpd&&window._abcUpd();
    });
  }
}

function renderBreakevenCard(){
  const el=document.getElementById('abc-breakeven'); if(!el) return;
  const data=abc.breakeven();
  const fmtNum=(n)=> Number(n||0).toFixed(0);
  el.innerHTML=`
    <h3>Punto de equilibrio mensual</h3>
    <div class="card-grid">
      <div class="card"><h3>Costos fijos</h3><div class="big">${fmt.money(data.fixed)}</div></div>
      <div class="card"><h3>Ventas necesarias</h3><div class="big">${fmt.money(data.salesNeeded)}</div></div>
      <div class="card"><h3>Boleto promedio</h3><div class="big">${data.avgTicket?fmt.money(data.avgTicket):'—'}</div></div>
      <div class="card"><h3>Tickets requeridos</h3><div class="big">${data.avgTicket?fmtNum(data.ticketsNecesarios):'—'}</div></div>
      <div class="card"><h3>Días estimados</h3><div class="big">${data.promDiario?fmtNum(data.diasNecesarios):'—'}</div></div>
      <div class="card"><h3>Ventas actuales</h3><div class="big">${fmt.money(data.totalVentas)}</div></div>
    </div>
    <canvas id="chart-breakeven" style="margin-top:12px;height:220px"></canvas>
    <small class="muted">Calculado con el margen objetivo (${cfg.margen}%). Ajusta los costos ABC para escenarios más precisos.</small>
  `;
  const achieved=Math.min(data.totalVentas, data.salesNeeded);
  drawDonut('chart-breakeven',
    ['Progreso','Pendiente'],
    [achieved, Math.max(0,data.salesNeeded-achieved)],
    ['#10B981','#F97316']);
}

// BMC: Data layer (abstrae LocalDB; futuro modo API)
const Data={
  col:{
    ventas_ticket:'ventas_ticket', ventas_detalle:'ventas_detalle', recetas:'recetas', recetas_ingredientes:'recetas_ingredientes',
    insumos:'insumos', kardex:'kardex', compras:'compras', compras_detalle:'compras_detalle', gastos:'gastos', ajustes:'ajustes', cortes:'cortes',
    proveedores:'proveedores', estaciones:'estaciones', empleados:'empleados', clientes:'clientes', nominas:'nominas', insumos_costeo:'insumos_costeo'
  },
  get:(c)=> LocalDB.get(c),
  add:(c,obj)=> LocalDB.create(c,{id:uid(),...obj}),
  upd:(c,id,patch)=> LocalDB.update(c,id,patch),
  del:(c,id)=> LocalDB.remove(c,id),
  // Convenience: filter by predicate (mirror LocalDB.listBy)
  listBy:(c,pred)=> LocalDB.listBy(c,pred)
};

// BMC: CSV export util
function toCSV(rows){if(!rows||!rows.length) return ''; const cols=[...new Set(rows.flatMap(r=>Object.keys(r)))]; const esc=v=>`"${String(v??'').replaceAll('"','""')}"`; return [cols.join(','),...rows.map(r=>cols.map(c=>esc(r[c])).join(','))].join('\n');}
const download=(name,content,type='text/csv')=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type}));a.download=name;a.click();URL.revokeObjectURL(a.href)}

/*****************
 * BMC: Seed Data *
 *****************/
function seedEjemplo(){
  if(Data.get(Data.col.insumos).length){notify('Seed ya cargado'); return}
  // Insumos
  const ins=[
    {nombre:'Café espresso', unidad:'g', costoPromedio:0.4, existencia:2000, min:300, max:3000},
    {nombre:'Leche entera', unidad:'ml', costoPromedio:0.02, existencia:5000, min:1000, max:10000},
    {nombre:'Jarabe vainilla', unidad:'ml', costoPromedio:0.08, existencia:2000, min:300, max:3000},
    {nombre:'Vaso 12oz', unidad:'unid', costoPromedio:2.5, existencia:200, min:100, max:1000},
    {nombre:'Tapa 12oz', unidad:'unid', costoPromedio:0.8, existencia:200, min:100, max:1000}
  ]; ins.forEach(x=>Data.add(Data.col.insumos,x));
  // Estaciones, empleados, proveedor
  Data.add(Data.col.estaciones,{nombre:'Barra 1'}); Data.add(Data.col.estaciones,{nombre:'Máquina 1'});
  Data.add(Data.col.empleados,{nombre:'Antonio',rol:'Barista',sueldoHora:0,agradecimiento:'Gracias por tu excelente trabajo esta semana.',horario:null}); Data.add(Data.col.empleados,{nombre:'Elisa',rol:'Barista',sueldoHora:0,agradecimiento:'Gracias por tu excelente trabajo esta semana.',horario:null});
  const prov=Data.add(Data.col.proveedores,{nombre:'Proveedor Café',contacto:'ventas@proveedor.com'});
  // Recetas
  const rLatte=Data.add(Data.col.recetas,{nombre:'Latte',porciones:1,tiempoPrepMin:3,manoObraLote:0.8,gastoOperMensual:3000,margenObj:60,precioSugerido:0,notas:''});
  ;[{recetaId:rLatte.id,insumo:'Café espresso',cantidad:18,unidad:'g',costoUnit:0.4},{recetaId:rLatte.id,insumo:'Leche entera',cantidad:240,unidad:'ml',costoUnit:0.02},{recetaId:rLatte.id,insumo:'Vaso 12oz',cantidad:1,unidad:'unid',costoUnit:2.5},{recetaId:rLatte.id,insumo:'Tapa 12oz',cantidad:1,unidad:'unid',costoUnit:0.8}]
  .forEach(i=>Data.add(Data.col.recetas_ingredientes,{recetaId:i.recetaId,insumoId: Data.get(Data.col.insumos).find(x=>x.nombre===i.insumo).id, nombre:i.insumo,cantidad:i.cantidad,unidad:i.unidad,costoUnit:i.costoUnit}));
  const rEsp=Data.add(Data.col.recetas,{nombre:'Espresso',porciones:1,tiempoPrepMin:2,manoObraLote:0.5,gastoOperMensual:3000,margenObj:60,precioSugerido:0,notas:''});
  ;[{recetaId:rEsp.id,insumo:'Café espresso',cantidad:18,unidad:'g',costoUnit:0.4}]
  .forEach(i=>Data.add(Data.col.recetas_ingredientes,{recetaId:i.recetaId,insumoId: Data.get(Data.col.insumos).find(x=>x.nombre===i.insumo).id, nombre:i.insumo,cantidad:i.cantidad,unidad:i.unidad,costoUnit:i.costoUnit}));
  const rCap=Data.add(Data.col.recetas,{nombre:'Capuccino',porciones:1,tiempoPrepMin:3,manoObraLote:0.7,gastoOperMensual:3000,margenObj:60,precioSugerido:0,notas:''});
  ;[{recetaId:rCap.id,insumo:'Café espresso',cantidad:18,unidad:'g',costoUnit:0.4},{recetaId:rCap.id,insumo:'Leche entera',cantidad:180,unidad:'ml',costoUnit:0.02},{recetaId:rCap.id,insumo:'Vaso 12oz',cantidad:1,unidad:'unid',costoUnit:2.5},{recetaId:rCap.id,insumo:'Tapa 12oz',cantidad:1,unidad:'unid',costoUnit:0.8}]
  .forEach(i=>Data.add(Data.col.recetas_ingredientes,{recetaId:i.recetaId,insumoId: Data.get(Data.col.insumos).find(x=>x.nombre===i.insumo).id, nombre:i.insumo,cantidad:i.cantidad,unidad:i.unidad,costoUnit:i.costoUnit}));
  // Una compra ejemplo
  const comp=Data.add(Data.col.compras,{fechaHora:new Date().toISOString(),proveedorId:prov.id,metodoPago:'Transferencia',folio:'A001',total:1500});
  ;[
    {compraId:comp.id,insumo:'Café espresso',cantidad:1000,unidad:'g',costoUnit:0.4,subtotal:400},
    {compraId:comp.id,insumo:'Leche entera',cantidad:3000,unidad:'ml',costoUnit:0.02,subtotal:60},
    {compraId:comp.id,insumo:'Vaso 12oz',cantidad:200,unidad:'unid',costoUnit:2.5,subtotal:500},
    {compraId:comp.id,insumo:'Tapa 12oz',cantidad:200,unidad:'unid',costoUnit:0.8,subtotal:160}
  ].forEach(it=>{
    const ins=Data.get(Data.col.insumos).find(x=>x.nombre===it.insumo);
    Data.add(Data.col.compras_detalle,{compraId:comp.id,insumoId:ins.id,nombre:it.insumo,cantidad:it.cantidad,unidad:it.unidad,costoUnit:it.costoUnit,subtotal:it.subtotal});
    // Kardex + existencias
    Data.add(Data.col.kardex,{fechaHora:new Date().toISOString(),insumoId:ins.id,tipo:'entrada',cantidad:it.cantidad,costoUnit:it.costoUnit,ref:comp.folio,notas:'Compra seed'});
    LocalDB.update(Data.col.insumos, ins.id, {existencia:(ins.existencia||0)+it.cantidad,costoPromedio:it.costoUnit});
  });
  // Un ticket ejemplo
  const est=Data.get(Data.col.estaciones)[0], bar=Data.get(Data.col.empleados)[0];
  const t=Data.add(Data.col.ventas_ticket,{fechaHora:new Date().toISOString(),folio:'T001',clienteId:null,estacionId:est.id,baristaId:bar.id,subtotal:80,impuestos:12.8,propina:0,descuento:0,total:92.8,metodoPago:'Efectivo'});
  Data.add(Data.col.ventas_detalle,{ticketId:t.id,sku:'LAT',productoId:null,descripcion:'Latte',cantidad:1,precioUnit:80,subtotal:80});
  notify('Seed de ejemplo cargado','success');
  renderAll();
}

/****************
 * BMC: Ventas  *
 ****************/
const ventas={
  nuevoTicket(){
    const el=document.getElementById('venta-form'); el.classList.remove('hidden');
    const estaciones=Data.get(Data.col.estaciones), baristas=Data.get(Data.col.empleados);
    const now=new Date().toISOString().slice(0,16);
    el.innerHTML=`
      <div class="row">
        <label>Folio<input id="v-folio" placeholder="Folio"></label>
        <label>Fecha/Hora<input type="datetime-local" id="v-fecha" value="${now}"></label>
        <label class="grow">Estación<select id="v-est">${estaciones.map(s=>`<option value="${s.id}">${s.nombre}</option>`).join('')}</select></label>
        <label class="grow">Barista<select id="v-bar">${baristas.map(s=>`<option value="${s.id}">${s.nombre}</option>`).join('')}</select></label>
        <label>Método<select id="v-met">${METHODS.concat(['Mixto']).map(m=>`<option>${m}</option>`).join('')}</select></label>
        <label>Propina<input id="v-prop" type="number" min="0" step="0.01" value="0"></label>
        <label>Descuento<input id="v-desc" type="number" min="0" step="0.01" value="0"></label>
      </div>
      <div class="card">
        <table class="table" id="tbl-lineas"><thead><tr><th>SKU/Desc</th><th>Cantidad</th><th>Precio Unit</th><th>Subtotal</th><th></th></tr></thead><tbody></tbody></table>
        <div class="toolbar"><button class="btn" onclick="ventas.agregarLinea()">Agregar línea</button></div>
        <div class="row">
          <div class="grow"></div>
          <div style="min-width:260px">
            <div class="kpi"><small>Subtotal</small><strong id="v-subt">$0.00</strong></div>
            <div class="kpi"><small>Impuestos (${cfg.iva}%)</small><strong id="v-imp">$0.00</strong></div>
            <div class="kpi"><small>Total</small><strong id="v-tot">$0.00</strong></div>
          </div>
        </div>
      </div>
      <div class="toolbar"><button class="btn primary" onclick="ventas.guardar()">Guardar ticket</button> <button class="btn ghost" onclick="document.getElementById('venta-form').classList.add('hidden')">Cerrar</button></div>
    `;
    document.querySelector('#tbl-lineas tbody').innerHTML='';
    ventas.agregarLinea();
  },
  agregarLinea(){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input placeholder="SKU o descripción"></td>
      <td><input type="number" min="1" step="1" value="1"></td>
      <td><input type="number" min="0" step="0.01" value="0"></td>
      <td class="sub">$0.00</td>
      <td><button class="btn" onclick="this.closest('tr').remove(); ventas.recalcular()">✕</button></td>`;
    document.querySelector('#tbl-lineas tbody').appendChild(tr);
    ['input','change'].forEach(ev=>tr.addEventListener(ev, ventas.recalcular));
    ventas.recalcular();
  },
  recalcular(){
    let subt=0; document.querySelectorAll('#tbl-lineas tbody tr').forEach(tr=>{
      const qty=Number(tr.children[1].querySelector('input').value||0);
      const pu=Number(tr.children[2].querySelector('input').value||0);
      const s=qty*pu; tr.querySelector('.sub').textContent=fmt.money(s); subt+=s;
    });
    const imp=subt*(cfg.iva/100); const tot=subt+imp+Number(document.getElementById('v-prop').value||0)-Number(document.getElementById('v-desc').value||0);
    document.getElementById('v-subt').textContent=fmt.money(subt);
    document.getElementById('v-imp').textContent=fmt.money(imp);
    document.getElementById('v-tot').textContent=fmt.money(tot);
  },
  guardar(){
    const folio=document.getElementById('v-folio').value.trim();
    const fecha=new Date(document.getElementById('v-fecha').value||new Date()).toISOString();
    const est=document.getElementById('v-est').value; const bar=document.getElementById('v-bar').value;
    const met=document.getElementById('v-met').value; const prop=Number(document.getElementById('v-prop').value||0); const desc=Number(document.getElementById('v-desc').value||0);
    const lineas=[...document.querySelectorAll('#tbl-lineas tbody tr')].map(tr=>({sku:tr.children[0].querySelector('input').value.trim(), descripcion:tr.children[0].querySelector('input').value.trim(), cantidad:Number(tr.children[1].querySelector('input').value||0), precioUnit:Number(tr.children[2].querySelector('input').value||0)})).filter(x=>x.cantidad>0 && x.precioUnit>=0 && x.sku);
    const subtotal=lineas.reduce((a,b)=>a+b.cantidad*b.precioUnit,0); const impuestos=subtotal*(cfg.iva/100); const total=subtotal+impuestos+prop-desc;
    const t=Data.add(Data.col.ventas_ticket,{fechaHora:fecha,folio,estacionId:est,baristaId:bar,subtotal,impuestos,propina:prop,descuento:desc,total,metodoPago:met});
    lineas.forEach(l=> Data.add(Data.col.ventas_detalle,{ticketId:t.id,sku:l.sku,descripcion:l.descripcion,cantidad:l.cantidad,precioUnit:l.precioUnit,subtotal:l.cantidad*l.precioUnit}));
    notify('Ticket guardado','success'); document.getElementById('venta-form').classList.add('hidden');
    renderVentas(); renderDashboard();
  }
};

/****************
 * BMC: Ventas rápidas diarias
 ****************/
const ventasRapidas={
  _inited:false,
  init(){
    const card=document.getElementById('ventas-rapidas-card'); if(!card) return;
    const f=document.getElementById('vd-fecha'); if(f && !f.value) f.value=todayISO();
    if(!this._inited){ f?.addEventListener('change', ()=> this.prefill()); this._inited=true; }
    this.prefill();
  },
  prefill(){
    const f=document.getElementById('vd-fecha'); if(!f) return; const d=f.value||todayISO();
    const rows=Data.get(Data.col.ventas_ticket).filter(t=> t.origen==='resumen-diario' && (t.fechaHora||'').slice(0,10)===d);
    const val=(m)=> (rows.find(r=> String(r.metodoPago||'').toLowerCase()===m.toLowerCase())?.total)||0;
    const tip=(m)=> (rows.find(r=> String(r.metodoPago||'').toLowerCase()===m.toLowerCase())?.propina)||0;
    const set=(id,v)=>{const el=document.getElementById(id); if(el) el.value= v>0? Number(v.toFixed(2)):''};
    set('vd-efectivo', val('Efectivo'));
    set('vd-tarjeta',  val('Tarjeta'));
    set('vd-uber',     val('Uber'));
    set('vd-rappi',    val('Rappi'));
    set('vd-p-tarjeta',  tip('Tarjeta'));
    this.renderList(rows);
  },
  guardar(){
    const d=(document.getElementById('vd-fecha')?.value)||todayISO();
    const save=(method, amt)=>{
      const total=Number(amt||0);
      const tip = method==='Tarjeta'
        ? Number((document.getElementById('vd-p-tarjeta')?.value)||0)
        : 0;
      const iso=new Date(d+'T12:00').toISOString();
      const existing=Data.get(Data.col.ventas_ticket).find(t=> t.origen==='resumen-diario' && (t.fechaHora||'').slice(0,10)===d && String(t.metodoPago||'').toLowerCase()===method.toLowerCase());
      if(total>0 || tip>0){
        const subtotal= total/(1+(cfg.iva/100)); const impuestos= total - subtotal;
        if(existing){ Data.upd(Data.col.ventas_ticket, existing.id, {fechaHora:iso, subtotal, impuestos, total, propina:tip}); }
        else { Data.add(Data.col.ventas_ticket, {fechaHora:iso, folio:`RD-${d}-${method.toUpperCase()}`, estacionId:null, baristaId:null, subtotal, impuestos, propina:tip, descuento:0, total, metodoPago:method, origen:'resumen-diario'}); }
      } else if(existing){
        // ya no eliminar registros en cero para permitir editar posteriormente
        Data.upd(Data.col.ventas_ticket, existing.id, {fechaHora:iso, subtotal:0, impuestos:0, total:0, propina:0});
      }
    };
    save('Efectivo', document.getElementById('vd-efectivo')?.value);
    save('Tarjeta',  document.getElementById('vd-tarjeta')?.value);
    save('Uber',     document.getElementById('vd-uber')?.value);
    save('Rappi',    document.getElementById('vd-rappi')?.value);
    // sincronizar gasto de propinas (tarjeta) pagadas en efectivo
    ventasRapidas.syncPropinaTarjeta(d);
    notify('Ventas diarias actualizadas','success');
    this.prefill(); renderVentas(); renderDashboard();
  },
  syncPropinaTarjeta(d){
    const tip=Number(document.getElementById('vd-p-tarjeta')?.value||0);
    const ref=`TIP-${d}`;
    // limpiar gasto legado si existiera
    const old=Data.get(Data.col.gastos).find(g=> g.folio===ref); if(old) Data.del(Data.col.gastos, old.id);
    const exist=Data.get(Data.col.ajustes).find(a=> a.ref===ref);
    if(tip>0){
      const mov={fecha:d, cuenta:'Efectivo', tipo:'propina_tarjeta', concepto:'Pago de propinas de tarjeta', entrada:0, salida:tip, ref};
      if(exist) Data.upd(Data.col.ajustes, exist.id, mov); else Data.add(Data.col.ajustes, mov);
    } else if(exist){ Data.del(Data.col.ajustes, exist.id); }
  },
  listRecords(d){ return Data.get(Data.col.ventas_ticket).filter(t=> t.origen==='resumen-diario' && (t.fechaHora||'').slice(0,10)===(d||todayISO())); },
  renderList(rows){
    try{
      const d=document.getElementById('vd-fecha')?.value||todayISO();
      rows = rows || this.listRecords(d);
      const tb=document.querySelector('#tbl-vd tbody'); if(!tb) return;
      tb.innerHTML = rows.map(r=>{
        const ar = (['Uber','Rappi'].includes(r.metodoPago||''))? (r.total||0)*0.65 : 0;
        return `<tr><td>${r.metodoPago||''}</td><td>${fmt.money(r.total||0)}</td><td>${ar?fmt.money(ar):'-'}</td>
          <td><button class='btn' onclick="ventasRapidas.openEdit('${r.id}')">Editar</button> <button class='btn' onclick="ventasRapidas.duplicar('${r.id}')">Duplicar</button> <button class='btn danger' onclick="ventasRapidas.eliminar('${r.id}')">Eliminar</button></td></tr>`;
      }).join('');
    }catch(e){console.error(e)}
  },
  openEdit(id){
    const r=LocalDB.byId(Data.col.ventas_ticket, id); if(!r) return;
    const el=document.getElementById('venta-form'); el.classList.remove('hidden');
    const dt=new Date(r.fechaHora||new Date()).toISOString().slice(0,16);
    el.innerHTML=`
      <h3>Editar venta</h3>
      <div class='row'>
        <label>Folio<input id='ev-folio' value='${r.folio||''}'></label>
        <label>Fecha/Hora<input type='datetime-local' id='ev-fecha' value='${dt}'></label>
        <label>Método<select id='ev-met'>${METHODS.map(m=>`<option ${m===(r.metodoPago||'')?'selected':''}>${m}</option>`).join('')}</select></label>
        <label>Total<input type='number' id='ev-total' step='0.01' min='0' value='${Number(r.total||0).toFixed(2)}'></label>
        <label>Propina<input type='number' id='ev-tip' step='0.01' min='0' value='${Number(r.propina||0).toFixed(2)}'></label>
      </div>
      <div class='toolbar'><button class='btn primary' onclick="ventasRapidas.saveEdit('${r.id}')">Guardar</button> <button class='btn ghost' onclick="document.getElementById('venta-form').classList.add('hidden')">Cancelar</button></div>`;
    const metSel=document.getElementById('ev-met'); const tipInput=document.getElementById('ev-tip');
    const syncTip=()=>{
      const tarjeta= (metSel.value==='Tarjeta');
      tipInput.disabled=!tarjeta;
      if(!tarjeta){ tipInput.value='0.00'; }
    };
    metSel.addEventListener('change', syncTip);
    syncTip();
  },
  saveEdit(id){
    const r=LocalDB.byId(Data.col.ventas_ticket, id); if(!r) return;
    const folio=document.getElementById('ev-folio').value||'';
    const fecha=new Date(document.getElementById('ev-fecha').value||new Date()).toISOString();
    const metodo=document.getElementById('ev-met').value;
    const total=Number(document.getElementById('ev-total').value||0);
    const tip=metodo==='Tarjeta'? Number(document.getElementById('ev-tip').value||0) : 0;
    const subtotal= total/(1+(cfg.iva/100)); const impuestos= total - subtotal;
    Data.upd(Data.col.ventas_ticket, id, {folio, fechaHora:fecha, metodoPago:metodo, total, subtotal, impuestos, propina:tip});
    notify('Venta actualizada','success'); document.getElementById('venta-form').classList.add('hidden');
    this.prefill(); renderVentas(); renderDashboard();
  },
  duplicar(id){
    const r=LocalDB.byId(Data.col.ventas_ticket, id); if(!r) return; const dDefault=(r.fechaHora||'').slice(0,10)||todayISO(); const d=prompt('Duplicar al día (YYYY-MM-DD)', dDefault); if(!d) return;
    const iso=new Date(d+'T12:00').toISOString(); const total=r.total||0; const subtotal= total/(1+(cfg.iva/100)); const impuestos= total - subtotal;
    Data.add(Data.col.ventas_ticket, {fechaHora:iso, folio:`RD-${d}-${(r.metodoPago||'').toUpperCase()}-COPY`, estacionId:null, baristaId:null, subtotal, impuestos, propina:0, descuento:0, total, metodoPago:r.metodoPago, origen:'resumen-diario'});
    notify('Registro duplicado','success'); this.prefill(); renderVentas(); renderDashboard();
  },
  eliminar(id){
    if(!confirm('¿Eliminar registro?')) return; Data.del(Data.col.ventas_ticket, id); notify('Registro eliminado','success'); this.prefill(); renderVentas(); renderDashboard();
  }
};

async function importVentasExcel(files){
  try{
    const f=files[0]; if(!f) return; const data=await f.arrayBuffer(); const wb=XLSX.read(data,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]]; const rows=XLSX.utils.sheet_to_json(ws,{raw:false, defval:''});
    let add=0, dup=0;
    for(const r of rows){
      const clave=`${r.fecha||r.Fecha||''}|${r.ticket||r.Ticket||''}|${r.sku||r.SKU||''}`;
      const dedupKey='bm_dedup_'+clave; if(sessionStorage.getItem(dedupKey)){dup++; continue} sessionStorage.setItem(dedupKey,'1');
      const fecha=new Date(r.fecha||r.Fecha||Date.now()).toISOString();
      const folio=String(r.ticket||r.Ticket||'');
      const subtotal=parseFloat(r.subtotal||r.Subtotal||r.total||r.Total||0);
      const impuestos=subtotal*(cfg.iva/100); const total=parseFloat(r.total||r.Total||subtotal+impuestos);
      const t=Data.add(Data.col.ventas_ticket,{fechaHora:fecha,folio,estacionId:null,baristaId:null,subtotal,impuestos,propina:0,descuento:0,total,metodoPago:r.medio||r.Medio||'Efectivo'});
      Data.add(Data.col.ventas_detalle,{ticketId:t.id,sku:r.sku||r.SKU||'SKU',descripcion:r.desc||r.Descripcion||'Producto',cantidad:Number(r.cantidad||r.Cantidad||1),precioUnit:Number(r.precio||r.Precio||subtotal),subtotal:subtotal});
      add++;
    }
    notify(`Importadas ${add}. Duplicados ignorados: ${dup}`,'success');
    renderVentas(); renderDashboard();
  }catch(e){console.error(e); notify('Error importando Excel: '+e.message,'error')}
}

/*******************
 * BMC: Recetas     *
 *******************/
const recetas={
  _editId:null,
  peekFolio(){ const k=LocalDB.key('receta_seq'); const cur=Number(localStorage.getItem(k)||'0'); return cur+1; },
  nextFolio(){ const k=LocalDB.key('receta_seq'); const cur=Number(localStorage.getItem(k)||'0')+1; localStorage.setItem(k,String(cur)); return cur; },
  nueva(){
    this._editId=null;
    const el=document.getElementById('receta-form'); el.classList.remove('hidden');
    el.innerHTML=`
      <div class="row">
        <label class="grow">Nombre<input id="r-nombre" placeholder="Latte"></label>
        <label>Porciones<input type="number" id="r-porc" value="1" min="1"></label>
        <label>Tiempo prep (min)<input type="number" id="r-tprep" value="3" min="0"></label>
        <span class="badge" id="r-folio-badge">Folio: ${this.peekFolio()}</span>
      </div>
      <div class="row">
        <label>Margen objetivo %<input type="number" id="r-margen" value="60" step="0.01"></label>
      </div>
      <div class="card"><h3>Ingredientes</h3>
        <table class="table" id="tbl-ing"><thead><tr><th>Insumo</th><th>Cantidad</th><th>Unidad</th><th>Costo unit</th><th></th></tr></thead><tbody></tbody></table>
        <div class="toolbar"><button class="btn" onclick="recetas.agregarIng()">Agregar ingrediente</button></div>
      </div>
      <div class="card"><h3>Costo directo</h3>
        <table class="table" id="tbl-costeo"><thead><tr><th>Insumo</th><th>Cantidad</th><th>Unidad</th><th>Costo unit (base)</th><th>Subtotal</th></tr></thead><tbody></tbody><tfoot id="tf-costeo-dir"></tfoot></table>
      </div>
      <div class="card"><h3>Costos ABC</h3>
        <div id="abc-resumen" class="row"></div>
      </div>
      <div class="card"><h3>Total</h3>
        <div id="total-resumen"></div>
      </div>
      <div class="toolbar">
        <button class="btn primary" onclick="recetas.guardar()">Guardar receta</button>
        <button class="btn" onclick="document.querySelector('#tbl-ing')?.scrollIntoView({behavior:'smooth',block:'start'})">Editar insumos</button>
        <button class="btn" onclick="document.getElementById('r-tprep')?.focus()">Editar tiempos</button>
        <button class="btn" onclick="document.getElementById('abc-config-card')?.scrollIntoView({behavior:'smooth',block:'start'})">Actualizar ABC</button>
        <div class="grow"></div>
        <button class="btn" onclick="recetas.sharePDF(recetas._editId||null)">Compartir PDF</button>
        <button class="btn" onclick="recetas.shareExcel(recetas._editId||null)">Exportar Excel</button>
        <button class="btn ghost" onclick="document.getElementById('receta-form').classList.add('hidden')">Cerrar</button>
      </div>
    `;
    this.agregarIng();
    ['r-margen','r-porc','r-tprep'].forEach(id=> document.getElementById(id)?.addEventListener('input', ()=> recetas.recalcCosteo?.()));
    recetas.recalcCosteo?.();
  },
  agregarIng(){
    const ins=Data.get(Data.col.insumos_costeo);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><select class='cost-item'>${ins.map(i=>`<option value="${i.id}">${i.nombre}</option>`).join('')}</select></td>
      <td><input class='qty' type="number" min="0.001" step="0.001" value="1"></td>
      <td><select class='unit'></select></td>
      <td><input class='cu' type="number" min="0" step="0.0001" value="0"></td>
      <td><button class="btn" onclick="this.closest('tr').remove(); recetas.recalcCosteo()">✕</button></td>`;
    document.querySelector('#tbl-ing tbody').appendChild(tr);
    const sel=tr.querySelector('select.cost-item'); const unitSel=tr.querySelector('select.unit'); const cu=tr.querySelector('input.cu'); const qty=tr.querySelector('input.qty');
    const setUnitOptions=(base)=>{ const b=(base||'').toLowerCase(); const opts=(b==='kg'||b==='g'||b==='oz')? ['g','kg','oz']: ['ml','L','oz']; unitSel.innerHTML=opts.map(u=>`<option value='${u}'>${u}</option>`).join(''); };
    const setDefaults=()=>{ const item=LocalDB.byId(Data.col.insumos_costeo, sel.value); if(!item) return; setUnitOptions(item.unidad||'g'); unitSel.value=item.unidad||'g'; cu.value=Number(item.costoUnit||0); recetas.recalcCosteo(); };
    [sel, unitSel, cu, qty].forEach(e=> e.addEventListener('input', ()=> recetas.recalcCosteo()));
    sel.addEventListener('change', setDefaults); setDefaults();
  },
  guardar(){
    const base={nombre:document.getElementById('r-nombre').value,porciones:Number(document.getElementById('r-porc').value||1),tiempoPrepMin:Number(document.getElementById('r-tprep').value||0),margenObj:Number(document.getElementById('r-margen').value||60),precioSugerido:0,notas:''};
    let recId=this._editId;
    if(recId){ Data.upd(Data.col.recetas, recId, base); Data.get(Data.col.recetas_ingredientes).filter(i=> i.recetaId===recId).forEach(i=> Data.del(Data.col.recetas_ingredientes, i.id)); }
    else { const folio=String(this.nextFolio()); const r=Data.add(Data.col.recetas, {...base, folio}); recId=r.id; }
    document.querySelectorAll('#tbl-ing tbody tr').forEach(tr=>{
      const costId=tr.children[0].querySelector('select').value; const item=LocalDB.byId(Data.col.insumos_costeo,costId);
      Data.add(Data.col.recetas_ingredientes,{recetaId:recId,costeoId:costId,nombre:item?.nombre||'',cantidad:Number(tr.children[1].querySelector('input').value||0),unidad:tr.children[2].querySelector('select')?.value||item?.unidad,costoUnit:Number(tr.children[3].querySelector('input').value||item?.costoUnit||0)});
    });
    notify('Receta guardada','success'); recetasCalcularCosto(); renderRecetas(); renderCostosInsumos(); recetas.editar(recId);
  },
  editar(id){
    const r=LocalDB.byId(Data.col.recetas,id); if(!r) return; this._editId=id;
    const el=document.getElementById('receta-form'); el.classList.remove('hidden');
    const ins=Data.get(Data.col.insumos_costeo);
    el.innerHTML=`
      <div class="row">
        <label class="grow">Nombre<input id="r-nombre" value="${r.nombre||''}"></label>
        <label>Porciones<input type="number" id="r-porc" value="${r.porciones||1}" min="1"></label>
        <label>Tiempo prep (min)<input type="number" id="r-tprep" value="${r.tiempoPrepMin||0}" min="0"></label>
        <span class="badge" id="r-folio-badge">Folio: ${r.folio||'-'}</span>
      </div>
      <div class="row">
        <label>Margen objetivo %<input type="number" id="r-margen" value="${r.margenObj||60}" step="0.01"></label>
      </div>
      <div class="card"><h3>Ingredientes</h3>
        <table class="table" id="tbl-ing"><thead><tr><th>Insumo</th><th>Cantidad</th><th>Unidad</th><th>Costo unit</th><th></th></tr></thead><tbody></tbody></table>
        <div class="toolbar"><button class="btn" onclick="recetas.agregarIng()">Agregar ingrediente</button></div>
      </div>
      <div class="card"><h3>Costo directo</h3>
        <table class="table" id="tbl-costeo"><thead><tr><th>Insumo</th><th>Cantidad</th><th>Unidad</th><th>Costo unit (base)</th><th>Subtotal</th></tr></thead><tbody></tbody><tfoot id="tf-costeo-dir"></tfoot></table>
      </div>
      <div class="card"><h3>Costos ABC</h3>
        <div id="abc-resumen" class="row"></div>
      </div>
      <div class="card"><h3>Total</h3>
        <div id="total-resumen"></div>
      </div>
      <div class="toolbar">
        <button class="btn primary" onclick="recetas.guardar()">Actualizar receta</button>
        <button class="btn" onclick="document.querySelector('#tbl-ing')?.scrollIntoView({behavior:'smooth',block:'start'})">Editar insumos</button>
        <button class="btn" onclick="document.getElementById('r-tprep')?.focus()">Editar tiempos</button>
        <button class="btn" onclick="document.getElementById('abc-config-card')?.scrollIntoView({behavior:'smooth',block:'start'})">Actualizar ABC</button>
        <div class="grow"></div>
        <button class="btn" onclick="recetas.sharePDF('${id}')">Compartir PDF</button>
        <button class="btn" onclick="recetas.shareExcel('${id}')">Exportar Excel</button>
        <button class="btn ghost" onclick="document.getElementById('receta-form').classList.add('hidden')">Cerrar</button>
      </div>
    `;
    const tbody=el.querySelector('#tbl-ing tbody');
    Data.get(Data.col.recetas_ingredientes).filter(i=> i.recetaId===id).forEach(i=>{
      const tr=document.createElement('tr');
      const opts=ins.map(inf=>`<option value="${inf.id}" ${ (i.costeoId===inf.id || i.insumoId===inf.id || (i.nombre&&inf.nombre===i.nombre))?'selected':''}>${inf.nombre}</option>`).join('');
      tr.innerHTML=`<td><select class='cost-item'>${opts}</select></td>
        <td><input class='qty' type="number" min="0.001" step="0.001" value="${i.cantidad||1}"></td>
        <td><select class='unit'></select></td>
        <td><input class='cu' type="number" min="0" step="0.0001" value="${(LocalDB.byId(Data.col.insumos_costeo, i.costeoId||i.insumoId)?.costoUnit) ?? i.costoUnit ?? 0}"></td>
        <td><button class="btn" onclick="this.closest('tr').remove(); recetas.recalcCosteo()">✕</button></td>`;
      tbody.appendChild(tr);
      const sel=tr.querySelector('select.cost-item'); const unitSel=tr.querySelector('select.unit'); const cu=tr.querySelector('input.cu'); const qty=tr.querySelector('input.qty');
      const setUnitOptions=(base)=>{ const b=(base||'').toLowerCase(); const opts=(b==='kg'||b==='g'||b==='oz')? ['g','kg','oz']: ['ml','L','oz']; unitSel.innerHTML=opts.map(u=>`<option value='${u}'>${u}</option>`).join(''); };
      const item=LocalDB.byId(Data.col.insumos_costeo, i.costeoId||i.insumoId);
      setUnitOptions(item?.unidad||'g'); unitSel.value=i.unidad||item?.unidad||'g';
      [sel, unitSel, cu, qty].forEach(e=> e.addEventListener('input', ()=> recetas.recalcCosteo()));
    });
    ['r-margen','r-porc','r-tprep'].forEach(id=> document.getElementById(id)?.addEventListener('input', ()=> recetas.recalcCosteo?.()));
    recetas.recalcCosteo?.();
  },
  eliminar(id){ if(!confirm('¿Eliminar receta?')) return; Data.get(Data.col.recetas_ingredientes).filter(i=> i.recetaId===id).forEach(i=> Data.del(Data.col.recetas_ingredientes, i.id)); Data.del(Data.col.recetas,id); notify('Receta eliminada','success'); renderRecetas(); }
  ,duplicar(id){ const r=LocalDB.byId(Data.col.recetas,id); if(!r) return; const nombre=prompt('Nombre del duplicado', (r.nombre||'')+' (copy)')||((r.nombre||'')+' (copy)'); const base={...r, id:undefined, nombre}; const folio=String(this.nextFolio()); const n=Data.add(Data.col.recetas, {...base, folio}); const ings=Data.get(Data.col.recetas_ingredientes).filter(i=> i.recetaId===id); ings.forEach(i=> Data.add(Data.col.recetas_ingredientes,{...i, id:undefined, recetaId:n.id})); notify('Receta duplicada','success'); recetasCalcularCosto(); renderRecetas(); }
  ,_collectFromForm(){
    const name=document.getElementById('r-nombre')?.value||'';
    const porciones=Number(document.getElementById('r-porc')?.value||1);
    const tprep=Number(document.getElementById('r-tprep')?.value||0);
    const margen=Number(document.getElementById('r-margen')?.value||60);
    const rows=[...document.querySelectorAll('#tbl-ing tbody tr')];
    const ings=rows.map(tr=>{
      const costId=tr.querySelector('select.cost-item')?.value; const base=LocalDB.byId(Data.col.insumos_costeo, costId)||{};
      return {
        nombre: base.nombre||'',
        unidadSel: tr.querySelector('select.unit')?.value || base.unidad || 'g',
        unidadBase: base.unidad || 'g',
        cantidad: Number(tr.querySelector('input.qty')?.value||0),
        costoUnit: Number(tr.querySelector('input.cu')?.value||0)
      }
    });
    return {name, porciones, tprep, margen, ings};
  }
  ,_buildCosteoHTML(id){
    let rec=null; let ings=[]; let nombre='', porciones=1, tprep=0, margen=60;
    if(id){
      rec=LocalDB.byId(Data.col.recetas,id); if(!rec) return '';
      nombre=rec.nombre||''; porciones=Number(rec.porciones||1); tprep=Number(rec.tiempoPrepMin||0); margen=Number(rec.margenObj||60);
      ings=Data.get(Data.col.recetas_ingredientes).filter(i=> i.recetaId===id).map(i=>{
        const ins=LocalDB.byId(Data.col.insumos_costeo,i.costeoId)||{};
        return {
          nombre: i.nombre || ins.nombre || '',
          unidadSel: i.unidad || ins.unidad || 'g',
          unidadBase: ins.unidad || 'g',
          cantidad: Number(i.cantidad||0),
          costoUnit: Number((ins.costoUnit ?? i.costoUnit) || 0)
        }
      });
    } else {
      const s=this._collectFromForm(); nombre=s.name; porciones=s.porciones; tprep=s.tprep; margen=s.margen; ings=s.ings;
    }
    const rate=abc.rate();
    const massF=(u)=> u==='kg'?1000: (u==='g'?1: (u==='oz'?28.349523125:1));
    const volF=(u)=> u==='l'||u==='L'?1000: (u==='ml'?1: (u==='oz'?29.5735:1));
    let subtotalMat=0;
    const rows=ings.map(i=>{
      const tgt=(i.unidadBase||'g').toLowerCase(); const gu=(tgt==='l'||tgt==='ml'||tgt==='l')?'volume':'mass'; const from=(i.unidadSel||tgt).toLowerCase();
      const f=(gu==='volume')? (volF(from)/volF(tgt)) : (massF(from)/massF(tgt));
      const qtyInBase=Number(i.cantidad||0)*f; const line=qtyInBase*Number(i.costoUnit||0); subtotalMat+=line;
      return `<tr><td>${i.nombre}</td><td style='text-align:right'>${Number(i.cantidad||0).toFixed(3)}</td><td>${i.unidadSel}</td><td style='text-align:right'>${fmt.money(i.costoUnit)} / ${i.unidadBase}</td><td style='text-align:right'>${fmt.money(line)}</td></tr>`;
    }).join('');
    const abcLote=rate*tprep; const costoPorcion=(porciones>0)? ((subtotalMat+abcLote)/porciones) : 0; const matPorcion=(porciones>0)? (subtotalMat/porciones) : 0; const abcPorcion=(porciones>0)? (abcLote/porciones) : 0; const precioSug=costoPorcion>0? (costoPorcion/(1-(margen/100))) : 0;
    const logoSrc=document.getElementById('app-logo')?.src||'';
    const content=`<div class='pdf-root'>
      <style> .pdf-root{font:12px system-ui;color:#000} h1,h2{margin:0 0 8px 0} h1{font-size:24px} h2{font-size:14px;color:#444} table{width:100%;border-collapse:collapse;margin-top:8px} th,td{border:1px solid #ccc;padding:6px;text-align:left} .right{text-align:right} .muted{color:#555} .tot{font-weight:700} header{display:flex;align-items:center;gap:16px;margin-bottom:12px} header img{width:72px;height:72px;border-radius:10px;object-fit:cover} .hl{font-size:20px;font-weight:700} .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px} .card{border:1px solid #ddd;border-radius:8px;padding:8px}</style>
      <header><img src='${logoSrc}' alt='logo'><div><h1 style='margin:0'>Costeo de receta</h1><div class='muted'>${nombre} · Porciones: ${porciones}${id && rec?.folio? ` · Folio: ${rec.folio}`:''}</div></div></header>
      <div class='card'>
        <h2>Costo directo</h2>
        <table><thead><tr><th>Insumo</th><th>Cantidad</th><th>Unidad</th><th>Costo unit</th><th>Subtotal</th></tr></thead><tbody>${rows || `<tr><td colspan='5'>Sin ingredientes</td></tr>`}</tbody><tfoot>
          <tr><td colspan='4' class='right'><strong>Subtotal materiales (lote)</strong></td><td class='right'>${fmt.money(subtotalMat)}</td></tr>
          <tr><td colspan='4' class='right'>Materiales por porción</td><td class='right'>${fmt.money(matPorcion)}</td></tr>
        </tfoot></table>
      </div>
      <div class='grid'>
        <div class='card'>
          <h2>Costos ABC</h2>
          <table><tbody>
            <tr><td>Tarifa por minuto</td><td class='right'>${fmt.money(rate)}</td></tr>
            <tr><td>Tiempo producción (min)</td><td class='right'>${Number(tprep||0).toFixed(2)}</td></tr>
            <tr><td>ABC por lote</td><td class='right'>${fmt.money(abcLote)}</td></tr>
            <tr><td>ABC por porción</td><td class='right'>${fmt.money(abcPorcion)}</td></tr>
          </tbody></table>
        </div>
        <div class='card'>
          <h2>Total</h2>
          <table><tbody>
            <tr><td>Costo por porción</td><td class='right hl'>${fmt.money(costoPorcion)}</td></tr>
            <tr><td>Precio sugerido (margen ${margen}%)</td><td class='right'>${fmt.money(precioSug)}</td></tr>
          </tbody></table>
        </div>
      </div>
    </div>`;
    return content;
  }
  ,sharePDF(id){
    const content=this._buildCosteoHTML(id);
    if(!content){ alert('No hay datos para compartir'); return; }
    const nombre = (id? (LocalDB.byId(Data.col.recetas,id)?.nombre||'Receta') : (document.getElementById('r-nombre')?.value||'Receta'));
    const w=window.open('about:blank','_blank');
    w.document.write(`<!doctype html><title>${'Costeo '+nombre}</title><body>${content}<script>setTimeout(()=>window.print(),150)<\/script></body>`);
    w.document.close();
  }
  ,shareExcel(id){
    const content=this._buildCosteoHTML(id);
    if(!content){ alert('No hay datos para exportar'); return; }
    // Extraer tablas del HTML y servir como Excel (HTML workbook)
    const name = (id? (LocalDB.byId(Data.col.recetas,id)?.nombre||'Receta') : (document.getElementById('r-nombre')?.value||'Receta'));
    const blob = new Blob([`\ufeff${content}`], {type:'application/vnd.ms-excel'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`Costeo_${(name||'Receta').replace(/\s+/g,'_')}.xls`; a.click(); URL.revokeObjectURL(a.href);
  }
  ,exportPDF(){
    // Exporta PDF de la receta en edición; si no hay, pregunta.
    const id=this._editId; if(id){ this.sharePDF(id); return; }
    const list=Data.get(Data.col.recetas); if(!list.length){ alert('No hay recetas'); return; }
    const nombre=prompt('Nombre de la receta a exportar (PDF)', list[0].nombre)||list[0].nombre; const rec=list.find(r=> (r.nombre||'').toLowerCase()===String(nombre||'').toLowerCase()) || list[0];
    this.sharePDF(rec.id);
  }
};

function recetasCalcularCosto(silent=false){
  const rs=Data.get(Data.col.recetas);
  rs.forEach(r=>{
    const ings=Data.listBy(Data.col.recetas_ingredientes,i=>i.recetaId===r.id);
    // Convertir según unidad del insumo de costeo
    const costoMat=ings.reduce((a,i)=>{ const item=LocalDB.byId(Data.col.insumos_costeo, i.costeoId||i.insumoId)||{}; const f=(function(){ const tgt=(item.unidad||'g').toLowerCase(); const gu=(tgt==='l'||tgt==='ml')?'volume':'mass'; const from=(i.unidad||tgt).toLowerCase(); const massF=(u)=> u==='kg'?1000: (u==='g'?1: (u==='oz'?28.349523125:1)); const volF=(u)=> u==='l'?1000: (u==='ml'?1: (u==='oz'?29.5735:1)); if(gu==='volume') return volF(from)/volF(tgt); return massF(from)/massF(tgt); })(); const qtyInItemUnit=Number(i.cantidad||0)*f; const unitCost = Number((item.costoUnit ?? i.costoUnit) || 0); return a + qtyInItemUnit*unitCost; },0);
    const rate=abc.rate();
    const tiempo=Number(r.tiempoPrepMin||0);
    const abcLote=rate*tiempo;
    const porciones=Number(r.porciones||1);
    const costoLote=costoMat + abcLote;
    const costoPorcion=costoLote/(porciones||1);
    const mpPorcion=costoMat/(porciones||1);
    const abcPorcion=abcLote/(porciones||1);
    const precioSugerido=costoPorcion>0? (costoPorcion/(1-(Number(r.margenObj||0)/100))) : 0;
    Data.upd(Data.col.recetas,r.id,{precioSugerido, costoPorcion, mpPorcion, abcPorcion});
  });
  if(!silent) notify('Costos calculados','success'); renderRecetas(); recetas.recalcCosteo?.();
}

// Resumen de costeo en formulario (con ABC)
recetas.recalcCosteo=function(){
  const tbody=document.querySelector('#tbl-ing tbody'); const rows=[...tbody?.querySelectorAll('tr')||[]];
  const out=document.querySelector('#tbl-costeo tbody'); if(!out) return;
  let total=0; const html=rows.map(tr=>{
    const costId=tr.querySelector('select.cost-item')?.value; const item=LocalDB.byId(Data.col.insumos_costeo, costId)||{};
    const qty=Number(tr.querySelector('input.qty')?.value||0); const unit=(tr.querySelector('select.unit')?.value||item.unidad||'g'); const cu=Number(tr.querySelector('input.cu')?.value||0);
    const tgt=(item.unidad||'g').toLowerCase(); const gu=(tgt==='l'||tgt==='ml')?'volume':'mass'; const from=(unit||tgt).toLowerCase();
    const massF=(u)=> u==='kg'?1000: (u==='g'?1: (u==='oz'?28.349523125:1)); const volF=(u)=> u==='l'?1000: (u==='ml'?1: (u==='oz'?29.5735:1));
    const f = (gu==='volume')? (volF(from)/volF(tgt)) : (massF(from)/massF(tgt));
    const qtyInItemUnit=qty*f; const line=qtyInItemUnit*cu; total+=line;
    return `<tr><td>${item.nombre||''}</td><td>${qty.toFixed(3)}</td><td>${unit}</td><td>${fmt.money(cu)} / ${item.unidad||''}</td><td>${fmt.money(line)}</td></tr>`;
  });
  out.innerHTML=html.join('') || '<tr><td colspan="5">Sin ingredientes</td></tr>';
  // Directo (materiales)
  const tfDir=document.getElementById('tf-costeo-dir'); if(tfDir){
    const porc=Number(document.getElementById('r-porc')?.value||1);
    const matPorcion=(porc>0)? (total/porc) : 0;
    tfDir.innerHTML = `<tr><td colspan='4' class='right'><strong>Subtotal materiales (lote)</strong></td><td>${fmt.money(total)}</td></tr>
      <tr><td colspan='4' class='right'>Materiales por porción</td><td>${fmt.money(matPorcion)}</td></tr>`;
  }
  // ABC resumen
  const porc=Number(document.getElementById('r-porc')?.value||1);
  const tprep=Number(document.getElementById('r-tprep')?.value||0);
  const rate=abc.rate();
  const abcLote=rate*tprep;
  const abcPorcion=(porc>0)? (abcLote/porc) : 0;
  const abcBox=document.getElementById('abc-resumen'); if(abcBox){
    abcBox.innerHTML = `
      <div class='card' style='flex:1;min-width:220px'><h3>Tarifa por minuto</h3><div class='big'>${fmt.money(rate)}</div></div>
      <div class='card' style='flex:1;min-width:220px'><h3>Tiempo (lote, min)</h3><div class='big'>${Number(tprep||0).toFixed(2)}</div></div>
      <div class='card' style='flex:1;min-width:220px'><h3>ABC por lote</h3><div class='big'>${fmt.money(abcLote)}</div></div>
      <div class='card' style='flex:1;min-width:220px'><h3>ABC por porción</h3><div class='big'>${fmt.money(abcPorcion)}</div></div>`;
  }
  // Total resumen
  const costoPorcion=(porc>0)? ((total+abcLote)/porc) : 0;
  const margen=Number(document.getElementById('r-margen')?.value||60);
  const precioSugerido=costoPorcion>0? (costoPorcion/(1-(margen/100))) : 0;
  const tot=document.getElementById('total-resumen'); if(tot){
    tot.innerHTML = `
      <div class='kpi'><small>Costo por porción</small><strong style='color:var(--ok);font-size:28px'>${fmt.money(costoPorcion)}</strong></div>
      <div class='kpi'><small>Precio sugerido (margen ${margen}%)</small><strong style='font-size:22px'>${fmt.money(precioSugerido)}</strong></div>`;
  }
};

// Nota: Se eliminó una versión duplicada de recalcCosteo para evitar confusión.

 /*******************
 * BMC: Inventario  *
 *******************/
const costosInsumos={
  nuevo(){
    const nombre=prompt('Nombre del insumo (para recetas)'); if(!nombre) return;
    const allowed=['g','kg','ml','L','oz']; let unidad=prompt('Unidad (elige: g, kg, ml, L, oz)','g')||'g'; unidad = allowed.includes(unidad)? unidad : 'g';
    const costo=Number(prompt('Costo unitario en la unidad elegida','0')||0);
    const provs=Data.get(Data.col.proveedores); const provList=provs.map(p=>p.nombre).join(', ');
    let provName = prompt('Proveedor (elige exacto de la lista o escribe uno nuevo):\n'+provList, provs[0]?.nombre||'')||'';
    let prov=provs.find(p=> (p.nombre||'').toLowerCase()===provName.toLowerCase()); if(!prov && provName){ prov=Data.add(Data.col.proveedores,{nombre:provName}); }
    Data.add(Data.col.insumos_costeo,{nombre,unidad,costoUnit:costo, proveedorId:prov?.id||null});
    notify('Insumo agregado','success'); renderCostosInsumos(); recetasCalcularCosto(true); renderRecetas();
  },
  editar(id){
    const it=LocalDB.byId(Data.col.insumos_costeo,id); if(!it) return;
    const nombre=prompt('Nombre', it.nombre)||it.nombre; const allowed=['g','kg','ml','L','oz']; let unidad=prompt('Unidad (g, kg, ml, L, oz)', it.unidad||'g')||it.unidad||'g'; unidad = allowed.includes(unidad)? unidad : (it.unidad||'g'); const costo=Number(prompt('Costo unitario', it.costoUnit||0)||it.costoUnit||0);
    const provs=Data.get(Data.col.proveedores); const provList=provs.map(p=>p.nombre).join(', ');
    let provName = prompt('Proveedor (lista: '+provList+')', (LocalDB.byId(Data.col.proveedores,it.proveedorId)?.nombre)||'')||'';
    let prov=provs.find(p=> (p.nombre||'').toLowerCase()===provName.toLowerCase()); if(!prov && provName){ prov=Data.add(Data.col.proveedores,{nombre:provName}); }
    Data.upd(Data.col.insumos_costeo,id,{nombre,unidad,costoUnit:costo, proveedorId:prov?.id||null}); notify('Insumo actualizado','success'); renderCostosInsumos(); recetasCalcularCosto(true); renderRecetas();
  },
  eliminar(id){
    const used=Data.get(Data.col.recetas_ingredientes).some(i=> i.costeoId===id);
    if(used){ alert('Este insumo está en uso en alguna receta. Edita o elimina primero esas líneas.'); return; }
    if(!confirm('¿Eliminar insumo de costeo?')) return; Data.del(Data.col.insumos_costeo,id); notify('Insumo eliminado','success'); renderCostosInsumos(); recetasCalcularCosto(true); renderRecetas();
  },
  guardar(){
    const nombre=document.getElementById('ci-nombre')?.value?.trim(); if(!nombre) return alert('Nombre requerido');
    const prov=document.getElementById('ci-prov')?.value||''; const unidad=document.getElementById('ci-unidad')?.value||'g'; const costo=Number(document.getElementById('ci-costo')?.value||0);
    Data.add(Data.col.insumos_costeo,{nombre,proveedorId:prov||null,unidad,costoUnit:costo}); notify('Insumo guardado','success'); document.getElementById('costeo-form')?.classList.add('hidden'); renderCostosInsumos();
  },
  actualizar(id){
    const nombre=document.getElementById('ci-nombre')?.value?.trim(); if(!nombre) return alert('Nombre requerido');
    const prov=document.getElementById('ci-prov')?.value||''; const unidad=document.getElementById('ci-unidad')?.value||'g'; const costo=Number(document.getElementById('ci-costo')?.value||0);
    Data.upd(Data.col.insumos_costeo,id,{nombre,proveedorId:prov||null,unidad,costoUnit:costo}); notify('Insumo actualizado','success'); document.getElementById('costeo-form')?.classList.add('hidden'); renderCostosInsumos();
  },
  form(t){ const el=document.getElementById('costeo-form'); el.classList.remove('hidden'); const provs=Data.get(Data.col.proveedores); const opts=provs.map(p=>`<option value='${p.id}'>${p.nombre}</option>`).join(''); const unit=`<select id='ci-unidad'><option>g</option><option>kg</option><option>ml</option><option>L</option><option>oz</option></select>`; el.innerHTML=t+opts.replace(/\n/g,''); },
  nuevo(){
    const el=document.getElementById('costeo-form'); el.classList.remove('hidden'); const provs=Data.get(Data.col.proveedores);
    el.innerHTML=`
      <div class='row'>
        <label class='grow'>Nombre<input id='ci-nombre' placeholder='Café Finsa Santa Cruz'></label>
        <label class='grow'>Proveedor<select id='ci-prov'><option value=''>Sin proveedor</option>${provs.map(p=>`<option value='${p.id}'>${p.nombre}</option>`).join('')}</select></label>
        <label>Unidad<select id='ci-unidad'><option>g</option><option>kg</option><option>ml</option><option>L</option><option>oz</option></select></label>
        <label>Costo unit<input id='ci-costo' type='number' step='0.0001' min='0' value='0'></label>
      </div>
      <div class='toolbar'><button class='btn primary' onclick='costosInsumos.guardar()'>Guardar</button> <button class='btn ghost' onclick="document.getElementById('costeo-form').classList.add('hidden')">Cerrar</button></div>
    `;
  },
  editar(id){
    const it=LocalDB.byId(Data.col.insumos_costeo,id); if(!it) return; const provs=Data.get(Data.col.proveedores);
    const el=document.getElementById('costeo-form'); el.classList.remove('hidden');
    el.innerHTML=`
      <div class='row'>
        <label class='grow'>Nombre<input id='ci-nombre' value='${it.nombre||''}'></label>
        <label class='grow'>Proveedor<select id='ci-prov'><option value=''>Sin proveedor</option>${provs.map(p=>`<option value='${p.id}' ${it.proveedorId===p.id?'selected':''}>${p.nombre}</option>`).join('')}</select></label>
        <label>Unidad<select id='ci-unidad'><option ${it.unidad==='g'?'selected':''}>g</option><option ${it.unidad==='kg'?'selected':''}>kg</option><option ${it.unidad==='ml'?'selected':''}>ml</option><option ${it.unidad==='L'?'selected':''}>L</option><option ${it.unidad==='oz'?'selected':''}>oz</option></select></label>
        <label>Costo unit<input id='ci-costo' type='number' step='0.0001' min='0' value='${it.costoUnit||0}'></label>
      </div>
      <div class='toolbar'><button class='btn primary' onclick="costosInsumos.actualizar('${id}')">Actualizar</button> <button class='btn ghost' onclick="document.getElementById('costeo-form').classList.add('hidden')">Cerrar</button></div>
    `;
  },
  duplicar(id){ const it=LocalDB.byId(Data.col.insumos_costeo,id); if(!it) return; const nombre=prompt('Nombre del duplicado', (it.nombre||'')+' (copy)')||((it.nombre||'')+' (copy)'); Data.add(Data.col.insumos_costeo,{...it,id:undefined,nombre}); notify('Insumo duplicado','success'); renderCostosInsumos(); recetasCalcularCosto(true); renderRecetas(); }
};
const inventario={
  nuevoInsumo(){
    const nombre=prompt('Nombre del insumo'); if(!nombre) return;
    Data.add(Data.col.insumos,{nombre,unidad:prompt('Unidad (g/ml/unid)','g'),costoPromedio:Number(prompt('Costo unitario promedio','0')||0),existencia:Number(prompt('Existencia inicial','0')||0),min:0,max:0});
    renderInventario();
  },
  renderKardex(){
    const desde=document.getElementById('kdx-desde').value, hasta=document.getElementById('kdx-hasta').value; const insSel=document.getElementById('kdx-insumo').value;
    const rows=Data.get(Data.col.kardex).filter(k=> inRange(k.fechaHora,desde,hasta) && (!insSel || k.insumoId===insSel))
      .map(k=> ({Fecha:fmt.date(k.fechaHora),Insumo:LocalDB.byId(Data.col.insumos,k.insumoId)?.nombre||'',Tipo:k.tipo,Cantidad:k.cantidad,Costo:k.costoUnit,Ref:k.ref,Notas:k.notas}));
    const tb=document.querySelector('#tbl-kardex tbody'); tb.innerHTML= rows.map(r=>`<tr><td>${r.Fecha}</td><td>${r.Insumo}</td><td>${r.Tipo}</td><td>${fmt.num(r.Cantidad)}</td><td>${fmt.money(r.Costo)}</td><td>${r.Ref||''}</td><td>${r.Notas||''}</td></tr>`).join('');
  }
};

function inventarioDescontarPorVenta(ticketId){
  // BMC: Simple demo: si el SKU coincide con nombre de receta, descuenta sus ingredientes
  const det=Data.listBy(Data.col.ventas_detalle,d=>d.ticketId===ticketId);
  det.forEach(l=>{
    const r=Data.get(Data.col.recetas).find(x=> x.nombre.toLowerCase()=== (l.descripcion||l.sku).toLowerCase());
    if(!r) return; const ings=Data.listBy(Data.col.recetas_ingredientes,i=>i.recetaId===r.id);
    ings.forEach(i=>{
      const ins=LocalDB.byId(Data.col.insumos,i.insumoId); const qty=i.cantidad*l.cantidad; const nueva=(ins.existencia||0)-qty;
      LocalDB.update(Data.col.insumos, ins.id, {existencia:nueva<0?0:nueva});
      Data.add(Data.col.kardex,{fechaHora:new Date().toISOString(),insumoId:ins.id,tipo:'salida',cantidad:qty,costoUnit:i.costoUnit,ref:ticketId,notas:l.sku});
    })
  });
  renderInventario();
}

/*******************
 * BMC: Compras     *
 *******************/
const compras={
  _form:null,
  _setForm(el){ this._form=el; },
  _formEl(){ return this._form || document.getElementById('compra-form-recetas') || document.getElementById('compra-form'); },
  closeForm(){ const el=this._formEl(); if(el) el.classList.add('hidden'); },
  nueva(){
    const el=document.getElementById('compra-form-recetas') || document.getElementById('compra-form'); el.classList.remove('hidden'); this._setForm(el);
    const provs=Data.get(Data.col.proveedores);
    el.innerHTML=`
      <div class="row">
        <label>Proveedor<select id="c-prov">${provs.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('')}</select></label>
        <label>Fecha/Hora<input type="datetime-local" id="c-fecha" value="${new Date().toISOString().slice(0,16)}"></label>
        <label>Folio<input id="c-folio"></label>
        <label>Método<select id="c-met"><option>Transferencia</option><option>Efectivo</option><option>Tarjeta</option></select></label>
      </div>
      <div class="card"><h3>Ítems</h3>
        <table class="table" id="tbl-citems"><thead><tr><th>Insumo</th><th>Cantidad</th><th>Unidad</th><th>Costo Unit</th><th>Subtotal</th><th></th></tr></thead><tbody></tbody></table>
        <div class="toolbar"><button class="btn" onclick="compras.agregarItem()">Agregar ítem</button></div>
      </div>
      <div class="toolbar"><button class="btn primary" onclick="compras.guardar()">Guardar compra</button> <button class="btn ghost" onclick="compras.closeForm()">Cerrar</button></div>
    `;
    compras.agregarItem();
  },
  agregarItem(){
    const ins=Data.get(Data.col.insumos);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><select>${ins.map(i=>`<option value="${i.id}">${i.nombre}</option>`).join('')}</select></td>
      <td><input type="number" min="0.001" step="0.001" value="1"></td>
      <td><input placeholder="g/ml/unid"></td>
      <td><input type="number" min="0" step="0.0001" value="0"></td>
      <td class="sub">$0.00</td>
      <td><button class="btn" onclick="this.closest('tr').remove()">✕</button></td>`;
    tr.addEventListener('input',()=>{
      const qty=Number(tr.children[1].querySelector('input').value||0), cu=Number(tr.children[3].querySelector('input').value||0);
      tr.querySelector('.sub').textContent=fmt.money(qty*cu);
    });
    const el=this._formEl(); const tbody=el?.querySelector('#tbl-citems tbody'); if(tbody){ tbody.appendChild(tr); tr.dispatchEvent(new Event('input')); }
  },
  guardar(){
    const prov=document.getElementById('c-prov').value; const fecha=new Date(document.getElementById('c-fecha').value).toISOString();
    const folio=document.getElementById('c-folio').value; const met=document.getElementById('c-met').value;
    const form=this._formEl(); const items=[...(form?.querySelectorAll('#tbl-citems tbody tr')||[])].map(tr=>({insumoId:tr.children[0].querySelector('select').value,cantidad:Number(tr.children[1].querySelector('input').value||0),unidad:tr.children[2].querySelector('input').value||LocalDB.byId(Data.col.insumos,tr.children[0].querySelector('select').value).unidad,costoUnit:Number(tr.children[3].querySelector('input').value||0)}));
    const total=items.reduce((a,b)=>a+b.cantidad*b.costoUnit,0); const c=Data.add(Data.col.compras,{fechaHora:fecha,proveedorId:prov,metodoPago:met,folio,total});
    items.forEach(it=>{
      const ins=LocalDB.byId(Data.col.insumos,it.insumoId);
      Data.add(Data.col.compras_detalle,{compraId:c.id,insumoId:ins.id,nombre:ins.nombre,cantidad:it.cantidad,unidad:it.unidad,costoUnit:it.costoUnit,subtotal:it.cantidad*it.costoUnit});
      // actualizar inventario + kardex + costoPromedio
      Data.add(Data.col.kardex,{fechaHora:fecha,insumoId:ins.id,tipo:'entrada',cantidad:it.cantidad,costoUnit:it.costoUnit,ref:folio,notas:'Compra', compraId:c.id});
      LocalDB.update(Data.col.insumos, ins.id, {existencia:(ins.existencia||0)+it.cantidad, costoPromedio:it.costoUnit});
    });
    notify('Compra guardada','success'); this.closeForm(); renderInventario(); renderCompras(); renderGastos();
  },
  _revertCompra(id){
    const comp=LocalDB.byId(Data.col.compras,id); if(!comp) return;
    const dets=Data.listBy(Data.col.compras_detalle,d=>d.compraId===id);
    dets.forEach(d=>{
      const ins=LocalDB.byId(Data.col.insumos,d.insumoId); if(!ins) return;
      LocalDB.update(Data.col.insumos, ins.id, {existencia:Math.max(0,(ins.existencia||0)-d.cantidad)});
    });
    // limpiar kardex de la compra (por compraId o por ref/nota)
    const kdx=Data.get(Data.col.kardex);
    kdx.filter(k=> k.compraId===id || (k.ref===comp.folio && k.notas==='Compra'))
       .forEach(k=> Data.del(Data.col.kardex,k.id));
  },
  editar(id){
    const comp=LocalDB.byId(Data.col.compras,id); if(!comp) return;
    const el=document.getElementById('compra-form-embed') || document.getElementById('compra-form'); el.classList.remove('hidden'); this._setForm(el);
    const provs=Data.get(Data.col.proveedores);
    el.innerHTML=`
      <div class="row">
        <label>Proveedor<select id="c-prov">${provs.map(p=>`<option value="${p.id}" ${p.id===comp.proveedorId?'selected':''}>${p.nombre}</option>`).join('')}</select></label>
        <label>Fecha/Hora<input type="datetime-local" id="c-fecha" value="${(comp.fechaHora||'').slice(0,16)}"></label>
        <label>Folio<input id="c-folio" value="${comp.folio||''}"></label>
        <label>Método<select id="c-met"><option ${comp.metodoPago==='Transferencia'?'selected':''}>Transferencia</option><option ${comp.metodoPago==='Efectivo'?'selected':''}>Efectivo</option><option ${comp.metodoPago==='Tarjeta'?'selected':''}>Tarjeta</option></select></label>
      </div>
      <div class="card"><h3>Ítems</h3>
        <table class="table" id="tbl-citems"><thead><tr><th>Insumo</th><th>Cantidad</th><th>Unidad</th><th>Costo Unit</th><th>Subtotal</th><th></th></tr></thead><tbody></tbody></table>
        <div class="toolbar"><button class="btn" onclick="compras.agregarItem()">Agregar ítem</button></div>
      </div>
      <div class="toolbar"><button class="btn primary" onclick="compras.actualizar('${id}')">Actualizar compra</button> <button class="btn ghost" onclick="compras.closeForm()">Cerrar</button></div>
    `;
    // Prefill detalles
    const ins=Data.get(Data.col.insumos);
    const dets=Data.listBy(Data.col.compras_detalle,d=>d.compraId===id);
    const tbody=el.querySelector('#tbl-citems tbody');
    dets.forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><select>${ins.map(i=>`<option value="${i.id}" ${i.id===d.insumoId?'selected':''}>${i.nombre}</option>`).join('')}</select></td>
        <td><input type="number" min="0.001" step="0.001" value="${d.cantidad}"></td>
        <td><input value="${d.unidad||''}" placeholder="g/ml/unid"></td>
        <td><input type="number" min="0" step="0.0001" value="${d.costoUnit}"></td>
        <td class="sub">${fmt.money(d.cantidad*d.costoUnit)}</td>
        <td><button class="btn" onclick="this.closest('tr').remove()">✕</button></td>`;
      tr.addEventListener('input',()=>{
        const qty=Number(tr.children[1].querySelector('input').value||0), cu=Number(tr.children[3].querySelector('input').value||0);
        tr.querySelector('.sub').textContent=fmt.money(qty*cu);
      });
      tbody.appendChild(tr);
    });
  },
  actualizar(id){
    const prov=document.getElementById('c-prov').value; const fecha=new Date(document.getElementById('c-fecha').value).toISOString();
    const folio=document.getElementById('c-folio').value; const met=document.getElementById('c-met').value;
    const form=this._formEl(); const items=[...(form?.querySelectorAll('#tbl-citems tbody tr')||[])].map(tr=>({insumoId:tr.children[0].querySelector('select').value,cantidad:Number(tr.children[1].querySelector('input').value||0),unidad:tr.children[2].querySelector('input').value||LocalDB.byId(Data.col.insumos,tr.children[0].querySelector('select').value).unidad,costoUnit:Number(tr.children[3].querySelector('input').value||0)}));
    // revertir inventario anterior
    compras._revertCompra(id);
    // actualizar compra
    const total=items.reduce((a,b)=>a+b.cantidad*b.costoUnit,0); Data.upd(Data.col.compras,id,{fechaHora:fecha,proveedorId:prov,metodoPago:met,folio,total});
    // limpiar detalles antiguos y re-crear
    Data.get(Data.col.compras_detalle).filter(d=>d.compraId===id).forEach(d=> Data.del(Data.col.compras_detalle,d.id));
    items.forEach(it=>{
      const ins=LocalDB.byId(Data.col.insumos,it.insumoId);
      Data.add(Data.col.compras_detalle,{compraId:id,insumoId:ins.id,nombre:ins.nombre,cantidad:it.cantidad,unidad:it.unidad,costoUnit:it.costoUnit,subtotal:it.cantidad*it.costoUnit});
      Data.add(Data.col.kardex,{fechaHora:fecha,insumoId:ins.id,tipo:'entrada',cantidad:it.cantidad,costoUnit:it.costoUnit,ref:folio,notas:'Compra', compraId:id});
      LocalDB.update(Data.col.insumos, ins.id, {existencia:(ins.existencia||0)+it.cantidad, costoPromedio:it.costoUnit});
    });
    notify('Compra actualizada','success'); this.closeForm(); renderInventario(); renderCompras(); renderGastos();
  },
  eliminar(id){
    if(!confirm('¿Eliminar compra?')) return;
    compras._revertCompra(id);
    // eliminar detalles y compra
    Data.get(Data.col.compras_detalle).filter(d=>d.compraId===id).forEach(d=> Data.del(Data.col.compras_detalle,d.id));
    Data.del(Data.col.compras, id);
    notify('Compra eliminada','success'); renderInventario(); renderCompras(); renderGastos();
  },
  duplicar(id){
    const comp=LocalDB.byId(Data.col.compras,id); if(!comp) return;
    const nuevoFolio=prompt('Folio del duplicado', (comp.folio||'')+'-COPY')||((comp.folio||'')+'-COPY');
    const fecha=new Date().toISOString(); const met=comp.metodoPago; const prov=comp.proveedorId;
    const dets=Data.listBy(Data.col.compras_detalle,d=>d.compraId===id);
    const total=dets.reduce((a,b)=>a+b.cantidad*b.costoUnit,0);
    const c=Data.add(Data.col.compras,{fechaHora:fecha,proveedorId:prov,metodoPago:met,folio:nuevoFolio,total});
    dets.forEach(d=>{
      const ins=LocalDB.byId(Data.col.insumos,d.insumoId);
      Data.add(Data.col.compras_detalle,{compraId:c.id,insumoId:ins.id,nombre:ins.nombre,cantidad:d.cantidad,unidad:d.unidad,costoUnit:d.costoUnit,subtotal:d.cantidad*d.costoUnit});
      Data.add(Data.col.kardex,{fechaHora:fecha,insumoId:ins.id,tipo:'entrada',cantidad:d.cantidad,costoUnit:d.costoUnit,ref:nuevoFolio,notas:'Compra', compraId:c.id});
      LocalDB.update(Data.col.insumos, ins.id, {existencia:(ins.existencia||0)+d.cantidad, costoPromedio:d.costoUnit});
    });
    notify('Compra duplicada','success'); renderInventario(); renderCompras(); renderGastos();
  }
};

/*******************
 * BMC: Gastos      *
 *******************/
const gastos={
  nuevo(){
    const el=document.getElementById('gasto-form'); el.classList.remove('hidden');
    const emps=Data.get(Data.col.empleados);
    el.innerHTML=`
      <div class="row">
        <label>Fecha<input type="date" id="g-fecha" value="${todayISO()}"></label>
        <label>Tipo<select id="g-tipo"><option>Insumos</option><option>Productos</option><option>Luz</option><option>Nómina</option><option>Contabilidad</option><option>Propina</option><option>Marketing</option><option>Impuestos</option><option>Renta</option><option>Seguridad</option><option>Transporte</option><option>Mantenimiento</option><option>Otros</option></select></label>
        <label class="grow empleado-field hidden">Empleado<select id="g-emp"><option value="">(Selecciona)</option>${emps.map(e=>`<option value='${e.id}'>${e.nombre}${e.sueldoHora?` · $${e.sueldoHora}/h`:''}</option>`).join('')}</select></label>
        <label class="grow">Descripción<input id="g-desc"></label>
        <label class="grow">Proveedor<select id="g-prov"><option value="">(N/A)</option>${Data.get(Data.col.proveedores).map(p=>`<option value='${p.id}'>${p.nombre}</option>`).join('')}</select></label>
        <label>Pagado por<input id="g-pay"></label>
        <label>Método<select id="g-met"><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></label>
        <label>Importe<input type="number" id="g-imp" step="0.01" min="0"></label>
        <label>Folio<input id="g-folio"></label>
      </div>
      <div class="toolbar"><button class="btn primary" onclick="gastos.guardar()">Guardar gasto</button> <button class="btn ghost" onclick="document.getElementById('gasto-form').classList.add('hidden')">Cerrar</button></div>
    `;
    // toggle nómina UI
    const tipoSel=el.querySelector('#g-tipo'); const empWrap=el.querySelector('.empleado-field'); const empSel=el.querySelector('#g-emp'); const desc=el.querySelector('#g-desc');
    const sync=()=>{ const nom=tipoSel.value==='Nómina'; empWrap.classList.toggle('hidden', !nom); if(nom && empSel.value && !desc.value){ const e=LocalDB.byId(Data.col.empleados, empSel.value); if(e) desc.value=e.nombre; } };
    tipoSel.addEventListener('change', sync); empSel.addEventListener('change', sync); sync();
  },
  guardar(){
    const tipo=document.getElementById('g-tipo').value; let empleadoId=null; if(tipo==='Nómina'){ empleadoId=document.getElementById('g-emp').value||null; if(!empleadoId){ alert('Selecciona un empleado para la nómina'); return; } }
    const desc=document.getElementById('g-desc').value || (empleadoId? (LocalDB.byId(Data.col.empleados,empleadoId)?.nombre||'') : '');
    Data.add(Data.col.gastos,{fecha:document.getElementById('g-fecha').value,tipo,empleadoId,descripcion:desc,proveedorId:document.getElementById('g-prov').value||null,pagadoPor:document.getElementById('g-pay').value,metodoPago:document.getElementById('g-met').value,importe:Number(document.getElementById('g-imp').value||0),folio:document.getElementById('g-folio').value});
    notify('Gasto guardado','success'); document.getElementById('gasto-form').classList.add('hidden'); renderGastos(); renderDashboard();
  },
  editar(id){
    const g=LocalDB.byId(Data.col.gastos,id); if(!g) return;
    const el=document.getElementById('gasto-form'); el.classList.remove('hidden');
    const provs=Data.get(Data.col.proveedores); const emps=Data.get(Data.col.empleados);
    el.innerHTML=`
      <div class="row">
        <label>Fecha<input type="date" id="g-fecha" value="${g.fecha}"></label>
        <label>Tipo<select id="g-tipo"><option ${g.tipo==='Insumos'?'selected':''}>Insumos</option><option ${g.tipo==='Productos'?'selected':''}>Productos</option><option ${g.tipo==='Luz'?'selected':''}>Luz</option><option ${g.tipo==='Nómina'?'selected':''}>Nómina</option><option ${g.tipo==='Contabilidad'?'selected':''}>Contabilidad</option><option ${g.tipo==='Propina'?'selected':''}>Propina</option><option ${g.tipo==='Marketing'?'selected':''}>Marketing</option><option ${g.tipo==='Impuestos'?'selected':''}>Impuestos</option><option ${g.tipo==='Renta'?'selected':''}>Renta</option><option ${g.tipo==='Seguridad'?'selected':''}>Seguridad</option><option ${g.tipo==='Transporte'?'selected':''}>Transporte</option><option ${g.tipo==='Mantenimiento'?'selected':''}>Mantenimiento</option><option ${g.tipo==='Otros'?'selected':''}>Otros</option></select></label>
        <label class="grow empleado-field ${g.tipo==='Nómina'?'':'hidden'}">Empleado<select id="g-emp"><option value="">(Selecciona)</option>${emps.map(e=>`<option value='${e.id}' ${g.empleadoId===e.id?'selected':''}>${e.nombre}${e.sueldoHora?` · $${e.sueldoHora}/h`:''}</option>`).join('')}</select></label>
        <label class="grow">Descripción<input id="g-desc" value='${g.descripcion||''}'></label>
        <label class="grow">Proveedor<select id="g-prov"><option value="">(N/A)</option>${provs.map(p=>`<option value='${p.id}' ${g.proveedorId===p.id?'selected':''}>${p.nombre}</option>`).join('')}</select></label>
        <label>Pagado por<input id="g-pay" value='${g.pagadoPor||''}'></label>
        <label>Método<select id="g-met"><option ${g.metodoPago==='Efectivo'?'selected':''}>Efectivo</option><option ${g.metodoPago==='Tarjeta'?'selected':''}>Tarjeta</option><option ${g.metodoPago==='Transferencia'?'selected':''}>Transferencia</option></select></label>
        <label>Importe<input type="number" id="g-imp" step="0.01" min="0" value='${g.importe}'></label>
        <label>Folio<input id="g-folio" value='${g.folio||''}'></label>
      </div>
      <div class="toolbar"><button class="btn primary" onclick="gastos.actualizar('${id}')">Actualizar gasto</button> <button class="btn ghost" onclick="document.getElementById('gasto-form').classList.add('hidden')">Cerrar</button></div>
    `;
    // toggle
    const tipoSel=el.querySelector('#g-tipo'); const empWrap=el.querySelector('.empleado-field'); const empSel=el.querySelector('#g-emp'); const desc=el.querySelector('#g-desc');
    const sync=()=>{ const nom=tipoSel.value==='Nómina'; empWrap.classList.toggle('hidden', !nom); if(nom && empSel?.value && !desc.value){ const e=LocalDB.byId(Data.col.empleados, empSel.value); if(e) desc.value=e.nombre; } };
    tipoSel.addEventListener('change', sync); empSel?.addEventListener('change', sync); sync();
  },
  actualizar(id){
    const tipo=document.getElementById('g-tipo').value; let empleadoId=null; if(tipo==='Nómina'){ empleadoId=document.getElementById('g-emp').value||null; if(!empleadoId){ alert('Selecciona un empleado para la nómina'); return; } }
    const desc=document.getElementById('g-desc').value || (empleadoId? (LocalDB.byId(Data.col.empleados,empleadoId)?.nombre||'') : '');
    Data.upd(Data.col.gastos,id,{fecha:document.getElementById('g-fecha').value,tipo,empleadoId,descripcion:desc,proveedorId:document.getElementById('g-prov').value||null,pagadoPor:document.getElementById('g-pay').value,metodoPago:document.getElementById('g-met').value,importe:Number(document.getElementById('g-imp').value||0),folio:document.getElementById('g-folio').value});
    notify('Gasto actualizado','success'); document.getElementById('gasto-form').classList.add('hidden'); renderGastos(); renderDashboard();
  },
  duplicar(id){
    const g=LocalDB.byId(Data.col.gastos,id); if(!g) return; const fecha=prompt('Fecha para el duplicado (YYYY-MM-DD)', g.fecha)||g.fecha;
    Data.add(Data.col.gastos,{...g,id:undefined,fecha});
    notify('Gasto duplicado','success'); renderGastos(); renderDashboard();
  },
  eliminar(id){
    if(!confirm('¿Eliminar gasto?')) return; Data.del(Data.col.gastos,id); notify('Gasto eliminado','success'); renderGastos(); renderDashboard();
  }
  ,eliminarAjuste(id){ if(!confirm('¿Eliminar ajuste?')) return; Data.del(Data.col.ajustes,id); notify('Ajuste eliminado','success'); renderGastos(); renderDashboard(); }
};

/*******************
 * BMC: Cortes      *
 *******************/
const cortes={
  manual(){
    const el=document.getElementById('corte-form'); el.classList.remove('hidden');
    el.innerHTML=`
      <div class="row">
        <label>Fecha<input type="date" id="co-fecha" value="${todayISO()}"></label>
        <label>Turno<input id="co-turno" placeholder="Matutino"></label>
        <label>Efectivo<input type="number" id="co-ef" step="0.01" min="0"></label>
        <label>Tarjeta<input type="number" id="co-tj" step="0.01" min="0"></label>
        <label>Vales<input type="number" id="co-va" step="0.01" min="0"></label>
        <label>Propinas<input type="number" id="co-pr" step="0.01" min="0"></label>
        <label>Cancelaciones<input type="number" id="co-ca" step="0.01" min="0"></label>
        <label>Devoluciones<input type="number" id="co-de" step="0.01" min="0"></label>
      </div>
      <div class="toolbar"><button class="btn primary" onclick="cortes.guardar()">Guardar corte</button> <button class="btn ghost" onclick="document.getElementById('corte-form').classList.add('hidden')">Cerrar</button></div>
    `;
  },
  guardar(){
    const fecha=document.getElementById('co-fecha').value, turno=document.getElementById('co-turno').value;
    const ef=Number(document.getElementById('co-ef').value||0), tj=Number(document.getElementById('co-tj').value||0), va=Number(document.getElementById('co-va').value||0), pr=Number(document.getElementById('co-pr').value||0), ca=Number(document.getElementById('co-ca').value||0), de=Number(document.getElementById('co-de').value||0);
    // Calcular diferencia simple contra ventas del día
    const ventasDia=Data.get(Data.col.ventas_ticket).filter(t=> t.fechaHora.slice(0,10)===fecha).reduce((a,b)=>a+b.total,0);
    const reportado=ef+tj+va+pr - ca - de; const dif= reportado - ventasDia;
    Data.add(Data.col.cortes,{fecha,turno,efectivo:ef,tarjeta:tj,vales:va,propinas:pr,cancelaciones:ca,devoluciones:de,diferencia:dif,notas:''});
    notify('Corte guardado','success'); document.getElementById('corte-form').classList.add('hidden'); renderCortes();
  },
  async cerrarTurno(){
    notify('Turno cerrado (snapshot lógico).','success');
  }
};

async function importCortePdf(file){
  try{
    if(!file) return; const ab=await file.arrayBuffer(); const pdf=await pdfjsLib.getDocument({data:ab}).promise;
    let text=''; for(let p=1;p<=pdf.numPages;p++){ const page=await pdf.getPage(p); const t=await page.getTextContent(); text+= t.items.map(i=>i.str).join(' ')+'\n'; }
    // heurísticas simples (ajusta a tu formato)
    const num=(lab)=>{const m=new RegExp(lab+"[:\n\r\t ]*\$?([\d,.]+)","i").exec(text); return m? Number(m[1].replace(/[^\d.]/g,'')) : 0};
    const ef=num('Efectivo'), tj=num('Tarjeta'), va=num('Vales'), pr=num('Propinas'), ca=num('Cancelaciones'), de=num('Devoluciones');
    document.getElementById('corte-form').classList.remove('hidden');
    document.getElementById('corte-form').innerHTML=`<div class='row'>
      <label>Fecha<input type='date' id='co-fecha' value='${todayISO()}'></label>
      <label>Turno<input id='co-turno' value='Matutino'></label>
      <label>Efectivo<input type='number' id='co-ef' value='${ef}'></label>
      <label>Tarjeta<input type='number' id='co-tj' value='${tj}'></label>
      <label>Vales<input type='number' id='co-va' value='${va}'></label>
      <label>Propinas<input type='number' id='co-pr' value='${pr}'></label>
      <label>Cancelaciones<input type='number' id='co-ca' value='${ca}'></label>
      <label>Devoluciones<input type='number' id='co-de' value='${de}'></label>
    </div>
    <div class='toolbar'><button class='btn primary' onclick='cortes.guardar()'>Guardar corte</button></div>`;
    notify('PDF leído (verifica campos)','success');
  }catch(e){console.error(e); notify('No se pudo parsear el PDF. Usa entrada manual.','error'); cortes.manual();}
}

/*******************
 * BMC: Agenda      *
 *******************/
const agenda={
  nuevo(){
    const fecha=prompt('Fecha (YYYY-MM-DD)', todayISO()); if(!fecha) return; const titulo=prompt('Título (Insumos, Certificados, Mantenimiento)','Mantenimiento'); const notas=prompt('Notas','');
    Data.add(Data.col.clientes,{}) // noop to ensure col exists
    const ev=Data.add('agenda'||'agenda',{fecha,titulo,notas}); // safekeep
    // guardamos en cortes como placeholder para lista simple si agenda no existe
    const tag=Data.add('agenda_items'||'agenda_items',{id:ev.id,fecha,titulo,notas});
    renderAgenda();
  }
};

/*******************
 * BMC: Catálogos   *
 *******************/
const catalogos={
  editar(col){
    const map={proveedores:'Proveedores',estaciones:'Estaciones',empleados:'Empleados',clientes:'Clientes',insumos:'Insumos',recetas:'Productos/Recetas'};
    const el=document.getElementById('catalogo-modal'); el.classList.remove('hidden');
    const rows=Data.get(Data.col[col]||col);
    // Columnas por colección (evitar editar id)
    let cols = Object.keys(rows[0]||{nombre:'Nombre'}).filter(k=> k!=='id');
    if(col==='empleados'){ cols=['nombre','rol','sueldoHora','agradecimiento']; rows.forEach(r=>{ const patch={}; if(r.sueldoHora==null) patch.sueldoHora=0; if(r.agradecimiento==null) patch.agradecimiento='Gracias por tu trabajo esta semana.'; if(Object.keys(patch).length) Data.upd(Data.col[col], r.id, patch); }); }
    el.innerHTML=`<h3>${map[col]||col}</h3>
      <div class='toolbar'><button class='btn' onclick="catalogos.nuevo('${col}')">Nuevo</button> <button class='btn ghost' onclick="document.getElementById('catalogo-modal').classList.add('hidden')">Cerrar</button></div>
      <table class='table'><thead><tr>${cols.map(k=>`<th>${k}</th>`).join('')}<th>Horario</th><th></th></tr></thead>
      <tbody>${rows.map(r=>`<tr>${cols.map(k=>`<td contenteditable data-k='${k}' data-id='${r.id}'>${r[k]??''}</td>`).join('')}<td><button class='btn' onclick="catalogos.horario('${r.id}')">⏰ Editar</button></td><td><button class='btn' onclick="catalogos.borrar('${col}','${r.id}')">✕</button></td></tr>`).join('')}</tbody></table>`;
    el.querySelectorAll('td[contenteditable]').forEach(td=> td.addEventListener('blur', e=>{ const id=td.dataset.id; const k=td.dataset.k; let val=td.innerText.trim(); if(col==='empleados' && k==='sueldoHora'){ val=Number(val||0); } Data.upd(Data.col[col]||col,id,{[k]:val}); }));
  },
  horario(id){
    const el=document.getElementById('catalogo-modal'); const emp=LocalDB.byId(Data.col.empleados,id); if(!emp) return;
    const h=emp.horario||{}; const val=(k)=> h[k]?.ini||''; const val2=(k)=> h[k]?.fin||'';
    const row=(lab,key)=>`<tr><td>${lab}</td><td><input type='time' id='h-${key}-ini' value='${val(key)}'></td><td><input type='time' id='h-${key}-fin' value='${val2(key)}'></td></tr>`;
    el.innerHTML=`<h3>Horario habitual — ${emp.nombre}</h3>
      <div class='toolbar'><button class='btn primary' onclick="catalogos.guardarHorario('${id}')">Guardar</button> <button class='btn ghost' onclick="catalogos.editar('empleados')">Volver</button></div>
      <table class='table'><thead><tr><th>Día</th><th>Entrada</th><th>Salida</th></tr></thead>
      <tbody>
        ${row('Lunes','lun')}
        ${row('Martes','mar')}
        ${row('Miércoles','mie')}
        ${row('Jueves','jue')}
        ${row('Viernes','vie')}
        ${row('Sábado','sab')}
        ${row('Domingo','dom')}
      </tbody></table>`;
  },
  guardarHorario(id){
    const get=(k)=>({ini:document.getElementById('h-'+k+'-ini')?.value||'', fin:document.getElementById('h-'+k+'-fin')?.value||''});
    const horario={lun:get('lun'),mar:get('mar'),mie:get('mie'),jue:get('jue'),vie:get('vie'),sab:get('sab'),dom:get('dom')};
    Data.upd(Data.col.empleados,id,{horario});
    notify('Horario guardado','success');
    catalogos.editar('empleados');
  },
  nuevo(col){
    if(col==='empleados'){ Data.add(Data.col[col],{nombre:'Nuevo',rol:'',sueldoHora:0}); }
    else { Data.add(Data.col[col]||col,{nombre:'Nuevo'}); }
    catalogos.editar(col);
  },
  borrar(col,id){ Data.del(Data.col[col]||col,id); catalogos.editar(col); }
};

/*******************
 * BMC: Exports     *
 *******************/
const exportCSV={
  ventas(){
    const t=Data.get(Data.col.ventas_ticket).map(x=>({fechaHora:x.fechaHora,folio:x.folio,estacionId:x.estacionId,baristaId:x.baristaId,subtotal:x.subtotal,impuestos:x.impuestos,total:x.total,metodoPago:x.metodoPago}));
    const d=Data.get(Data.col.ventas_detalle).map(x=>({ticketId:x.ticketId,sku:x.sku,descripcion:x.descripcion,cantidad:x.cantidad,precioUnit:x.precioUnit,subtotal:x.subtotal}));
    download('ventas_ticket.csv',toCSV(t)); download('ventas_detalle.csv',toCSV(d));
  },
  compras(){
    const c=Data.get(Data.col.compras); const cd=Data.get(Data.col.compras_detalle); download('compras.csv',toCSV(c)); download('compras_detalle.csv',toCSV(cd));
  },
  gastos(){ download('gastos.csv',toCSV(Data.get(Data.col.gastos))); },
  kardex(){ download('kardex.csv',toCSV(Data.get(Data.col.kardex))); },
  dashboard(){
    const resumen = calcKPIs().resumenPeriodo;
    download('dashboard_resumen.csv', toCSV(resumen));
  }
};

/*******************
 * BMC: Backup      *
 *******************/
const backup={
  export(){
    try{
      const store=Object.fromEntries(
        Object.keys(localStorage)
          .filter(k=>k.startsWith(LocalDB.ns))
          .map(k=>[k, localStorage.getItem(k)])
      );
      const data={cfg, store};
      download('bm_backup.json', JSON.stringify(data,null,2), 'application/json');
      notify('Backup exportado','success');
    }catch(e){
      notify('Error exportando backup: '+e.message,'error');
    }
  },
  async import(file){
    try{
      const text=await file.text();
      const data=JSON.parse(text);
      if(data.store && typeof data.store==='object'){
        Object.entries(data.store).forEach(([k,v])=>{
          if(typeof v==='string'){ localStorage.setItem(k,v); }
          else { localStorage.setItem(k, JSON.stringify(v)); }
        });
      }
      const cfgKey=LocalDB.key('cfg');
      if(data.cfg && typeof data.cfg==='object'){
        cfg={...cfg, ...data.cfg};
        localStorage.setItem(cfgKey, JSON.stringify(cfg));
      }else{
        const storedCfg=localStorage.getItem(cfgKey);
        if(storedCfg){
          try{ cfg=JSON.parse(storedCfg); }catch(_){}
        }
      }
      document.getElementById('mode-badge').textContent = 'Modo: '+(cfg.modo||'local');
      notify('Backup importado','success');
      renderAll();
    }
    catch(e){ notify('Error importando backup: '+e.message,'error') }
  }
};

/*******************
 * BMC: Dashboard   *
 *******************/
const DASH_PLATFORMS=['Uber','Rappi'];
const getDashboardChannel=()=> document.getElementById('dash-origen')?.value || 'todos';
const matchesDashboardChannel=(ticket, channel)=>{
  const metodo=String(ticket.metodoPago||'');
  if(channel==='todos') return true;
  if(channel==='local') return !DASH_PLATFORMS.includes(metodo);
  if(channel==='plataformas') return DASH_PLATFORMS.includes(metodo);
  return metodo===channel;
};
function computeRangePreset(preset){
  const hoy=todayISO();
  const base=new Date(hoy+'T00:00:00');
  if(preset==='7'){
    return {desde:addDaysISO(hoy,-6), hasta:hoy};
  }
  if(preset==='30'){
    return {desde:addDaysISO(hoy,-29), hasta:hoy};
  }
  if(preset==='mes'){
    const first=new Date(base.getFullYear(), base.getMonth(), 1);
    const last=new Date(base.getFullYear(), base.getMonth()+1, 0);
    return {desde:localDateISO(first), hasta:localDateISO(last)};
  }
  if(preset==='mesPasado'){
    const first=new Date(base.getFullYear(), base.getMonth()-1, 1);
    const last=new Date(base.getFullYear(), base.getMonth(), 0);
    return {desde:localDateISO(first), hasta:localDateISO(last)};
  }
  return null;
}
function weekRangeFromISOWeek(isoWeek){
  if(!isoWeek || !/^(\d{4})-W(\d{2})$/.test(isoWeek)) return null;
  const [, yearStr, weekStr]=isoWeek.match(/^(\d{4})-W(\d{2})$/);
  const year=Number(yearStr); const week=Number(weekStr);
  if(!year || !week) return null;
  const simple=new Date(year,0,1 + (week-1)*7);
  const day=(simple.getDay()+6)%7; // 0 = Monday
  simple.setDate(simple.getDate()-day);
  const monday=new Date(simple);
  const sunday=new Date(monday);
  sunday.setDate(monday.getDate()+6);
  return {desde:localDateISO(monday), hasta:localDateISO(sunday)};
}
function isoWeekFromDate(date){
  const d=new Date(date);
  d.setHours(0,0,0,0);
  d.setDate(d.getDate()+3-((d.getDay()+6)%7));
  const week1=new Date(d.getFullYear(),0,4);
  const weekNumber=1+Math.round(((d - week1)/86400000 -3 + ((week1.getDay()+6)%7))/7);
  return `${d.getFullYear()}-W${String(weekNumber).padStart(2,'0')}`;
}
function currentISOWeek(){
  return isoWeekFromDate(new Date());
}
function matchPresetForRange(desde, hasta){
  if(!desde || !hasta) return '';
  const presets=['mes','mesPasado','30','7'];
  for(const key of presets){
    const range=computeRangePreset(key);
    if(range && range.desde===desde && range.hasta===hasta) return key;
  }
  const today=todayISO();
  if(desde===today && hasta===addDaysISO(today,6)) return 'prox7';
  return '';
}
function setQuickPresetActive(containerId, preset){
  const wrap=document.getElementById(containerId);
  if(!wrap) return;
  wrap.querySelectorAll('button[data-preset]').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.preset===preset);
  });
}
function setDashboardRange(preset){
  const desdeEl=document.getElementById('dash-desde');
  const hastaEl=document.getElementById('dash-hasta');
  if(!desdeEl || !hastaEl) return;
  const range=computeRangePreset(preset);
  if(!range) return;
  setQuickPresetActive('dash-quick', preset);
  desdeEl.value=range.desde;
  hastaEl.value=range.hasta;
  renderDashboard();
}
function setGastosRange(preset){
  const desdeEl=document.getElementById('g-desde');
  const hastaEl=document.getElementById('g-hasta');
  if(!desdeEl || !hastaEl) return;
  const range=computeRangePreset(preset);
  if(!range) return;
  setQuickPresetActive('gastos-quick', preset);
  desdeEl.value=range.desde;
  hastaEl.value=range.hasta;
  renderGastos();
}
function calcKPIs(){
  const desde=document.getElementById('dash-desde').value, hasta=document.getElementById('dash-hasta').value;
  const canal=getDashboardChannel();
  const tickets=Data.get(Data.col.ventas_ticket).filter(t=> inRange(t.fechaHora,desde,hasta) && matchesDashboardChannel(t, canal));
  const ventas=tickets.reduce((sum,t)=> sum + Number(t.total||0),0);
  const ticketCount=tickets.length;
  const ticketProm = ticketCount? ventas/ticketCount : 0;
  const propinas=tickets.reduce((sum,t)=> sum + Number(t.propina||0),0);
  const gastos=Data.get(Data.col.gastos).filter(g=> inRange(g.fecha,desde,hasta)).reduce((sum,g)=>sum+Number(g.importe||0),0);
  // Costo insumos (simplificado): sumar salidas en kardex
  const costos=Data.get(Data.col.kardex).filter(k=> k.tipo==='salida' && inRange(k.fechaHora,desde,hasta)).reduce((sum,k)=>sum+(k.cantidad*k.costoUnit),0);
  // Ventas por método y cálculo de ingresos netos (plataformas retienen 35%)
  const plataformas=['Uber','Rappi'];
  const porMetodo={};
  const ingresosPorMetodo={};
  const tipsPorMetodo={};
  tickets.forEach(t=>{
    const metodo=String(t.metodoPago||'N/D');
    const total=Number(t.total||0);
    const tip=Number(t.propina||0);
    porMetodo[metodo]=(porMetodo[metodo]||0)+total;
    tipsPorMetodo[metodo]=(tipsPorMetodo[metodo]||0)+tip;
    const neto=plataformas.includes(metodo)? total*0.65 : total;
    ingresosPorMetodo[metodo]=(ingresosPorMetodo[metodo]||0)+neto;
  });
  const plataformasTotal = plataformas.reduce((sum,p)=> sum + (porMetodo[p]||0), 0);
  const aRecibir=Object.fromEntries(plataformas.map(p=>[p, ingresosPorMetodo[p]||0]));
  const aRecibirTotal = plataformas.reduce((sum,p)=> sum + (ingresosPorMetodo[p]||0), 0);
  const comisionesPlataformas = plataformas.reduce((acc,p)=>{
    const bruto=porMetodo[p]||0;
    const neto=ingresosPorMetodo[p]||0;
    return acc + Math.max(0, bruto - neto);
  },0);
  const ingresosNetos = Object.values(ingresosPorMetodo).reduce((sum,val)=>sum+val,0);
  const utilidad= ingresosNetos - costos - gastos;
  const margen = ingresosNetos? (utilidad/ingresosNetos*100):0;
  // Gastos por método para saldos
  const gastosFiltrados=Data.get(Data.col.gastos).filter(g=> inRange(g.fecha,desde,hasta));
  const gastosPorMetodo={Efectivo:0,Tarjeta:0};
  gastosFiltrados.forEach(g=>{ const m=String(g.metodoPago||''); if(m==='Efectivo'){ gastosPorMetodo['Efectivo']+= Number(g.importe||0); } else if(m==='Tarjeta' || m==='Transferencia'){ gastosPorMetodo['Tarjeta']+= Number(g.importe||0); } });
  // Ajustes (no gastos contables): afectan saldo pero no gastos/utilidad
  const aj=Data.get(Data.col.ajustes).filter(a=> inRange(a.fecha,desde,hasta));
  const adjEf=aj.filter(a=> a.cuenta==='Efectivo').reduce((s,a)=> s + Number(a.entrada||0) - Number(a.salida||0), 0);
  const adjBk=aj.filter(a=> a.cuenta==='Banco' || a.cuenta==='Tarjeta').reduce((s,a)=> s + Number(a.entrada||0) - Number(a.salida||0), 0);
  // Depósitos programados plataformas (Uber: lunes siguiente; Rappi: viernes siguiente)
  const ds = dailySeries();
  const weekKey=(iso)=>{ const d=new Date(iso+'T00:00:00'); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); return d.toISOString().slice(0,10); }
  const mondayNext=(iso)=>{ const d=new Date(iso+'T00:00:00'); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day+7); return d.toISOString().slice(0,10); }
  const fridayOfWeek=(iso)=>{ const d=new Date(iso+'T00:00:00'); const dow=d.getDay(); const diff=(5 - dow + 7)%7; d.setDate(d.getDate()+diff); return d.toISOString().slice(0,10); }
  const nextFriday=(iso)=>{ const d=new Date(iso+'T00:00:00'); d.setDate(d.getDate()+7); return d.toISOString().slice(0,10); }
  const accU={}, accR={}; ds.labels.forEach((d,i)=>{ accU[weekKey(d)]=(accU[weekKey(d)]||0)+(ds.dataByMethod['Uber'][i]||0); const fri=fridayOfWeek(d); accR[fri]=(accR[fri]||0)+(ds.dataByMethod['Rappi'][i]||0); });
  let depsPlat=0; const today=todayISO(); let pendUber=0, pendRappi=0; let nextUDate='', nextUAmount=0, nextRDate='', nextRAmount=0;
  Object.entries(accU).forEach(([wk,sum])=>{ const depDate=mondayNext(wk); const amt=sum*0.65; if(inRange(depDate,desde,hasta)) depsPlat+= amt; if(depDate>today) { pendUber+=amt; if(!nextUDate || depDate<nextUDate){ nextUDate=depDate; nextUAmount=amt; } } });
  Object.entries(accR).forEach(([fri,sum])=>{ const depDate=nextFriday(fri); const amt=sum*0.65; if(inRange(depDate,desde,hasta)) depsPlat+= amt; if(depDate>today) { pendRappi+=amt; if(!nextRDate || depDate<nextRDate){ nextRDate=depDate; nextRAmount=amt; } } });
  const comisionTarjeta = (porMetodo['Tarjeta']||0)*0.0406;
  const saldoEfectivo=(cfg.saldoIniEfectivo||0) + (porMetodo['Efectivo']||0) - gastosPorMetodo['Efectivo'] + adjEf;
  const saldoTarjeta=(cfg.saldoIniBanco||0) + (porMetodo['Tarjeta']||0) - comisionTarjeta + depsPlat - gastosPorMetodo['Tarjeta'] + adjBk;
  // Serie diaria (para KPIs per-day)
  const dias=Array.from(new Set(tickets.map(t=> businessDateISO(t.fechaHora)))).sort();
  const ventasPorDia = dias.map(d=> tickets.filter(t=> businessDateISO(t.fechaHora)===d).reduce((a,b)=>a+b.total,0));
  const tipsPorDia = dias.map(d=> tickets.filter(t=> businessDateISO(t.fechaHora)===d).reduce((a,b)=>a+Number(b.propina||0),0));
  const nDias = dias.length || 0;
  const promDiario = nDias? ventasPorDia.reduce((a,b)=>a+b,0)/nDias : 0;
  const tipsPromDiario = nDias? tipsPorDia.reduce((a,b)=>a+b,0)/nDias : 0;
  const maxDiario = nDias? Math.max(...ventasPorDia) : 0;
  const minDiario = nDias? Math.min(...ventasPorDia) : 0;
  const medianaDiaria = (function(){ if(!nDias) return 0; const s=[...ventasPorDia].sort((a,b)=>a-b); const m=Math.floor(s.length/2); return s.length%2? s[m] : (s[m-1]+s[m])/2; })();
  const tipsPct = ventas? (propinas/ventas*100): 0;
  const tipsEfectivo = tipsPorMetodo['Efectivo']||0;
  const tipsTarjeta  = tipsPorMetodo['Tarjeta']||0;
  const tipsPlataformas = (tipsPorMetodo['Uber']||0) + (tipsPorMetodo['Rappi']||0);
  // Top SKUs
  const top={}; // no aplica en modo totales diarios
  // Resumen por periodo (mes)
  const group=document.getElementById('dash-group').value||'mes';
  const key=(dt)=>{const d=new Date(dt); if(group==='semana'){const wk=Math.ceil((((d-new Date(d.getFullYear(),0,1))/86400000)+d.getDay()+1)/7);return d.getFullYear()+"-W"+wk}
                   if(group==='dia') return d.toISOString().slice(0,10); return d.getFullYear()+"-"+(String(d.getMonth()+1).padStart(2,'0'))};
  const res={};
  tickets.forEach(t=>{
    const k=key(t.fechaHora);
    if(!res[k]) res[k]={Ventas:0,Comision:0,Ingresos:0,Costos:0,Gastos:0,Utilidad:0};
    const total=Number(t.total||0);
    const metodo=String(t.metodoPago||'N/D');
    const neto=plataformas.includes(metodo)? total*0.65 : total;
    res[k].Ventas+=total;
    res[k].Ingresos+=neto;
    const com=total - neto;
    if(com>0) res[k].Comision+=com;
  });
  Data.get(Data.col.kardex).filter(k=>k.tipo==='salida').forEach(k=>{const kkey=key(k.fechaHora); if(res[kkey]) res[kkey].Costos+=(k.cantidad*k.costoUnit)});
  Data.get(Data.col.gastos).forEach(g=>{const gkey=key(g.fecha+'T00:00:00'); if(res[gkey]) res[gkey].Gastos+=(Number(g.importe)||0)});
  Object.values(res).forEach(r=> r.Utilidad = r.Ingresos - r.Costos - r.Gastos);
  const idxMax = nDias? ventasPorDia.indexOf(maxDiario) : -1;
  const idxMin = nDias? ventasPorDia.indexOf(minDiario) : -1;
  const bestDay = idxMax>=0? {date:dias[idxMax], total:maxDiario, delta:maxDiario - promDiario} : null;
  const quietDay = idxMin>=0? {date:dias[idxMin], total:minDiario, delta:minDiario - promDiario} : null;
  const methodEntries = Object.entries(porMetodo).filter(([,val])=> val>0);
  let bestMethod=null;
  if(methodEntries.length){
    methodEntries.sort((a,b)=> b[1]-a[1]);
    const [name,value]=methodEntries[0];
    const netVal=ingresosPorMetodo[name]||value;
    bestMethod={name,value,share: ingresosNetos? (netVal/ingresosNetos*100):0};
  }
  const channelLabels={todos:'Todos los canales',local:'Punto de venta',plataformas:'Plataformas',Efectivo:'Efectivo',Tarjeta:'Tarjeta',Uber:'Uber',Rappi:'Rappi'};
  const derivedStart = desde || dias[0] || '';
  const derivedEnd = hasta || dias[dias.length-1] || derivedStart;
  const startDate = derivedStart? normalizeDateInput(derivedStart):null;
  const endDate = derivedEnd? normalizeDateInput(derivedEnd):null;
  let rangeDays = (startDate && endDate)? Math.max(1, Math.round((endDate - startDate)/86400000)+1) : (nDias||0);
  if(!Number.isFinite(rangeDays) || rangeDays<=0) rangeDays = nDias||0;
  const rangeLabel = (startDate && endDate)? `${localDateDMY(startDate)} - ${localDateDMY(endDate)}` : 'Todo el histórico';
  const range={label:rangeLabel, days:rangeDays, channel:channelLabels[canal]||'Todos los canales'};
  return {ventas,ingresosNetos,propinas,margen,costos,gastos,utilidad, porMetodo, ingresosPorMetodo, tipsPorMetodo, aRecibir, plataformasTotal, aRecibirTotal, comisionesPlataformas, gastosPorMetodo, saldoEfectivo, saldoTarjeta, pendUber, pendRappi, nextUDate, nextUAmount, nextRDate, nextRAmount, dias:nDias, promDiario:max0(promDiario), tipsPromDiario:max0(tipsPromDiario), maxDiario, minDiario, medianaDiaria, tipsPct, tipsEfectivo, tipsTarjeta, tipsPlataformas, top, ticketPromedio:ticketProm, ticketCount, resumenPeriodo: Object.entries(res).map(([Periodo,v])=>({Periodo,...v})), bestDay, quietDay, bestMethod, range};
}

function renderDashboard(){
  const dashDesde=document.getElementById('dash-desde')?.value||'';
  const dashHasta=document.getElementById('dash-hasta')?.value||'';
  setQuickPresetActive('dash-quick', matchPresetForRange(dashDesde, dashHasta));
  const k=calcKPIs();
  window._dashboardInsights = k;
  const grid=document.getElementById('kpi-grid');
  const perdidas=k.resumenPeriodo.filter(r=> Number(r.Utilidad||0)<0).length;
  const part=(m)=> k.ingresosNetos? ((k.ingresosPorMetodo?.[m]||0)/k.ingresosNetos*100) : 0;
  const deltaLabel=(v)=>{ if(typeof v!=='number' || !Number.isFinite(v)) return ''; if(Math.abs(v)<0.005) return fmt.money(0); const sign=v>0?'+':'-'; return `${sign}${fmt.money(Math.abs(v))}`; };
  const bestDayTotal = k.bestDay? fmt.money(k.bestDay.total):'--';
  const bestDaySub = k.bestDay? `${fmt.dateOnly(k.bestDay.date)} · ${deltaLabel(k.bestDay.delta)}`:'Sin datos';
  const bestMethodName = k.bestMethod? k.bestMethod.name:'--';
  const bestMethodSub = k.bestMethod? `${fmt.money(k.bestMethod.value)} · ${fmt.num(k.bestMethod.share)}%`:'Sin datos';
  const nextUberLabel = k.nextUDate? fmt.dateOnly(k.nextUDate):'-';
  const nextUberCard = (k.nextUDate||k.nextUAmount)? `${nextUberLabel}${k.nextUAmount? ' · '+fmt.money(k.nextUAmount):''}`:'-';
  const nextRappiLabel = k.nextRDate? fmt.dateOnly(k.nextRDate):'-';
  const nextRappiCard = (k.nextRDate||k.nextRAmount)? `${nextRappiLabel}${k.nextRAmount? ' · '+fmt.money(k.nextRAmount):''}`:'-';
  const rangeEl=document.getElementById('dash-meta');
  if(rangeEl){
    const quietSub = k.quietDay? `${fmt.dateOnly(k.quietDay.date)} · ${deltaLabel(k.quietDay.delta)}`:'Sin datos';
    rangeEl.innerHTML=`
      <span><strong>Rango:</strong> ${k.range.label}</span>
      <span><strong>Días analizados:</strong> ${k.range.days||0}</span>
      <span><strong>Canal:</strong> ${k.range.channel}</span>
      <span><strong>Día más bajo:</strong> ${quietSub}</span>
    `;
  }
  grid.innerHTML=`
    <div class='card kpi'><div><small>Ventas totales</small><div class='big'>${fmt.money(k.ventas)}</div></div></div>
    <div class='card kpi'><div><small>Ingreso neto</small><div class='big'>${fmt.money(k.ingresosNetos)}</div><div class='muted'>Ventas menos comisión de plataformas</div></div></div>
    <div class='card kpi'><div><small>Comisión plataformas</small><div class='big'>${fmt.money(k.comisionesPlataformas)}</div></div></div>
    <div class='card kpi'><div><small>Top día</small><div class='big'>${bestDayTotal}</div><div class='muted'>${bestDaySub}</div></div></div>
    <div class='card kpi'><div><small>Días con ventas</small><div class='big'>${k.dias}</div></div></div>
    <div class='card kpi'><div><small>Promedio diario</small><div class='big'>${fmt.money(k.promDiario)}</div></div></div>
    <div class='card kpi'><div><small>Máximo diario</small><div class='big'>${fmt.money(k.maxDiario)}</div></div></div>
    <div class='card kpi'><div><small>Mínimo diario</small><div class='big'>${fmt.money(k.minDiario)}</div></div></div>
    <div class='card kpi'><div><small>Mediana diaria</small><div class='big'>${fmt.money(k.medianaDiaria)}</div></div></div>
    <div class='card kpi'><div><small>Gastos</small><div class='big'>${fmt.money(k.gastos)}</div></div></div>
    <div class='card kpi'><div><small>Utilidad neta</small><div class='big'>${fmt.money(k.utilidad)}</div></div></div>
    <div class='card kpi'><div><small>Propinas totales</small><div class='big'>${fmt.money(k.propinas)}</div></div></div>
    <div class='card kpi'><div><small>Ticket promedio</small><div class='big'>${fmt.money(k.ticketPromedio)}</div></div></div>
    <div class='card kpi'><div><small>Tickets capturados</small><div class='big'>${k.ticketCount}</div></div></div>
    <div class='card kpi'><div><small>Margen sobre ingreso neto</small><div class='big'>${fmt.num(k.margen)}%</div></div></div>
    <div class='card kpi'><div><small>Método estrella</small><div class='big'>${bestMethodName}</div><div class='muted'>${bestMethodSub}</div></div></div>
    <div class='card kpi'><div><small>Periodos con pérdida</small><div class='big'>${perdidas}</div></div></div>
    <div class='card kpi' id='kpi-share-card'><div><small>Ventas comisionadas</small><div class='big'>${window._commissionShare? fmt.num(window._commissionShare.pct||0)+'%' :'--'}</div></div></div>
    <div class='card kpi'><div><small>Saldo caja (efectivo)</small><div class='big'>${fmt.money(k.saldoEfectivo)}</div></div></div>
    <div class='card kpi'><div><small>Saldo banco</small><div class='big'>${fmt.money(k.saldoTarjeta)}</div></div></div>
    <div class='card kpi'><div><small>Ventas Uber (bruto)</small><div class='big'>${fmt.money(k.porMetodo.Uber||0)}</div></div></div>
    <div class='card kpi'><div><small>Ventas Rappi (bruto)</small><div class='big'>${fmt.money(k.porMetodo.Rappi||0)}</div></div></div>
    <div class='card kpi'><div><small>Pendiente Uber</small><div class='big'>${fmt.money(k.pendUber||0)}</div></div></div>
    <div class='card kpi'><div><small>Pendiente Rappi</small><div class='big'>${fmt.money(k.pendRappi||0)}</div></div></div>
    <div class='card kpi'><div><small>Próximo Uber</small><div class='big'>${nextUberCard}</div></div></div>
    <div class='card kpi'><div><small>Próximo Rappi</small><div class='big'>${nextRappiCard}</div></div></div>
    <div class='card kpi'><div><small>% Efectivo</small><div class='big'>${fmt.num(part('Efectivo'))}%</div></div></div>
    <div class='card kpi'><div><small>% Tarjeta</small><div class='big'>${fmt.num(part('Tarjeta'))}%</div></div></div>
    <div class='card kpi'><div><small>% Uber</small><div class='big'>${fmt.num(part('Uber'))}%</div></div></div>
    <div class='card kpi'><div><small>% Rappi</small><div class='big'>${fmt.num(part('Rappi'))}%</div></div></div>`;
  const metBody=document.querySelector('#tbl-ventas-metodo tbody');
  const filas=METHODS.map(m=>{
    const bruto=k.porMetodo[m]||0;
    const ingreso=(k.ingresosPorMetodo?.[m]||0);
    const partPct= k.ingresosNetos? (ingreso/k.ingresosNetos*100):0;
    return `<tr><td>${m}</td><td>${fmt.money(bruto)}</td><td>${fmt.money(ingreso)}</td><td>${fmt.num(partPct)}%</td></tr>`;
  }).join('');
  metBody.innerHTML=filas;
  const kpiBody=document.querySelector('#tbl-kpis-periodo tbody');
  kpiBody.innerHTML=[
    ['Ventas totales', fmt.money(k.ventas)],
    ['Ingreso neto', fmt.money(k.ingresosNetos)],
    ['Comisión plataformas', fmt.money(k.comisionesPlataformas)],
    ['Días con ventas', k.dias],
    ['Promedio diario', fmt.money(k.promDiario)],
    ['Máximo diario', fmt.money(k.maxDiario)],
    ['Mínimo diario', fmt.money(k.minDiario)],
    ['Mediana diaria', fmt.money(k.medianaDiaria)],
    ['Ventas plataformas (bruto)', fmt.money(k.plataformasTotal)],
    ['A recibir plataformas (65%)', fmt.money(k.aRecibirTotal)],
    ['Notas', 'Gastos = módulo Gastos (sin Compras ni Ajustes)'],
  ].map(([kpi,val])=>`<tr><td>${kpi}</td><td>${val}</td></tr>`).join('');
  const resBody=document.querySelector('#tbl-resumen tbody');
  resBody.innerHTML=k.resumenPeriodo.map(r=>`<tr><td>${r.Periodo}</td><td>${fmt.money(r.Ventas||0)}</td><td>${fmt.money(r.Comision||0)}</td><td>${fmt.money(r.Ingresos||0)}</td><td>${fmt.money(r.Costos||0)}</td><td>${fmt.money(r.Gastos||0)}</td><td>${fmt.money(r.Utilidad||0)}</td></tr>`).join('');
  renderChartsDashboard(k);
  renderLedgers();
  marketingCalendar.init();
  renderGrowthInsights(k);
}

function renderGrowthInsights(kpi){
  const card=document.getElementById('growth-insights-card'); if(!card) return;
  const promDiario=kpi.promDiario||0;
  const forecast7=promDiario*7;
  const share=window._commissionShare?.pct||0;
  const ventasCom=window._commissionShare?.ventasCom||0;
  const nextEvt=marketingCalendar.nextEvent?.();
  const lowStock=(Data.get(Data.col.insumos)||[]).filter(i=> Number(i.existencia||0)<=Number(i.min||0)).slice(0,3);
  const lowStockTxt=lowStock.length? lowStock.map(i=>`${i.nombre} (${fmt.num(i.existencia||0)} ${i.unidad||''})`).join(', '):'Inventario en niveles óptimos';
  const topProducto=window._topCommissionProducts?.[0];
  const eventTxt=nextEvt? `${new Intl.DateTimeFormat('es-MX',{day:'2-digit',month:'short'}).format(nextEvt.date)} · ${nextEvt.label}`:'Sin evento próximo';
  card.innerHTML=`
    <h3>Growth Compass</h3>
    <ul class="idea-list">
      <li><strong>Proyección 7 días:</strong> ${fmt.money(forecast7)} estimados (${fmt.money(promDiario)}/día).</li>
      <li><strong>Atracción de comisiones:</strong> ${fmt.num(share)}% de las ventas (${fmt.money(ventasCom)} en el periodo). Impulsa ${topProducto?topProducto[0]:'los productos estrella'}.</li>
      <li><strong>Siguiente activación:</strong> ${eventTxt}. ${lowStockTxt}.</li>
    </ul>
  `;
}

function renderActionCenter(kpi){
  const card=document.getElementById('dashboard-action-card'); if(!card) return;
  const future=FutureOps.simulateCommissionGrowth?.(10)||{};
  const staffing=FutureOps.recommendStaffing?.()||{};
  const nextEvt=marketingCalendar.nextEvent?.();
  const topProducto=window._topCommissionProducts?.[0];
  const tasks=[
    nextEvt? `<strong>Campaña:</strong> prepara contenidos para ${nextEvt.label} (${localDateISO(nextEvt.date)}).`:'Activa una campaña digital para la semana.',
    topProducto? `<strong>Producto estrella:</strong> ${topProducto[0]} · refuerza cross-selling con ${fmt.money(topProducto[1].venta)} en ventas.`:'Destaca tu bebida insignia en mostrador.',
    future.expectedCommission? `<strong>Escenario +10%:</strong> Comisión proyectada ${fmt.money(future.expectedCommission)} · ventas ${fmt.money(future.expectedSales)}.`:'Simula escenarios con FutureOps para anticipar metas.',
    staffing.recommendedTeam? `<strong>Staff sugerido:</strong> ${staffing.recommendedTeam} personas por turno para sostener ${fmt.money(staffing.averageDaily||0)} diarios.`:'Ajusta horarios para cubrir picos de venta.'
  ];
  card.innerHTML=`
    <h3>Action Center</h3>
    <ul class="idea-list">${tasks.map(t=>`<li>${t}</li>`).join('')}</ul>
  `;
}

function renderMarketingAutopilot(){
  const card=document.getElementById('marketing-autopilot-card'); if(!card) return;
  const upcoming=marketingCalendar.nextEvent?.();
  const today=todayISO();
  const agenda=marketingCalendar._agendaCache||[];
  const todays=agenda.filter(a=> a.fecha===today);
  const topProducto=window._topCommissionProducts?.[0];
  card.innerHTML=`
    <h3>Marketing Autopilot</h3>
    <ul class="idea-list">
      <li><strong>Evento próximo:</strong> ${upcoming? `${upcoming.label} (${localDateISO(upcoming.date)})`:'Sin marketing agendado'}</li>
      <li><strong>Notas del día:</strong> ${todays.length? todays.map(a=>a.titulo||a.notas||'Pendiente').join(', '):'Sin notas, agrega recordatorios desde Agenda.'}</li>
      <li><strong>Producto sugerido:</strong> ${topProducto? topProducto[0]:'Define un héroe del mes'} para campañas siempre-on.</li>
    </ul>
  `;
}

// Dashboard charts (diario)
const dailySeriesCache={key:'', data:null};
function dailySeries(){
  const desde=document.getElementById('dash-desde').value, hasta=document.getElementById('dash-hasta').value;
  const canal=getDashboardChannel();
  const storageSize=(localStorage.getItem(LocalDB.key(Data.col.ventas_ticket))||'').length;
  const cacheKey=`${desde}|${hasta}|${canal}|${storageSize}`;
  if(dailySeriesCache.key===cacheKey && dailySeriesCache.data){
    const cached=dailySeriesCache.data;
    return {
      labels:[...cached.labels],
      dataByMethod:Object.fromEntries(Object.entries(cached.dataByMethod).map(([k,v])=>[k,[...v]])),
      tipsByMethod:Object.fromEntries(Object.entries(cached.tipsByMethod).map(([k,v])=>[k,[...v]])),
      total:[...cached.total]
    };
  }
  const tickets=Data.get(Data.col.ventas_ticket).filter(t=> inRange(t.fechaHora,desde,hasta) && matchesDashboardChannel(t, canal));
  const buildRange=(a,b)=>{ if(!a||!b) return null; const start=new Date(a), end=new Date(b); if(start>end) return null; const dd=[]; for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){ dd.push(d.toISOString().slice(0,10)); } return dd; };
  const range=buildRange(desde,hasta);
  const days=range || [...new Set(tickets.map(t=> businessDateISO(t.fechaHora)))].sort();
  const labels = days.length? days : [todayISO()];
  const dataByMethod = Object.fromEntries(METHODS.map(m=>[m, labels.map(()=>0)]));
  const tipsByMethod = Object.fromEntries(METHODS.map(m=>[m, labels.map(()=>0)]));
  labels.forEach((d,idx)=>{
    const ts = tickets.filter(t=> businessDateISO(t.fechaHora)===d);
    METHODS.forEach(m=>{ const arr=ts.filter(t=> String(t.metodoPago||'')===m); const sum=arr.reduce((a,b)=>a+(b.total||0),0); const tip=arr.reduce((a,b)=>a+Number(b.propina||0),0); dataByMethod[m][idx]=sum; tipsByMethod[m][idx]=tip; });
  });
  const total = labels.map((_,i)=> METHODS.reduce((acc,m)=> acc + (dataByMethod[m][i]||0), 0));
  dailySeriesCache.key=cacheKey;
  dailySeriesCache.data={labels, dataByMethod, tipsByMethod, total};
  return {labels, dataByMethod, tipsByMethod, total};
}

function weekStartISO(iso){
  if(!iso) return null;
  const d=new Date(iso+'T00:00:00');
  if(Number.isNaN(d.getTime())) return null;
  const diff=(d.getDay()+6)%7;
  d.setDate(d.getDate()-diff);
  return d.toISOString().slice(0,10);
}

function weekRangeLabel(startIso){
  if(!startIso) return '';
  const end=new Date(startIso+'T00:00:00');
  end.setDate(end.getDate()+6);
  const endIso=localDateISO(end);
  return `${fmt.dateOnly(startIso)} → ${fmt.dateOnly(endIso)}`;
}

function weeklyPlatformSeries(labels, dataByMethod){
  if(!labels || !labels.length || !dataByMethod) return {labels:[], uber:[], rappi:[], combined:[]};
  const buckets=new Map();
  labels.forEach((iso,idx)=>{
    const wk=weekStartISO(iso);
    if(!wk) return;
    const entry=buckets.get(wk)||{uber:0,rappi:0};
    entry.uber+=Number(dataByMethod['Uber']?.[idx]||0);
    entry.rappi+=Number(dataByMethod['Rappi']?.[idx]||0);
    buckets.set(wk, entry);
  });
  const entries=[...buckets.entries()].sort((a,b)=> new Date(a[0])-new Date(b[0]));
  if(!entries.length) return {labels:[], uber:[], rappi:[], combined:[]};
  const weekLabels=entries.map(([start])=> weekRangeLabel(start));
  const uber=entries.map(([,vals])=> vals.uber);
  const rappi=entries.map(([,vals])=> vals.rappi);
  const combined=entries.map(([,vals])=> (vals.uber||0)+(vals.rappi||0));
  return {labels:weekLabels, uber, rappi, combined};
}

function weeklyMethodSeries(labels, dataByMethod){
  const empty=Object.fromEntries(METHODS.map(m=>[m,[]]));
  if(!labels || !labels.length || !dataByMethod) return {labels:[], dataByMethod:empty, combined:[], change:null};
  const buckets=new Map();
  labels.forEach((iso,idx)=>{
    const wk=weekStartISO(iso);
    if(!wk) return;
    if(!buckets.has(wk)){
      const init={};
      METHODS.forEach(m=> init[m]=0);
      buckets.set(wk, init);
    }
    const bucket=buckets.get(wk);
    METHODS.forEach(m=>{
      bucket[m]+=Number(dataByMethod[m]?.[idx]||0);
    });
  });
  const entries=[...buckets.entries()].sort((a,b)=> new Date(a[0])-new Date(b[0]));
  if(!entries.length) return {labels:[], dataByMethod:empty, combined:[], change:null};
  const weekLabels=entries.map(([start])=> weekRangeLabel(start));
  const byMethod={};
  METHODS.forEach(m=>{
    byMethod[m]=entries.map(([,vals])=> Number(vals[m]||0));
  });
  const combined=entries.map(([,vals])=> METHODS.reduce((acc,m)=> acc+Number(vals[m]||0),0));
  const lastIdx=entries.length-1;
  const prevIdx=lastIdx-1;
  const change={
    total:{
      current: combined[lastIdx]||0,
      previous: prevIdx>=0? combined[prevIdx]||0 : 0,
      label: weekLabels[lastIdx]||''
    },
    methods:{}
  };
  METHODS.forEach(m=>{
    const arr=byMethod[m]||[];
    change.methods[m]={
      current: arr[lastIdx]||0,
      previous: prevIdx>=0? arr[prevIdx]||0 : 0
    };
  });
  return {labels:weekLabels, dataByMethod:byMethod, combined, change};
}

function updateWeeklyMethodsInsights(series){
  const meta=document.getElementById('weekly-methods-meta');
  const insights=document.getElementById('weekly-methods-insights');
  if(!meta) return;
  const signedMoney=(val)=> val>0? `+${fmt.money(val)}` : fmt.money(val);
  if(!series.labels.length){
    meta.textContent='Sin datos semanales en el rango seleccionado.';
    if(insights) insights.innerHTML='';
    return;
  }
  const current=series.change?.total?.current||0;
  const previous=series.change?.total?.previous||0;
  const diff=current-previous;
  const pct=previous? diff/previous*100 : (current?100:0);
  const label=series.change?.total?.label || series.labels[series.labels.length-1];
  meta.textContent=`${label} · Total ${fmt.money(current)} (${signedMoney(diff)} · ${fmt.num(pct,1)}%)`;
  if(!insights) return;
  const cards=METHODS.map(method=>{
    const stats=series.change?.methods?.[method]||{current:0, previous:0};
    const methodDiff=stats.current-stats.previous;
    const pctChange=stats.previous? methodDiff/stats.previous*100 : (stats.current?100:0);
    const state=methodDiff>0?'up':methodDiff<0?'down':'flat';
    const pctLabel=stats.previous? `${methodDiff>0?'+':''}${fmt.num(pctChange,1)}%` : (stats.current?'+100%' : '0%');
    return `<span class="insight-chip ${state}">${method}: ${fmt.money(stats.current||0)} (${signedMoney(methodDiff)} · ${pctLabel})</span>`;
  }).join('');
  insights.innerHTML=cards;
}

function renderChartsDashboard(insights){
  const {labels, dataByMethod, tipsByMethod, total}=dailySeries();
  drawBars('chart-total', labels, total, '#FFD74B');
  drawBars('chart-efectivo', labels, dataByMethod['Efectivo'], METHOD_COLORS['Efectivo']);
  drawBars('chart-tarjeta', labels, dataByMethod['Tarjeta'], METHOD_COLORS['Tarjeta']);
  drawBars('chart-uber', labels, dataByMethod['Uber'], METHOD_COLORS['Uber']);
  drawBars('chart-rappi', labels, dataByMethod['Rappi'], METHOD_COLORS['Rappi']);
  const weeklyPlatforms=weeklyPlatformSeries(labels, dataByMethod);
  drawBarsStacked('chart-platform-weekly', weeklyPlatforms.labels, [
    {label:'Rappi', color:METHOD_COLORS['Rappi'], data:weeklyPlatforms.rappi},
    {label:'Uber', color:METHOD_COLORS['Uber'], data:weeklyPlatforms.uber}
  ], {
    showTotals:false,
    labelRotation:weeklyPlatforms.labels.length>8? -Math.PI/3 : -Math.PI/5,
    overlayLine:{
      data:weeklyPlatforms.combined,
      color:'#FFD74B',
      width:2,
      markers:true,
      showLastValue:true,
      valueFont:'600 11px system-ui'
    }
  });
  const platformMeta=document.getElementById('platform-weekly-meta');
  if(platformMeta){
    if(weeklyPlatforms.labels.length){
      const lastIdx=weeklyPlatforms.labels.length-1;
      const totalLast=weeklyPlatforms.combined[lastIdx]||0;
      const uberLast=weeklyPlatforms.uber[lastIdx]||0;
      const rappiLast=weeklyPlatforms.rappi[lastIdx]||0;
      if(lastIdx>0){
        const prev=weeklyPlatforms.combined[lastIdx-1]||0;
        const diff=totalLast-prev;
        const pct=prev? diff/prev*100:0;
        platformMeta.textContent=`Última semana · Uber ${fmt.money(uberLast)}, Rappi ${fmt.money(rappiLast)}, Total ${fmt.money(totalLast)} (${diff>0?'+':''}${fmt.money(diff)} · ${fmt.num(pct||0,1)}%)`;
      } else {
        platformMeta.textContent=`Última semana analizada · Uber ${fmt.money(uberLast)}, Rappi ${fmt.money(rappiLast)}, Total ${fmt.money(totalLast)}`;
      }
    } else {
      platformMeta.textContent='Sin datos de Uber o Rappi en el rango seleccionado.';
    }
  }
  const weeklyMethods=weeklyMethodSeries(labels, dataByMethod);
  const weeklyStack=METHODS.map(m=>({label:m,color:METHOD_COLORS[m],data:weeklyMethods.dataByMethod[m]||[]}));
  drawBarsStacked('chart-weekly-metodos', weeklyMethods.labels, weeklyStack, {
    labelRotation:weeklyMethods.labels.length>8? -Math.PI/3 : -Math.PI/5,
    overlayLine:{
      data:weeklyMethods.combined,
      color:'#FACC15',
      width:2,
      markers:true,
      showLastValue:true,
      valueFont:'600 11px system-ui'
    },
    highlightLatest:true,
    totalFormatter:val=>fmt.money(val)
  });
  updateWeeklyMethodsInsights(weeklyMethods);
  // Propinas solo en tarjeta (diario)
  drawBars('chart-propinas', labels, tipsByMethod['Tarjeta']||[], '#8B5CF6');
  const stackedSeries=METHODS.map(m=>({label:m,color:METHOD_COLORS[m],data:dataByMethod[m]||[]}));
  drawBarsStacked('chart-metodos-stacked', labels, stackedSeries);
  if(insights?.resumenPeriodo?.length){
    const labs=insights.resumenPeriodo.map(r=>r.Periodo);
    const costos=insights.resumenPeriodo.map(r=>Number(r.Costos||0));
    const gastos=insights.resumenPeriodo.map(r=>Number(r.Gastos||0));
    const util=insights.resumenPeriodo.map(r=>Math.max(0, Number(r.Utilidad||0)));
    drawBarsStacked('chart-costos-gastos', labs, [
      {label:'Costos', color:'#F59E0B', data:costos},
      {label:'Gastos', color:'#EF4444', data:gastos}
    ]);
    drawBars('chart-utilidad', labs, util, '#10B981');
  }
}

// Donut chart sencillo (para distribución de categorías)
function drawDonut(canvasId, labels, data, colors, opts={}){
  const c=document.getElementById(canvasId); if(!c) return; const dpr=window.devicePixelRatio||1; const rect=c.getBoundingClientRect();
  const W=Math.max(1, rect.width||c.parentElement?.clientWidth||300), H=Math.max(1, rect.height||220);
  c.width=Math.floor(W*dpr); c.height=Math.floor(H*dpr); const ctx=c.getContext('2d'); ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,W,H);
  const theme=currentChartTheme();
  const colorsSafe=(colors&&colors.length)? colors : labels.map((_,i)=>chartPalette(i));
  const total=data.reduce((a,b)=>a+(b||0),0); if(total<=0){ ctx.fillStyle='#777'; ctx.font='12px system-ui'; ctx.fillText('Sin datos', 10, 20); return; }
  const size=Math.min(W,H); const r=size*0.38; const r2=r*0.58;
  const cx=W/2; const cy=(H/2)+6;
  let start=-Math.PI/2;
  data.forEach((v,i)=>{
    const ang=(v/total)*Math.PI*2; ctx.save(); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,start+ang); ctx.closePath(); ctx.shadowColor='rgba(9,14,25,0.32)'; ctx.shadowBlur=18; ctx.fillStyle=colorsSafe[i%colorsSafe.length]||'#ccc'; ctx.fill(); ctx.restore();
    start+=ang;
  });
  ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(cx,cy,r2,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over';
  ctx.beginPath(); ctx.arc(cx,cy,r2,0,Math.PI*2); ctx.fillStyle=theme.donutCenter; ctx.fill();
  const topIdx=data.reduce((best,val,idx,arr)=> (val>arr[best]?idx:best),0);
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillStyle=theme.axis;
  const centerLabel = (opts.centerLabel || 'Total').toUpperCase();
  const centerValue = opts.centerValue || fmt.money(total);
  ctx.font='700 10px system-ui'; ctx.fillText(centerLabel, cx, cy-18);
  ctx.font='600 16px system-ui'; ctx.fillStyle=theme.label; ctx.fillText(centerValue, cx, cy-2);
  ctx.font='11px system-ui'; ctx.fillStyle=theme.axis;
  const topPct = total? ((data[topIdx]||0)/total*100):0;
  ctx.fillText(`${labels[topIdx]} · ${fmt.num(topPct)}%`, cx, cy+18);
  ctx.textAlign='left'; ctx.textBaseline='top';
  let y=10;
  labels.forEach((lab,i)=>{
    const color=colorsSafe[i%colorsSafe.length]||'#ccc';
    ctx.fillStyle=color; ctx.fillRect(14,y,10,10);
    const isTop=i===topIdx;
    ctx.fillStyle=isTop? theme.label : (theme.axis || '#aaa');
    ctx.font = isTop? '600 11px system-ui' : '11px system-ui';
    const pct=((data[i]||0)/total*100)||0;
    ctx.fillText(`${lab} · ${fmt.money(data[i]||0)} (${fmt.num(pct)}%)`, 30, y);
    y+=16;
  });
  c._snapshot={type:'donut', labels:[...labels], data:[...data], colors:[...colorsSafe], total};
  c.dataset.zoomable='true';
}

function openChartModal(canvas){
  if(!canvas || canvas.dataset.zoomable==='false') return;
  const snap=canvas._snapshot;
  if(!snap) return;
  const modal=document.getElementById('chart-modal');
  const wrap=modal.querySelector('.modal-canvas-wrap');
  wrap.innerHTML='';
  const modalCanvas=document.createElement('canvas');
  modalCanvas.id='chart-modal-canvas';
  modalCanvas.dataset.zoomable='false';
  wrap.appendChild(modalCanvas);
  const titleEl=document.getElementById('chart-modal-title');
  const parentCard=canvas.closest('.card');
  titleEl.textContent= parentCard?.querySelector('h3')?.textContent || 'Detalle de gráfica';
  const metaEl=document.getElementById('chart-modal-meta');
  const fmtVal=(mode,val)=> mode==='percent'? `${fmt.num(val)}%` : fmt.money(val);
  const buildMeta=(label,value,sub='')=>`<div><strong>${label}</strong>${value}${sub?`<small class="muted" style="display:block;margin-top:2px">${sub}</small>`:''}</div>`;
  if(snap.type==='bars'){
    drawBars('chart-modal-canvas', snap.labels, snap.data, snap.color, {axisMode:snap.axisMode,labelRotation:snap.labelRotation,_skipStore:true});
    modalCanvas.dataset.zoomable='false'; modalCanvas._snapshot=null;
    const total=snap.stats.sum||0;
    const avg=snap.stats.avg||0;
    const max=snap.stats.max;
    const min=snap.stats.min;
    metaEl.innerHTML=[
      buildMeta('Total', fmtVal(snap.axisMode,total)),
      buildMeta('Promedio', fmtVal(snap.axisMode,avg)),
      max?buildMeta('Pico', fmtVal(snap.axisMode,max.value), max.label):'',
      min?buildMeta('Mínimo', fmtVal(snap.axisMode,min.value), min.label):'',
      buildMeta('Datos', String(snap.labels.length))
    ].filter(Boolean).join('');
  } else if(snap.type==='stacked'){
    drawBarsStacked('chart-modal-canvas', snap.labels, snap.series.map(s=>({label:s.label,color:s.color,data:[...s.data]})));
    modalCanvas.dataset.zoomable='false'; modalCanvas._snapshot=null;
    metaEl.innerHTML=snap.series.map(s=> buildMeta(s.label, fmt.money(s.data.reduce((a,b)=>a+(b||0),0)))).join('');
  } else if(snap.type==='donut'){
    drawDonut('chart-modal-canvas', snap.labels, snap.data, snap.colors);
    modalCanvas.dataset.zoomable='false'; modalCanvas._snapshot=null;
    metaEl.innerHTML=snap.labels.map((lab,i)=>{
      const val=snap.data[i]||0; const pct=snap.total? (val/snap.total*100):0;
      return buildMeta(lab, fmt.money(val), `${fmt.num(pct)}% del total`);
    }).join('');
  } else if(snap.type==='trend'){
    drawLineTrend('chart-modal-canvas', snap.labels, snap.data, snap.color, {axisMode:snap.axisMode||'money', _skipStore:true});
    modalCanvas.dataset.zoomable='false'; modalCanvas._snapshot=null;
    metaEl.innerHTML=snap.labels.map((lab,i)=> buildMeta(lab, fmtVal(snap.axisMode||'money', snap.data[i]||0))).join('');
  } else {
    metaEl.innerHTML='<div><strong>Sin datos</strong></div>';
  }
  modal.classList.add('active');
}

function closeChartModal(){
  const modal=document.getElementById('chart-modal');
  if(modal){
    modal.classList.remove('active');
    modal.querySelector('#chart-modal-meta').innerHTML='';
    modal.querySelector('.modal-canvas-wrap').innerHTML='';
  }
}

function drawBarsStacked(canvasId, labels, series, opts={}){
  const c=document.getElementById(canvasId); if(!c) return;
  const baseOpts=c._chartOpts || {};
  const mergedOpts={...baseOpts, ...(opts||{})};
  const storeable={...mergedOpts}; delete storeable.highlightIdx; delete storeable._skipStore;
  if(!opts._skipStore) c._chartOpts=storeable;
  const dpr=window.devicePixelRatio||1; const rect=c.getBoundingClientRect();
  const W=Math.max(1, rect.width||c.parentElement?.clientWidth||320), H=Math.max(1, rect.height||240);
  c.width=Math.floor(W*dpr); c.height=Math.floor(H*dpr);
  const ctx=c.getContext('2d'); ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,W,H);
  const theme=currentChartTheme();
  const defaultFormatter=(lab)=>{
    if(typeof lab!=='string') return lab;
    if(/^\d{4}-\d{2}-\d{2}$/.test(lab)){
      try{ return new Intl.DateTimeFormat('es-MX',{day:'2-digit',month:'short'}).format(new Date(lab+'T00:00:00')); }
      catch(e){ return lab; }
    }
    if(/^\d{4}-W\d+/.test(lab)) return lab.replace('-W',' · Sem ');
    return lab;
  };
  const formatter = typeof mergedOpts.labelFormatter==='function'? mergedOpts.labelFormatter : defaultFormatter;
  const labelsFmt=labels.map((lab,i)=> formatter(lab,i));
  const mL=40,mR=12,mB=36,mT=18; const innerW=W-mL-mR, innerH=H-mT-mB;
  const sums=labels.map((_,i)=> series.reduce((a,s)=>a+(Number(s.data[i]||0)),0));
  const overlayData = Array.isArray(mergedOpts.overlayLine?.data)? mergedOpts.overlayLine.data : null;
  const maxY=Math.max(10, ...sums, ...(overlayData||[]));
  const axisSteps=Math.max(1, mergedOpts.axisSteps||4);
  const scale= innerH / maxY;
  const gap=6; const n=labels.length; const bw = n? (innerW - gap*(n-1))/n : 0;
  const latestIdx=Math.max(0,n-1);
  ctx.strokeStyle=mergedOpts.gridColor||theme.grid; ctx.lineWidth=1; ctx.font=mergedOpts.axisFont||'10px system-ui'; ctx.fillStyle=mergedOpts.axisColor||theme.axis;
  for(let g=0; g<=axisSteps; g++){
    const y = mT + innerH - (innerH/axisSteps)*g; ctx.beginPath(); ctx.moveTo(mL,y); ctx.lineTo(W-mR,y); ctx.stroke();
    const val = (maxY/axisSteps*g);
    const valLabel = mergedOpts.axisMode==='percent'? `${fmt.num(val,0)}%` : fmt.money(val);
    ctx.fillText(valLabel, 6, y-4);
  }
  if(!sums.some(v=>v>0)){
    ctx.fillStyle=theme.axis; ctx.font='12px system-ui'; ctx.fillText('Sin datos para este rango', mL, mT+20);
    c._snapshot={type:'stacked', labels:[...labels], series:series.map(s=>({label:s.label,color:s.color,data:[...(s.data||[])]}))};
    c.dataset.zoomable='true';
    return;
  }
  labels.forEach((lab,i)=>{
    let x=mL + i*(bw+gap); let y=mT+innerH;
    series.forEach(s=>{
      const v=Number(s.data[i]||0); const h=v*scale;
      const baseColor=s.color || chartPalette(i);
      const grad=ctx.createLinearGradient(0,y-h,0,y);
      grad.addColorStop(0, adjustColor(baseColor,30));
      grad.addColorStop(1, adjustColor(baseColor,-25));
      ctx.fillStyle=grad;
      ctx.fillRect(x, y-h, bw, h);
      y-=h;
    });
    const totalHeight=(mT+innerH)-y;
    if(totalHeight>0 && mergedOpts.showTotals!==false){
      ctx.save();
      ctx.fillStyle=mergedOpts.totalColor||theme.label;
      ctx.font=mergedOpts.totalFont||'600 11px system-ui';
      ctx.textAlign='center';
      ctx.textBaseline='bottom';
      const formatterValue = typeof mergedOpts.totalFormatter==='function'? mergedOpts.totalFormatter : fmt.money;
      ctx.fillText(formatterValue(sums[i]), x+bw/2, y-6);
      ctx.restore();
      if((mergedOpts.highlightLatest!==false && i===latestIdx) || (typeof mergedOpts.highlightIdx==='number' && mergedOpts.highlightIdx===i)){
        ctx.save();
        ctx.strokeStyle=mergedOpts.highlightColor||theme.highlight;
        ctx.lineWidth=mergedOpts.highlightWidth||1.6;
        ctx.strokeRect(x-1, y, bw+2, totalHeight);
        ctx.restore();
      }
    }
    if(n<=16 || i%Math.ceil(n/16)===0){
      const txt=String(labelsFmt[i]??'');
      ctx.save();
      ctx.translate(x+bw/2, H-14);
      ctx.textAlign='center'; ctx.textBaseline='top';
      const rotation = typeof mergedOpts.labelRotation==='number'? mergedOpts.labelRotation : -Math.PI/4;
      if(rotation) ctx.rotate(rotation);
      ctx.fillStyle=mergedOpts.labelColor||theme.label;
      ctx.fillText(txt, 0,0);
      ctx.restore();
    }
  });
  if(overlayData){
    ctx.save();
    ctx.strokeStyle=mergedOpts.overlayLine.color || theme.trend;
    ctx.lineWidth=mergedOpts.overlayLine.width || 2;
    ctx.beginPath();
    overlayData.forEach((val,i)=>{
      const x=mL + i*(bw+gap) + bw/2;
      const y=mT+innerH - (val||0)*scale;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
    if(mergedOpts.overlayLine.markers){
      overlayData.forEach((val,i)=>{
        const x=mL + i*(bw+gap) + bw/2;
        const y=mT+innerH - (val||0)*scale;
        ctx.beginPath();
        ctx.fillStyle=mergedOpts.overlayLine.markerColor || ctx.strokeStyle;
        ctx.arc(x,y, mergedOpts.overlayLine.markerRadius||3.2, 0, Math.PI*2);
        ctx.fill();
      });
    }
    if(mergedOpts.overlayLine.showLastValue && overlayData.length){
      const lastIndex=overlayData.length-1;
      const val=overlayData[lastIndex]||0;
      const x=mL + lastIndex*(bw+gap) + bw/2;
      const y=mT+innerH - val*scale;
      ctx.font=mergedOpts.overlayLine.valueFont||'600 11px system-ui';
      ctx.fillStyle=mergedOpts.overlayLine.valueColor||ctx.strokeStyle;
      ctx.textAlign='left';
      ctx.textBaseline='middle';
      ctx.fillText((typeof mergedOpts.overlayLine.valueFormatter==='function'? mergedOpts.overlayLine.valueFormatter : fmt.money)(val), x+6, y);
    }
    ctx.restore();
  }
  c._stackState={
    labels:[...labels],
    series:series.map(s=>({label:s.label,color:s.color,data:[...(s.data||[])]})),
    formatter,
    opts:{...mergedOpts},
    overlayData: overlayData?[...overlayData]:null,
    layout:{mL,mR,mT,mB,innerW,innerH,gap,bw,W,H},
    sums:[...sums],
    axisMode:mergedOpts.axisMode||'money'
  };
  if(!c._stackBound){
    c.addEventListener('mousemove', (e)=>{
      const state=c._stackState; const tt=document.getElementById('chart-tooltip');
      if(!state || !state.labels.length){ tt?.classList.add('hidden'); return; }
      const {layout, labels, series, formatter, opts:stOpts, overlayData, sums, axisMode}=state;
      const {mL,innerW,gap,bw,mT,innerH}=layout;
      const r=c.getBoundingClientRect(); const rel=(e.clientX - r.left) - mL;
      if(rel<0 || rel>innerW || !bw){ c._hlStack=-1; drawBarsStacked(canvasId, labels, series, {...stOpts, _skipStore:true}); tt?.classList.add('hidden'); return; }
      const idx=Math.min(labels.length-1, Math.max(0, Math.floor(rel/(bw+gap))));
      c._hlStack=idx;
      drawBarsStacked(canvasId, labels, series, {...(c._chartOpts||{}), highlightIdx:idx, _skipStore:true});
      const formatVal=(val)=> axisMode==='percent'? `${fmt.num(val)}%` : fmt.money(val);
      const labelTxt=formatter(labels[idx], idx);
      const breakdown=series.map(s=>{
        const v=Number(s.data[idx]||0);
        return `<span style="color:${s.color||'#fff'}">●</span> ${s.label}: ${formatVal(v)}`;
      }).join('<br>');
      const overlayVal=overlayData && overlayData[idx]!=null? `<br>Linea: ${formatVal(overlayData[idx])}`:'';
      if(tt){
        tt.innerHTML=`<strong>${labelTxt}</strong><br>Total: ${formatVal(sums[idx]||0)}${overlayVal}<br>${breakdown}`;
        tt.style.left=(e.clientX+12)+'px'; tt.style.top=(e.clientY+12)+'px'; tt.classList.remove('hidden');
      }
    });
    c.addEventListener('mouseleave', ()=>{
      const tt=document.getElementById('chart-tooltip');
      const state=c._stackState;
      if(state){ drawBarsStacked(canvasId, state.labels, state.series, {...state.opts, _skipStore:true}); }
      c._hlStack=-1; tt?.classList.add('hidden');
    });
    c._stackBound=true;
  }
  c._snapshot={type:'stacked', labels:[...labels], series:series.map(s=>({label:s.label,color:s.color,data:[...(s.data||[])]}))};
  c.dataset.zoomable='true';
}

function drawBars(canvasId, labels, data, color, opts={}){
  const c=document.getElementById(canvasId); if(!c) return;
  const dpr=window.devicePixelRatio||1;
  const rect=c.getBoundingClientRect();
  const W=Math.max(1, rect.width||c.parentElement?.clientWidth||300);
  const H=Math.max(1, rect.height||220);
  const baseOpts=c._chartOpts || {};
  const mergedOpts={...baseOpts, ...(opts||{})};
  const storeable={...mergedOpts}; delete storeable.highlightIdx; delete storeable._skipStore;
  if(!opts._skipStore) c._chartOpts=storeable;
  c.width=Math.floor(W*dpr); c.height=Math.floor(H*dpr);
  const ctx=c.getContext('2d'); ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,W,H);
  const theme=currentChartTheme();
  const mL=40,mR=12,mB=34,mT=18; const innerW=W-mL-mR, innerH=H-mT-mB; const maxY=Math.max(10, ...data);
  const defaultFormatter=(lab)=>{
    if(typeof lab!=='string') return lab;
    if(/^\d{4}-\d{2}-\d{2}$/.test(lab)){
      try{ return new Intl.DateTimeFormat('es-MX',{day:'2-digit',month:'short'}).format(new Date(lab+'T00:00:00')); }
      catch(e){ return lab; }
    }
    if(/^\d{4}-W\d+/.test(lab)) return lab.replace('-W',' · Sem ');
    return lab;
  };
  const formatter= typeof mergedOpts.labelFormatter==='function'? mergedOpts.labelFormatter : defaultFormatter;
  const labelColor=mergedOpts.labelColor || theme.label;
  const axisColor=mergedOpts.axisColor || theme.axis;
  const gridColor=mergedOpts.gridColor || theme.grid;
  const axisMode=mergedOpts.axisMode || 'money';
  const formatValue=(val)=> axisMode==='percent'? `${fmt.num(val)}%` : fmt.money(val);
  const labelsFmt=labels.map((lab,i)=> formatter(lab,i));
  const scale= innerH / maxY; const gap=6; const n=labels.length; const bw = n? (innerW - gap*(n-1))/n : 0;
  // grid
  ctx.strokeStyle=gridColor; ctx.lineWidth=1; ctx.font='10px system-ui'; ctx.fillStyle=axisColor;
  for(let g=0; g<=4; g++){
    const y = mT + innerH - (innerH/4)*g;
    ctx.beginPath(); ctx.moveTo(mL,y); ctx.lineTo(W-mR,y); ctx.stroke();
    const val=(maxY/4*g); ctx.fillText(formatValue(val), 4, y-4);
  }
  // promedio
  const sum=data.reduce((a,b)=>a+(b||0),0); const avg = n? sum/n : 0; const yAvg=mT+innerH-(avg*scale);
  ctx.strokeStyle=mergedOpts.avgColor||theme.avg; ctx.setLineDash([4,6]); ctx.beginPath(); ctx.moveTo(mL,yAvg); ctx.lineTo(W-mR,yAvg); ctx.stroke(); ctx.setLineDash([]);
  // barras + marcadores arriba/abajo promedio
  const rotationDefault = typeof mergedOpts.labelRotation==='number'? mergedOpts.labelRotation : ((labelsFmt.some(txt=> (txt||'').length>6))? -Math.PI/4 : 0);
  const resolveColor=(idx)=> Array.isArray(color)? color[idx%color.length] : (color || chartPalette(idx));
  const canShowValue = n<=14;
  labels.forEach((lab,i)=>{
    const v=data[i]||0; const h=v*scale; const x=mL + i*(bw+gap); const y=mT+innerH-h;
    const baseColor=resolveColor(i);
    const grad=ctx.createLinearGradient(0,y,0,y+h);
    grad.addColorStop(0, adjustColor(baseColor,35));
    grad.addColorStop(1, adjustColor(baseColor,-30));
    ctx.fillStyle=grad;
    ctx.fillRect(x,y,bw,h);
    // marcador
    const above=v>=avg; ctx.beginPath(); ctx.fillStyle= above? theme.markerUp : theme.markerDown; ctx.arc(x+bw/2, y-4, 2.5, 0, Math.PI*2); ctx.fill();
    // valor destacado
    if(canShowValue || mergedOpts.highlightIdx===i){
      ctx.save();
      ctx.fillStyle=theme.label;
      ctx.font='600 11px system-ui';
      ctx.textAlign='center';
      ctx.textBaseline='bottom';
      ctx.fillText(formatValue(v), x+bw/2, y-6);
      ctx.restore();
    }
    if(mergedOpts.highlightIdx===i){
      ctx.save();
      ctx.strokeStyle=theme.highlight;
      ctx.lineWidth=1.4;
      ctx.strokeRect(x-1, y-1, bw+2, h+2);
      ctx.restore();
    }
    // labels de eje X espaciados
    if(n<=16 || i%Math.ceil(n/16)===0){
      const txt=String(labelsFmt[i]??'');
      ctx.save();
      ctx.translate(x+bw/2, H-12);
      ctx.textAlign='center';
      ctx.textBaseline='top';
      if(rotationDefault){
        ctx.rotate(rotationDefault);
        ctx.fillStyle=labelColor;
        ctx.fillText(txt, 0,0);
      } else {
        ctx.fillStyle=labelColor;
        ctx.fillText(txt, 0,0);
      }
      ctx.restore();
    }
  });
  // línea de tendencia (promedio móvil 5)
  const win=5; const sma=data.map((_,i)=>{ const a=Math.max(0,i-win+1), b=i; const slice=data.slice(a,b+1); const s=slice.reduce((p,v)=>p+(v||0),0); return slice.length? s/slice.length:0; });
  ctx.strokeStyle=mergedOpts.trendColor||theme.trend; ctx.lineWidth=2; ctx.beginPath();
  sma.forEach((v,i)=>{ const x=mL + i*(bw+gap) + bw/2; const y=mT+innerH-(v*scale); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke();
  // guardar estado para hover/zoom
  c._chartState={
    labels:[...labels],
    data:[...data],
    color,
    opts:storeable,
    axisMode,
    avg,
    sma:[...sma],
    layout:{mL,mR,mT,mB,innerW,innerH,gap,bw,W,H},
    labelFormatter:formatter
  };
  // hover interacciones (tooltip + highlight)
  if(!c._chartBound){
    c.addEventListener('mousemove', (e)=>{
      const state=c._chartState; const tt=document.getElementById('chart-tooltip');
      if(!state || !state.labels.length){ tt?.classList.add('hidden'); return; }
      const {layout, labels, data, axisMode, avg, sma, labelFormatter, color:stateColor}=state;
      const {mL,innerW,gap,bw}=layout;
      const r=c.getBoundingClientRect(); const rel=(e.clientX - r.left) - mL;
      if(rel<0 || rel>innerW || !bw){ c._hl=-1; drawBars(canvasId, labels, data, stateColor, {...state.opts, _skipStore:true}); tt?.classList.add('hidden'); return; }
      const idx=Math.min(labels.length-1, Math.max(0, Math.floor(rel/(bw+gap))));
      const formatVal=(val)=> axisMode==='percent'? `${fmt.num(val)}%` : fmt.money(val);
      const prettyLabel= typeof labelFormatter==='function'? labelFormatter(labels[idx], idx) : labels[idx];
      c._hl=idx;
      drawBars(canvasId, labels, data, stateColor, {...(c._chartOpts||{}), highlightIdx:idx, _skipStore:true});
      if(tt){
        const v=data[idx]||0; const vTrend=sma[idx]||0;
        tt.innerHTML = `<strong>${prettyLabel}</strong><br>${formatVal(v)}<br>Prom: ${formatVal(avg)} · Tend: ${formatVal(vTrend)}`;
        tt.style.left = (e.clientX+12)+'px'; tt.style.top=(e.clientY+12)+'px'; tt.classList.remove('hidden');
      }
    });
    c.addEventListener('mouseleave', ()=>{
      const tt=document.getElementById('chart-tooltip');
      const state=c._chartState;
      if(state){ drawBars(canvasId, state.labels, state.data, state.color, {...(c._chartOpts||{}), _skipStore:true}); }
      c._hl=-1; tt?.classList.add('hidden');
    });
    c._chartBound=true;
  }
  // highlight vertical en hover
  if(typeof mergedOpts.highlightIdx==='number' && mergedOpts.highlightIdx>=0){
    const i=mergedOpts.highlightIdx; const x=mL + i*(bw+gap) + bw/2; ctx.strokeStyle=theme.highlight; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(x, mT); ctx.lineTo(x, mT+innerH); ctx.stroke();
  }
  // guardar referencia
  c._labels=labels; c._data=data; c._color=color;
  const hasData=data.length>0;
  const maxIdx=hasData? data.reduce((best,v,i,arr)=> v>arr[best]?i:best,0) : -1;
  const minIdx=hasData? data.reduce((best,v,i,arr)=> v<arr[best]?i:best,0) : -1;
  c._snapshot={type:'bars', labels:[...labels], data:[...data], color, axisMode, labelRotation:rotationDefault, stats:{sum,avg,max:maxIdx>=0?{label:labels[maxIdx],value:data[maxIdx]}:null,min:minIdx>=0?{label:labels[minIdx],value:data[minIdx]}:null} };
  c.dataset.zoomable='true';
}

// Línea/área suave para tendencias
function drawLineTrend(canvasId, labels, data, color, opts={}){
  const c=document.getElementById(canvasId); if(!c) return;
  const dpr=window.devicePixelRatio||1;
  const rect=c.getBoundingClientRect();
  const W=Math.max(260, rect.width||c.parentElement?.clientWidth||320);
  const H=Math.max(220, rect.height||260);
  const baseOpts=c._chartOpts||{};
  const mergedOpts={...baseOpts, ...(opts||{})};
  const storeable={...mergedOpts}; delete storeable.highlightIdx; delete storeable._skipStore;
  if(!opts._skipStore) c._chartOpts=storeable;
  c.width=Math.floor(W*dpr); c.height=Math.floor(H*dpr);
  const ctx=c.getContext('2d'); ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,W,H);
  const theme=currentChartTheme();
  const mL=46,mR=18,mT=20,mB=40;
  const innerW=W-mL-mR, innerH=H-mT-mB;
  const safeData=data.map(v=>Number(v)||0);
  const axisSteps=mergedOpts.axisSteps||4;
  const axisMode=mergedOpts.axisMode||'money';
  const maxY=Math.max(Math.max(...safeData), mergedOpts.minY||0, 10);
  const minY=Math.min(Math.min(...safeData), mergedOpts.minY||0, 0);
  const range=Math.max(1, maxY-minY);
  const formatVal=(val)=> axisMode==='percent'? `${fmt.num(val)}%` : fmt.money(val);
  const defaultFormatter=(lab)=>{
    if(typeof lab!=='string') return lab;
    if(/^\d{4}-\d{2}-\d{2}$/.test(lab)){
      try{ return new Intl.DateTimeFormat('es-MX',{day:'2-digit',month:'short'}).format(new Date(lab+'T00:00:00')); }
      catch(e){ return lab; }
    }
    if(/^\d{4}-W\d+/.test(lab)) return lab.replace('-W',' · Sem ');
    return lab;
  };
  const formatter= typeof mergedOpts.labelFormatter==='function'? mergedOpts.labelFormatter : defaultFormatter;
  ctx.strokeStyle=mergedOpts.gridColor||theme.grid; ctx.lineWidth=1; ctx.font='10px system-ui'; ctx.fillStyle=mergedOpts.axisColor||theme.axis;
  for(let g=0; g<=axisSteps; g++){
    const y = mT + innerH - (innerH/axisSteps)*g;
    ctx.beginPath(); ctx.moveTo(mL,y); ctx.lineTo(W-mR,y); ctx.stroke();
    const val=minY + (range/axisSteps)*g;
    ctx.fillText(formatVal(val), 6, y-4);
  }
  const stepX = safeData.length>1? innerW/(safeData.length-1):0;
  const points = safeData.map((v,i)=>({
    x:mL + stepX*i,
    y:mT + innerH - ((v-minY)/range)*innerH,
    v,
    label:labels[i]||''
  }));
  if(points.length){
    const grad=ctx.createLinearGradient(0,mT,0,H-mB);
    const baseColor=color||chartPalette(0);
    grad.addColorStop(0, adjustColor(baseColor,40));
    grad.addColorStop(1, 'rgba(255,255,255,0.02)');
    ctx.beginPath();
    points.forEach((p,i)=>{ if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
    ctx.lineTo(points[points.length-1].x, H-mB);
    ctx.lineTo(points[0].x, H-mB);
    ctx.closePath();
    ctx.fillStyle=grad;
    ctx.fill();
    ctx.strokeStyle=baseColor;
    ctx.lineWidth=2.8;
    ctx.beginPath();
    points.forEach((p,i)=>{ if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
    ctx.stroke();
    points.forEach((p,i)=>{ ctx.beginPath(); ctx.fillStyle=i===points.length-1? theme.highlight : baseColor; ctx.arc(p.x,p.y,3.2,0,Math.PI*2); ctx.fill(); });
  }
  const n=points.length;
  points.forEach((p,i)=>{
    if(n<=12 || i%Math.ceil(n/12)===0 || i===n-1){
      const txt=formatter(points[i].label, i);
      ctx.save(); ctx.translate(p.x, H-16); ctx.textAlign='center'; ctx.textBaseline='top'; ctx.fillStyle=mergedOpts.labelColor||theme.label; ctx.fillText(txt,0,0); ctx.restore();
    }
  });
  if(typeof mergedOpts.highlightIdx==='number' && mergedOpts.highlightIdx>=0 && points[mergedOpts.highlightIdx]){
    const p=points[mergedOpts.highlightIdx];
    ctx.strokeStyle=theme.highlight; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(p.x, mT); ctx.lineTo(p.x, H-mB+6); ctx.stroke(); ctx.setLineDash([]);
    ctx.beginPath(); ctx.fillStyle=theme.highlight; ctx.arc(p.x,p.y,4,0,Math.PI*2); ctx.fill();
  }
  c._lineState={
    labels:[...labels],
    data:[...safeData],
    color:color||chartPalette(0),
    formatter,
    axisMode,
    layout:{mL,mR,mT,mB,innerW,innerH,stepX,W,H,minY,range},
    opts:storeable
  };
  if(!c._lineBound){
    c.addEventListener('mousemove', (e)=>{
      const state=c._lineState; const tt=document.getElementById('chart-tooltip');
      if(!state || !state.labels.length){ tt?.classList.add('hidden'); return; }
      const {layout, labels, data, formatter, axisMode, color:clr}=state;
      const {mL,stepX,innerW}=layout;
      const r=c.getBoundingClientRect(); const rel=(e.clientX - r.left) - mL;
      if(rel<0 || rel>innerW || !stepX){ c._hlLine=-1; drawLineTrend(canvasId, labels, data, clr, {...state.opts, _skipStore:true}); tt?.classList.add('hidden'); return; }
      const idx=Math.min(labels.length-1, Math.max(0, Math.round(rel/stepX)));
      c._hlLine=idx;
      drawLineTrend(canvasId, labels, data, clr, {...state.opts, highlightIdx:idx, _skipStore:true});
      if(tt){
        const label=formatter? formatter(labels[idx], idx):labels[idx];
        const val=data[idx]||0;
        tt.innerHTML=`<strong>${label}</strong><br>${formatVal(val)}`;
        tt.style.left=(e.clientX+12)+'px'; tt.style.top=(e.clientY+12)+'px'; tt.classList.remove('hidden');
      }
    });
    c.addEventListener('mouseleave', ()=>{
      const tt=document.getElementById('chart-tooltip');
      const state=c._lineState;
      if(state){ drawLineTrend(canvasId, state.labels, state.data, state.color, {...state.opts, _skipStore:true}); }
      c._hlLine=-1; tt?.classList.add('hidden');
    });
    c._lineBound=true;
  }
  c._snapshot={type:'trend', labels:[...labels], data:[...safeData], color:color||chartPalette(0), axisMode};
  c.dataset.zoomable='true';
}

// Ledgers (estado de cuenta)
function buildLedgers(){
  const ldesde=document.getElementById('ld-desde')?.value || document.getElementById('dash-desde').value;
  const lhasta=document.getElementById('ld-hasta')?.value || document.getElementById('dash-hasta').value;
  const {labels, dataByMethod, tipsByMethod}=dailySeries();
  // Subrange labels according to ledger filters if set
  const idxRange=(d)=> labels.indexOf(d);
  const fromIdx = ldesde? Math.max(0, idxRange(ldesde)) : 0;
  const toIdx = lhasta? Math.min(labels.length-1, idxRange(lhasta)) : labels.length-1;
  const useLabs = labels.slice(fromIdx, toIdx+1);
  const ledgerEf=[]; const ledgerBk=[];
  // efectivo: solo ventas (no sumar propinas efectivo)
  useLabs.forEach((d,iOff)=>{
    const i=fromIdx + iOff;
    const ef=dataByMethod['Efectivo'][i]||0; if(ef>0) ledgerEf.push({fecha:d, concepto:'Ventas efectivo', entrada:ef, salida:0});
    // tarjeta: entrada bruta y comisión como salida
    const tj=dataByMethod['Tarjeta'][i]||0; if(tj>0) ledgerBk.push({fecha:d, concepto:'Ventas tarjeta (bruto)', entrada:tj, salida:0}); if(tj>0) ledgerBk.push({fecha:d, concepto:'Comisión tarjeta 4.06%', entrada:0, salida: Number((tj*0.0406).toFixed(2))});
  });
  // Depósitos de plataformas
  // Uber: lunes siguiente por semana (Lun-Dom)
  const weekKey=(iso)=>{ const d=new Date(iso+'T00:00:00'); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); return d.toISOString().slice(0,10); } // Monday start
  const mondayNext=(iso)=>{ const d=new Date(iso+'T00:00:00'); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day+7); return d.toISOString().slice(0,10); }
  // Rappi: paga viernes siguiente por periodo Sábado-Viernes
  const fridayOfWeek=(iso)=>{ const d=new Date(iso+'T00:00:00'); const dow=d.getDay(); const diff=(5 - dow + 7)%7; d.setDate(d.getDate()+diff); return d.toISOString().slice(0,10); } // Friday of the same week
  const nextFriday=(iso)=>{ const d=new Date(iso+'T00:00:00'); d.setDate(d.getDate()+7); return d.toISOString().slice(0,10); }
  const acc={Uber:{}, Rappi:{}};
  useLabs.forEach((d,iOff)=>{
    const i=fromIdx + iOff; const wk=weekKey(d); const valU=(dataByMethod['Uber'][i]||0); const valR=(dataByMethod['Rappi'][i]||0);
    acc.Uber[wk]=(acc.Uber[wk]||0)+valU; const fri=fridayOfWeek(d); acc.Rappi[fri]=(acc.Rappi[fri]||0)+valR;
  });
  Object.entries(acc.Uber).forEach(([wk,sum])=>{ const depDate=mondayNext(wk); const amt=Number((sum*0.65).toFixed(2)); if(amt>0 && (!ldesde || depDate>=ldesde) && (!lhasta || depDate<=lhasta)) ledgerBk.push({fecha:depDate, concepto:'Depósito Uber (65%)', entrada:amt, salida:0}); });
  Object.entries(acc.Rappi).forEach(([fri,sum])=>{ const depDate=nextFriday(fri); const amt=Number((sum*0.65).toFixed(2)); if(amt>0 && (!ldesde || depDate>=ldesde) && (!lhasta || depDate<=lhasta)) ledgerBk.push({fecha:depDate, concepto:'Depósito Rappi (65%)', entrada:amt, salida:0}); });
  // gastos
  const gastos=Data.get(Data.col.gastos).filter(g=> inRange(g.fecha,ldesde||document.getElementById('dash-desde').value,lhasta||document.getElementById('dash-hasta').value));
  gastos.forEach(g=>{
    const empName = g.empleadoId? (LocalDB.byId(Data.col.empleados,g.empleadoId)?.nombre || '') : '';
    const provName = g.proveedorId? (LocalDB.byId(Data.col.proveedores,g.proveedorId)?.nombre||'') : '';
    let concepto='';
    if(String(g.tipo||'')==='Nómina'){
      const isAnt = String(g.folio||'').startsWith('ANT-') || String(g.descripcion||'').toLowerCase().startsWith('anticipo');
      if(isAnt){ concepto = `Anticipo nómina · ${empName||g.descripcion||''}${g.folio? ' · '+g.folio:''}`; }
      else { concepto = `Nómina neta · ${empName||g.descripcion||''}${g.folio? ' · '+g.folio:''}`; }
    } else {
      const extra = [provName, g.descripcion].filter(Boolean).join(' · ');
      concepto = `Gasto: ${g.tipo}${extra? ' · '+extra:''}`;
    }
    const row={fecha:g.fecha, concepto, entrada:0, salida:Number(g.importe||0)};
    if(g.metodoPago==='Efectivo') ledgerEf.push(row);
    else if(g.metodoPago==='Tarjeta' || g.metodoPago==='Transferencia') ledgerBk.push(row);
  });
  // compras (afectan caja/banco según método)
  const comprasList=Data.get(Data.col.compras).filter(c=> inRange(c.fechaHora,ldesde||document.getElementById('dash-desde').value,lhasta||document.getElementById('dash-hasta').value));
  comprasList.forEach(c=>{
    const fecha=(c.fechaHora||'').slice(0,10); const prov=LocalDB.byId(Data.col.proveedores,c.proveedorId)?.nombre||'';
    const concepto=`Compra insumos${prov?' · '+prov:''}`; const amt=Number(c.total||0);
    if(c.metodoPago==='Efectivo') ledgerEf.push({fecha, concepto, entrada:0, salida:amt});
    else if(c.metodoPago==='Tarjeta' || c.metodoPago==='Transferencia') ledgerBk.push({fecha, concepto, entrada:0, salida:amt});
  });
  // ajustes (p.ej. pago de propinas de tarjeta desde caja)
  const aj=Data.get(Data.col.ajustes).filter(a=> inRange(a.fecha,ldesde||document.getElementById('dash-desde').value,lhasta||document.getElementById('dash-hasta').value));
  aj.forEach(a=>{
    if(a.cuenta==='Efectivo') ledgerEf.push({fecha:a.fecha, concepto:a.concepto||'Ajuste', entrada:Number(a.entrada||0), salida:Number(a.salida||0)});
    else if(a.cuenta==='Banco' || a.cuenta==='Tarjeta') ledgerBk.push({fecha:a.fecha, concepto:a.concepto||'Ajuste', entrada:Number(a.entrada||0), salida:Number(a.salida||0)});
  });
  const sortByFecha=(a,b)=> new Date(a.fecha)-new Date(b.fecha);
  ledgerEf.sort(sortByFecha); ledgerBk.sort(sortByFecha);
  return {efectivo:ledgerEf, banco:ledgerBk};
}

function renderLedger(tableId, rows, saldoInicial){
  const tb=document.querySelector(`#${tableId} tbody`); if(!tb) return; let saldo=Number(saldoInicial||0);
  const html=[]; html.push(`<tr class='muted'><td></td><td><strong>Saldo inicial</strong></td><td></td><td></td><td>${fmt.money(saldo)}</td></tr>`);
  rows.forEach(r=>{
    saldo += Number(r.entrada||0) - Number(r.salida||0);
    const concept=String(r.concepto||'');
    const cls = concept.startsWith('Anticipo nómina')? 'led-anticipo' : (concept.startsWith('Nómina neta')? 'led-nomina' : (concept.startsWith('Depósito')? 'led-deposito' : (concept.startsWith('Compra insumos')? 'led-compra' : '')));
  html.push(`<tr class='${cls}'><td>${fmt.dateOnly(r.fecha)}</td><td>${concept}</td><td>${r.entrada?fmt.money(r.entrada):''}</td><td>${r.salida?fmt.money(r.salida):''}</td><td>${fmt.money(saldo)}</td></tr>`);
  });
  tb.innerHTML=html.join('');
  // actualizar badge de saldo actual
  const badgeId = (tableId==='tbl-ledger-efec')? 'ld-efec-badge' : (tableId==='tbl-ledger-banco'? 'ld-banco-badge' : null);
  if(badgeId){ const b=document.getElementById(badgeId); if(b) b.textContent = 'Saldo: '+fmt.money(saldo); }
  return saldo;
}

function renderLedgerSummary({saldoEf=0, saldoBk=0}={}){
  const card=document.getElementById('ledger-summary-card');
  if(!card) return;
  const body=card.querySelector('.ledger-summary-body');
  if(!body) return;
  const insights=window._dashboardInsights;
  if(!insights){
    body.innerHTML='<span class="muted">Selecciona un rango para ver el resumen.</span>';
    return;
  }
  const rows=[
    ['Ventas totales', fmt.money(insights.ventas||0)],
    ['Comisión plataformas', fmt.money(insights.comisionesPlataformas||0)],
    ['Ingreso neto', fmt.money(insights.ingresosNetos||0)],
    ['Costos', fmt.money(insights.costos||0)],
    ['Gastos', fmt.money(insights.gastos||0)],
    ['Utilidad neta', fmt.money(insights.utilidad||0)],
    ['Saldo final caja', fmt.money(saldoEf)],
    ['Saldo final banco', fmt.money(saldoBk)]
  ];
  body.innerHTML=`<table class="table"><tbody>${rows.map(([label,val])=>`<tr><td>${label}</td><td>${val}</td></tr>`).join('')}</tbody></table><small class="muted">Basado en el rango del dashboard.</small>`;
}

const LedgerModal={
  current:null,
  open(type){
    const modal=document.getElementById('ledger-modal'); if(!modal) return;
    const card=document.querySelector(`.ledger-card[data-ledger='${type}']`); if(!card) return;
    const title=card.querySelector('h3')?.textContent || 'Estado de cuenta';
    const range=card.querySelector('.ledger-range')?.textContent || '';
    const table=card.querySelector('table'); if(!table) return;
    const clone=table.cloneNode(true);
    clone.id='';
    const container=document.getElementById('ledger-modal-table');
    if(container){
      container.innerHTML='';
      container.appendChild(clone);
    }
    const titleEl=document.getElementById('ledger-modal-title'); if(titleEl) titleEl.textContent=title;
    const metaEl=document.getElementById('ledger-modal-meta'); if(metaEl) metaEl.textContent=range? `Periodo: ${range}`:'Detalle completo';
    modal.classList.add('open');
    modal.setAttribute('aria-hidden','false');
    this.current=type;
  },
  close(){
    const modal=document.getElementById('ledger-modal'); if(!modal) return;
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden','true');
    this.current=null;
  }
};

function bindLedgerCards(){
  document.querySelectorAll('.ledger-card').forEach(card=>{
    if(card.dataset.bound==='1') return;
    card.dataset.bound='1';
    const type=card.dataset.ledger;
    const expandBtn=card.querySelector('.ledger-expand');
    expandBtn?.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); LedgerModal.open(type); });
    card.addEventListener('click', (e)=>{
      if(e.target.closest('.ledger-expand') || e.target.closest('.ledger-scroll') || e.target.closest('table') || e.target.closest('button')) return;
      LedgerModal.open(type);
    });
  });
}

function renderLedgers(){
  const {efectivo, banco}=buildLedgers();
  // UI balances defaults for quick edit
  const se=document.getElementById('ld-saldo-efec'); const sb=document.getElementById('ld-saldo-banco'); if(se && se.value==='') se.value=cfg.saldoIniEfectivo||0; if(sb && sb.value==='') sb.value=cfg.saldoIniBanco||0;
  // UI date defaults if empty
  const ldesde=document.getElementById('ld-desde'); const lhasta=document.getElementById('ld-hasta'); if(ldesde && !ldesde.value) ldesde.value=document.getElementById('dash-desde').value; if(lhasta && !lhasta.value) lhasta.value=document.getElementById('dash-hasta').value;
  const desdeVal=ldesde?.value||document.getElementById('dash-desde')?.value||'';
  const hastaVal=lhasta?.value||document.getElementById('dash-hasta')?.value||'';
  const fmtRange=(from,to)=>{
    if(from && to) return `${fmt.dateOnly(from)} → ${fmt.dateOnly(to)}`;
    if(from) return `Desde ${fmt.dateOnly(from)}`;
    if(to) return `Hasta ${fmt.dateOnly(to)}`;
    return 'Sin rango específico';
  };
  const saldoEf=renderLedger('tbl-ledger-efec', efectivo, Number(se?.value||cfg.saldoIniEfectivo||0));
  const saldoBk=renderLedger('tbl-ledger-banco', banco, Number(sb?.value||cfg.saldoIniBanco||0));
  const rangeTxt=fmtRange(desdeVal,hastaVal);
  const rangeEf=document.getElementById('ld-efec-range'); if(rangeEf) rangeEf.textContent=rangeTxt;
  const rangeBk=document.getElementById('ld-banco-range'); if(rangeBk) rangeBk.textContent=rangeTxt;
  renderLedgerSummary({saldoEf, saldoBk});
  bindLedgerCards();
  renderDeposCalendar();
}

/*******************
 * BMC: Nómina     *
 *******************/
const nominaGen={
  init(){
    const sel=document.getElementById('nom-emp'); if(!sel) return;
    const emps=Data.get(Data.col.empleados);
    sel.innerHTML='<option value="">(Selecciona)</option>'+emps.map(e=>`<option value='${e.id}'>${e.nombre}${e.sueldoHora?` · $${e.sueldoHora}/h`:''}</option>`).join('');
    const wk=document.getElementById('nom-week'); if(wk && !wk.value) wk.value=this.mondayOf(todayISO());
    // También poblar filtros de la sección de gráficas
    const selV=document.getElementById('nom-v-emp'); if(selV){ selV.innerHTML='<option value="">(Todos)</option>'+emps.map(e=>`<option value='${e.id}'>${e.nombre}</option>`).join(''); }
    // Prefijar periodo (semana actual) si vacío
    const {mon,sun}=this.weekRange(); const dv=document.getElementById('nom-v-desde'); const hv=document.getElementById('nom-v-hasta'); if(dv && !dv.value) dv.value=mon; if(hv && !hv.value) hv.value=sun;
    this.syncWeekDates();
    const ids=['lun','mar','mie','jue','vie','sab','dom'];
    ids.forEach(k=>{
      ['-ini','-fin','-com','-bono','-ded','-adv','-advm'].forEach(suf=>{ const el=document.getElementById('nom-'+k+suf); el?.addEventListener('input', ()=> this.recalc()); });
      // change to recalc too
      ['-ini','-fin','-com','-bono','-ded','-adv','-advm'].forEach(suf=>{ const el=document.getElementById('nom-'+k+suf); el?.addEventListener('change', ()=> this.recalc()); });
    });
    ['nom-emp','nom-week','nom-pago'].forEach(id=>{ const el=document.getElementById(id); el?.addEventListener('change', ()=>{ if(id==='nom-week') this.syncWeekDates(); if(id==='nom-emp') this.preloadHorario(); this.recalc(); }); });
    this.updateFolioBadge();
    this.recalc();
  },
  _editId:null,
  setEditing(id, folio){ this._editId=id; const b=document.getElementById('nom-guardar'); if(b) b.textContent = id? `Actualizar nómina #${folio}`:'Registrar gasto de nómina'; if(!id) this.updateFolioBadge(); },
  mondayOf(iso){ const d=new Date(iso+'T00:00:00'); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); return d.toISOString().slice(0,10); },
  addDays(iso,n){ const d=new Date(iso+'T00:00:00'); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); },
  syncWeekDates(){
    const wk=document.getElementById('nom-week')?.value || todayISO(); const mon=this.mondayOf(wk);
    const ids=['lun','mar','mie','jue','vie','sab','dom'];
    ids.forEach((k,idx)=>{ const fe=this.addDays(mon, idx); const td=document.getElementById('nom-fecha-'+k); if(td) td.textContent=fe; });
    // actualizar fecha de pago si está en modo autofill
    const pay=document.getElementById('nom-pago'); if(pay){
      if(pay.dataset.autofill==='1' || !pay.value){ pay.value=this.addDays(mon,7); pay.dataset.autofill='1'; }
      pay.addEventListener('change', ()=> pay.dataset.autofill='0', {once:true});
    }
  },
  recalc(){
    const empId=document.getElementById('nom-emp')?.value; const emp= empId? LocalDB.byId(Data.col.empleados, empId):null; const sueldo=Number(emp?.sueldoHora||0);
    const dks=['lun','mar','mie','jue','vie','sab','dom'];
    const parseH=(v)=>{ if(!v) return null; const m=/^([0-2]\d):([0-5]\d)$/.exec(v); if(!m) return null; return {h:Number(m[1]), m:Number(m[2])}; };
    const hdiff=(a,b)=>{ if(!a||!b) return 0; const t1=a.h*60+a.m, t2=b.h*60+b.m; const diff=(t2-t1); return diff>0? diff/60:0; };
    let horas=0; let comisiones=0; let bonos=0; let deds=0; let anticipos=0; const days=[];
    dks.forEach(k=>{
      const ini=parseH(document.getElementById('nom-'+k+'-ini')?.value||'');
      const fin=parseH(document.getElementById('nom-'+k+'-fin')?.value||'');
      const h=hdiff(ini,fin); horas+=h; const comVal=Number(document.getElementById('nom-'+k+'-com')?.value||0); comisiones+= comVal; const bonoVal=Number(document.getElementById('nom-'+k+'-bono')?.value||0); bonos+= bonoVal; const dedVal=Number(document.getElementById('nom-'+k+'-ded')?.value||0); deds+= dedVal; const advVal=Number(document.getElementById('nom-'+k+'-adv')?.value||0); anticipos+= advVal; const advm=document.getElementById('nom-'+k+'-advm')?.value||'Efectivo';
      const cell=document.getElementById('nom-'+k+'-hrs'); if(cell) cell.textContent=h.toFixed(2);
      days.push({k, ini:ini?`${String(ini.h).padStart(2,'0')}:${String(ini.m).padStart(2,'0')}`:'', fin:fin?`${String(fin.h).padStart(2,'0')}:${String(fin.m).padStart(2,'0')}`:'', horas:h, fecha: document.getElementById('nom-fecha-'+k)?.textContent||'' , comision: comVal, bono: bonoVal, deduccion: dedVal, anticipo: advVal, anticipoMet: advm});
    });
    const bruto= sueldo * horas + comisiones + bonos; const neto = (bruto - deds - anticipos);
    document.getElementById('nom-sueldo').textContent=fmt.money(sueldo);
    document.getElementById('nom-horas').textContent=(horas).toFixed(2);
    document.getElementById('nom-coms').textContent=fmt.money(comisiones);
    document.getElementById('nom-bonos').textContent=fmt.money(bonos);
    const dEl=document.getElementById('nom-deds'); if(dEl) dEl.textContent=fmt.money(deds);
    document.getElementById('nom-anticipos').textContent=fmt.money(anticipos);
    const totEl=document.getElementById('nom-total'); if(totEl){ totEl.textContent=fmt.money(neto); totEl.style.color = (neto<0? 'var(--danger)':''); }
    // KPIs de comisión sugerida por ventas (4%)
    const wk=this.weekRange(); const ventasEmp= sumVentasEmpleadoSemana(empId, wk.mon, wk.sun); const comSug= ventasEmp*COMM_RATE;
    const vEl=document.getElementById('nom-kpi-ventas'); if(vEl) vEl.textContent=fmt.money(ventasEmp);
    const cEl=document.getElementById('nom-kpi-com-sug'); if(cEl) cEl.textContent=fmt.money(comSug);
    return {emp, sueldo, horas, total: neto, bruto, anticipos, deducciones:deds, comisiones, bonos, days};
  },
  preloadHorario(){
    const empId=document.getElementById('nom-emp')?.value; if(!empId) return; const emp=LocalDB.byId(Data.col.empleados,empId); const h=emp?.horario; if(!h) return;
    const set=(k,ini,fin)=>{ const i=document.getElementById('nom-'+k+'-ini'); const f=document.getElementById('nom-'+k+'-fin'); if(i) i.value=ini||''; if(f) f.value=fin||''; };
    ['lun','mar','mie','jue','vie','sab','dom'].forEach(k=> set(k, h[k]?.ini||'', h[k]?.fin||''));
    this.recalc();
  },
  peekFolio(){ const k=LocalDB.key('nomina_seq'); const cur=Number(localStorage.getItem(k)||'0'); return cur+1; },
  nextFolio(){ const k=LocalDB.key('nomina_seq'); const cur=Number(localStorage.getItem(k)||'0')+1; localStorage.setItem(k,String(cur)); this.updateFolioBadge(); return cur; },
  updateFolioBadge(){ const b=document.getElementById('nom-folio-badge'); if(b) b.textContent='Folio: '+this.peekFolio(); },
  weekRange(){ const wk=document.getElementById('nom-week')?.value||todayISO(); const mon=this.mondayOf(wk); return {mon, sun:this.addDays(mon,6), fri:this.addDays(mon,4)}; },
  guardar(){
    const data=this.recalc(); const {emp, total, bruto, anticipos, deducciones, horas, comisiones, bonos, days, sueldo}=data; const {mon,sun,fri}=this.weekRange();
    if(!emp){ alert('Selecciona un empleado'); return; }
    const hasWork = (horas>0) || (comisiones>0) || (bonos>0);
    const hasAdj = (anticipos>0) || (deducciones>0);
    if(!hasWork && !hasAdj){ alert('Captura horas, comisiones o bonos, o registra anticipos/deducciones'); return; }
    const metodo=document.getElementById('nom-met')?.value||'Efectivo';
    const pagado=document.getElementById('nom-pay')?.value||'';
    const notas=document.getElementById('nom-notas')?.value||'';
    const payDate=document.getElementById('nom-pago')?.value || fri;
    const editing=this._editId;
    const folio= editing? (LocalDB.byId(Data.col.nominas, editing)?.folio || this.peekFolio()) : this.nextFolio();
    const ok=confirm(`${editing?'Actualizar':'Registrar'} Nómina para ${emp.nombre} por ${fmt.money(total)} neto (bruto ${fmt.money(bruto)} − anticipos ${fmt.money(anticipos)})\nSemana ${mon}–${sun} · Folio: ${folio}`);
    if(!ok) return;
    // Registrar anticipos como gastos por día (afecta saldo y gastos)
    this._syncAnticiposGastos(emp, days, pagado);
    if(editing){
      const rec=LocalDB.byId(Data.col.nominas, editing); if(!rec) return;
      // Update gasto de nómina neta (solo si total>0). Si antes existía y ahora total==0, se elimina.
      const prevG = rec.gastoId? LocalDB.byId(Data.col.gastos, rec.gastoId) : null;
      if(total>0){
        if(prevG){ Data.upd(Data.col.gastos, prevG.id, {fecha:payDate,empleadoId:emp.id,descripcion:emp.nombre,pagadoPor:pagado,metodoPago:metodo,importe:Number(total.toFixed(2))}); }
        else { const g=Data.add(Data.col.gastos,{fecha:payDate,tipo:'Nómina',empleadoId:emp.id,descripcion:emp.nombre,proveedorId:null,pagadoPor:pagado,metodoPago:metodo,importe:Number(total.toFixed(2)),folio:String(folio)}); rec.gastoId=g.id; }
      } else if(prevG){ Data.del(Data.col.gastos, prevG.id); rec.gastoId=null; }
      Data.upd(Data.col.nominas, editing, {empleadoId:emp.id,empleadoNombre:emp.nombre,sueldoHora:sueldo,semanaMon:mon,semanaSun:sun,pagoFecha:payDate,metodoPago:metodo,pagadoPor:pagado,horas:Number(horas.toFixed(2)),comisiones:Number(comisiones.toFixed(2)),bonos:Number(bonos.toFixed(2)),deducciones:Number(deducciones.toFixed(2)),anticipos:Number(anticipos.toFixed(2)),bruto:Number(bruto.toFixed(2)),total:Number(total.toFixed(2)),days, notas});
      notify('Nómina actualizada','success'); this.setEditing(null);
    } else {
      let gastoId=null; if(total>0){ const g=Data.add(Data.col.gastos,{fecha:payDate,tipo:'Nómina',empleadoId:emp.id,descripcion:emp.nombre,proveedorId:null,pagadoPor:pagado,metodoPago:metodo,importe:Number(total.toFixed(2)),folio:String(folio)}); gastoId=g.id; }
      Data.add(Data.col.nominas,{folio:String(folio),empleadoId:emp.id,empleadoNombre:emp.nombre,sueldoHora:sueldo,semanaMon:mon,semanaSun:sun,pagoFecha:payDate,metodoPago:metodo,pagadoPor:pagado,horas:Number(horas.toFixed(2)),comisiones:Number(comisiones.toFixed(2)),bonos:Number(bonos.toFixed(2)),deducciones:Number(deducciones.toFixed(2)),anticipos:Number(anticipos.toFixed(2)),bruto:Number(bruto.toFixed(2)),total:Number(total.toFixed(2)),days, notas, gastoId, createdAt:new Date().toISOString()});
      notify('Nómina registrada como gasto','success');
    }
    renderNominas(); renderGastos(); renderDashboard();
  },
  _syncAnticiposGastos(emp, days, pagadoPor){
    if(!emp) return;
    const gastos=Data.get(Data.col.gastos);
    const refsToKeep=new Set();
    days.forEach(d=>{
      const amt=Number(d.anticipo||0);
      const fecha=d.fecha; if(!fecha) return;
      const ref=`ANT-${emp.id}-${fecha}`; const metodo=(d.anticipoMet||'Efectivo');
      if(amt>0){
        const exist=gastos.find(g=> g.folio===ref);
        const payload={fecha, tipo:'Nómina', empleadoId:emp.id, descripcion:`Anticipo ${emp.nombre}`, proveedorId:null, pagadoPor:pagadoPor||'', metodoPago:metodo, importe:amt, folio:ref};
        if(exist){ Data.upd(Data.col.gastos, exist.id, payload); }
        else { Data.add(Data.col.gastos, payload); }
        refsToKeep.add(ref);
      } else {
        const exist=gastos.find(g=> g.folio===ref); if(exist) Data.del(Data.col.gastos, exist.id);
      }
    });
  },
  exportPDF(){
    const {emp, sueldo, horas, total, comisiones, bonos, deducciones, anticipos, days}=this.recalc(); const {mon,sun}=this.weekRange();
    const folio=this.peekFolio(); const notas=document.getElementById('nom-notas')?.value||''; const logoSrc=document.getElementById('app-logo')?.src||'assets/bettermood_logo-10.png'; const pay=document.getElementById('nom-pago')?.value||'';
    if(!emp){ alert('Selecciona un colaborador'); return; }
    const esc=(s)=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const label={lun:'Lunes',mar:'Martes',mie:'Miércoles',jue:'Jueves',vie:'Viernes',sab:'Sábado',dom:'Domingo'};
  const rows=days.map(d=>`<tr><td>${esc(label[d.k])}</td><td>${fmt.dateOnly(d.fecha)}</td><td>${esc(d.ini)}</td><td>${esc(d.fin)}</td><td class='right'>${d.horas.toFixed(2)}</td><td class='right'>${fmt.money(d.comision||0)}</td><td class='right'>${fmt.money(d.bono||0)}</td><td class='right'>${fmt.money(d.deduccion||0)}</td><td class='right'>${fmt.money(d.anticipo||0)}</td><td>${esc(d.anticipoMet||'')}</td></tr>`).join('');
    const content=`<div class='pdf-root'>
      <style> .pdf-root{font:12px system-ui;color:#000} h1,h2{margin:0 0 8px 0} h1{font-size:28px} table{width:100%;border-collapse:collapse;margin-top:8px} th,td{border:1px solid #ccc;padding:6px;text-align:left} .right{text-align:right} .muted{color:#555} .tot{font-weight:700} header{display:flex;align-items:center;gap:16px;margin-bottom:12px} header img{width:96px;height:96px;border-radius:12px;object-fit:cover}</style>
      <header><img src='${logoSrc}' alt='logo'><div><h1 style='margin:0'>Nómina</h1><div class='muted'>Folio: ${folio} · Semana: ${mon} a ${sun} · Pago: ${pay}</div></div></header>
      <h2>Colaborador: ${esc(emp.nombre)} (${sueldo? '$'+sueldo+'/h':'$0/h'})</h2>
      <table><thead><tr><th>Día</th><th>Fecha</th><th>Entrada</th><th>Salida</th><th>Horas</th><th>Comisión</th><th>Bono</th><th>Deducción</th><th>Anticipo</th><th>Método</th></tr></thead><tbody>${rows}</tbody></table>
      <div style='margin-top:12px;max-width:320px'>
        <div class='right'>Horas totales: <strong>${horas.toFixed(2)}</strong></div>
        <div class='right'>Sueldo por hora: <strong>${fmt.money(sueldo)}</strong></div>
        <div class='right'>Comisiones: <strong>${fmt.money(comisiones)}</strong></div>
        <div class='right'>Bonos: <strong>${fmt.money(bonos)}</strong></div>
        <div class='right'>Deducciones admin: <strong>${fmt.money(deducciones)}</strong></div>
        <div class='right'>Anticipos: <strong>${fmt.money(anticipos)}</strong></div>
        <div class='right tot'>Total neto a pagar: <strong>${fmt.money(total)}</strong></div>
      </div>
      <p class='muted'>${esc(emp.agradecimiento || '¡Gracias por tu trabajo esta semana y por tu compromiso en cada turno!')}</p>
      ${notas? `<div style='margin-top:8px'><strong>Comentarios:</strong><br>${esc(notas)}</div>`:''}
    </div>`;
    const w=window.open('about:blank','_blank');
    w.document.write(`<!doctype html><title>${'Nomina '+emp.nombre}</title><body>${content}<script>setTimeout(()=>window.print(),150)<\/script></body>`);
    w.document.close();
  },
  sharePDF(id){
    const r=LocalDB.byId(Data.col.nominas,id); if(!r) return; const emp=LocalDB.byId(Data.col.empleados,r.empleadoId)||{nombre:r.empleadoNombre,sueldoHora:r.sueldoHora,agradecimiento:''}; const logoSrc=document.getElementById('app-logo')?.src||'assets/bettermood_logo-10.png';
    const esc=(s)=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const label={lun:'Lunes',mar:'Martes',mie:'Miércoles',jue:'Jueves',vie:'Viernes',sab:'Sábado',dom:'Domingo'};
    const rows=(r.days||[]).map(d=>`<tr><td>${esc(label[d.k]||d.k)}</td><td>${d.fecha||''}</td><td>${esc(d.ini||'')}</td><td>${esc(d.fin||'')}</td><td class='right'>${Number(d.horas||0).toFixed(2)}</td><td class='right'>${fmt.money(Number(d.comision||0))}</td><td class='right'>${fmt.money(Number(d.bono||0))}</td><td class='right'>${fmt.money(Number(d.deduccion||0))}</td><td class='right'>${fmt.money(Number(d.anticipo||0))}</td><td>${esc(d.anticipoMet||'')}</td></tr>`).join('');
    const content=`<div class='pdf-root'>
      <style> .pdf-root{font:12px system-ui;color:#000} h1,h2{margin:0 0 8px 0} h1{font-size:28px} table{width:100%;border-collapse:collapse;margin-top:8px} th,td{border:1px solid #ccc;padding:6px;text-align:left} .right{text-align:right} .muted{color:#555} .tot{font-weight:700} header{display:flex;align-items:center;gap:16px;margin-bottom:12px} header img{width:96px;height:96px;border-radius:12px;object-fit:cover}</style>
      <header><img src='${logoSrc}' alt='logo'><div><h1 style='margin:0'>Nómina</h1><div class='muted'>Folio: ${r.folio} · Semana: ${r.semanaMon} a ${r.semanaSun} · Pago: ${r.pagoFecha||''}</div></div></header>
      <h2>Colaborador: ${esc(emp.nombre)} (${emp.sueldoHora? '$'+emp.sueldoHora+'/h':'$0/h'})</h2>
      <table><thead><tr><th>Día</th><th>Fecha</th><th>Entrada</th><th>Salida</th><th>Horas</th><th>Comisión</th><th>Bono</th><th>Deducción</th><th>Anticipo</th><th>Método</th></tr></thead><tbody>${rows}</tbody></table>
      <div style='margin-top:12px;max-width:320px'>
        <div class='right'>Horas totales: <strong>${Number(r.horas||0).toFixed(2)}</strong></div>
        <div class='right'>Sueldo por hora: <strong>${fmt.money(emp.sueldoHora||r.sueldoHora||0)}</strong></div>
        <div class='right'>Comisiones: <strong>${fmt.money(Number(r.comisiones||0))}</strong></div>
        <div class='right'>Bonos: <strong>${fmt.money(Number(r.bonos||0))}</strong></div>
        <div class='right'>Deducciones admin: <strong>${fmt.money(Number(r.deducciones||0))}</strong></div>
        <div class='right'>Anticipos: <strong>${fmt.money(Number(r.anticipos||0))}</strong></div>
        <div class='right tot'>Total neto a pagar: <strong>${fmt.money(Number(r.total||0))}</strong></div>
      </div>
      <p class='muted'>${esc(emp.agradecimiento || '¡Gracias por tu trabajo esta semana y por tu compromiso en cada turno!')}</p>
      ${r.notas? `<div style='margin-top:8px'><strong>Comentarios:</strong><br>${esc(r.notas)}</div>`:''}
    </div>`;
    const w=window.open('about:blank','_blank');
    w.document.write(`<!doctype html><title>${'Nomina '+emp.nombre}</title><body>${content}<script>setTimeout(()=>window.print(),150)<\/script></body>`);
    w.document.close();
  },
  load(id){
    const r=LocalDB.byId(Data.col.nominas,id); if(!r) return; // set fields
    const empSel=document.getElementById('nom-emp'); empSel.value=r.empleadoId||'';
    const wk=document.getElementById('nom-week'); wk.value=r.semanaMon; this.syncWeekDates();
    const set=(k,ini,fin,com,bono,ded,adv,advm)=>{ const i=document.getElementById('nom-'+k+'-ini'); const f=document.getElementById('nom-'+k+'-fin'); const c=document.getElementById('nom-'+k+'-com'); const b=document.getElementById('nom-'+k+'-bono'); const dEl=document.getElementById('nom-'+k+'-ded'); const a=document.getElementById('nom-'+k+'-adv'); const m=document.getElementById('nom-'+k+'-advm'); if(i) i.value=ini||''; if(f) f.value=fin||''; if(c) c.value=Number(com||0).toFixed(2); if(b) b.value=Number(bono||0).toFixed(2); if(dEl) dEl.value=Number(ded||0).toFixed(2); if(a) a.value=Number(adv||0).toFixed(2); if(m) m.value=advm||'Efectivo'; };
    (r.days||[]).forEach(d=> set(d.k, d.ini, d.fin, d.comision, d.bono, d.deduccion, d.anticipo, d.anticipoMet));
    document.getElementById('nom-met').value=r.metodoPago||'Efectivo'; document.getElementById('nom-pay').value=r.pagadoPor||'';
    document.getElementById('nom-folio-badge').textContent='Folio: '+r.folio;
    const notas=document.getElementById('nom-notas'); if(notas) notas.value=r.notas||'';
    const pay=document.getElementById('nom-pago'); if(pay){ pay.value=r.pagoFecha||''; pay.dataset.autofill='0'; }
    this.setEditing(id, r.folio); this.recalc();
  },
  eliminar(id){
    const r=LocalDB.byId(Data.col.nominas,id); if(!r) return; if(!confirm('¿Eliminar nómina folio '+r.folio+'?')) return;
    if(r.gastoId && LocalDB.byId(Data.col.gastos,r.gastoId)) Data.del(Data.col.gastos,r.gastoId);
    // Eliminar gastos de anticipos asociados a la semana de esta nómina
    try{
      const gs=Data.get(Data.col.gastos);
      const refs=new Set((r.days||[]).filter(d=> Number(d.anticipo||0)>0 && d.fecha).map(d=> `ANT-${r.empleadoId}-${d.fecha}`));
      gs.filter(g=> refs.has(g.folio)).forEach(g=> Data.del(Data.col.gastos, g.id));
    }catch(e){}
    Data.del(Data.col.nominas,id); notify('Nómina eliminada','success'); renderNominas(); renderGastos(); renderDashboard(); this.setEditing(null);
  },
  duplicar(id){
    const r=LocalDB.byId(Data.col.nominas,id); if(!r) return; const add7=(iso)=>{ const d=new Date((iso||'')+'T00:00:00'); d.setDate(d.getDate()+7); return d.toISOString().slice(0,10); };
    const folio=this.nextFolio(); const mon=add7(r.semanaMon), sun=add7(r.semanaSun), fri=add7(r.pagoFecha);
    const days=(r.days||[]).map(d=>({...d, fecha:add7(d.fecha)}));
    const g=Data.add(Data.col.gastos,{fecha:fri,tipo:'Nómina',empleadoId:r.empleadoId,descripcion:r.empleadoNombre,proveedorId:null,pagadoPor:r.pagadoPor||'',metodoPago:r.metodoPago||'Efectivo',importe:Number(r.total||0),folio:String(folio)});
    Data.add(Data.col.nominas,{folio:String(folio),empleadoId:r.empleadoId,empleadoNombre:r.empleadoNombre,sueldoHora:r.sueldoHora,semanaMon:mon,semanaSun:sun,pagoFecha:fri,metodoPago:r.metodoPago,pagadoPor:r.pagadoPor,horas:r.horas,comisiones:r.comisiones||0,bonos:r.bonos||0,anticipos:r.anticipos||0,bruto:r.bruto|| (Number(r.total||0)+Number(r.anticipos||0)), total:r.total,days,gastoId:g.id, createdAt:new Date().toISOString()});
    notify('Nómina duplicada','success'); renderNominas(); renderGastos(); renderDashboard();
  }
};

function renderNominas(){
  const tb=document.querySelector('#tbl-nominas tbody'); if(!tb) return;
  const rows=Data.get(Data.col.nominas).sort((a,b)=> Number(b.folio)-Number(a.folio));
  tb.innerHTML=rows.map(r=>{
    const weekStart=r.semanaMon||'';
    const weekEnd=r.semanaSun || (weekStart? addDaysISO(weekStart,6) : '');
    const sem=weekStart? `${formatShortDate(weekStart)} – ${formatShortDate(weekEnd)}` : '—';
    const pago=r.pagoFecha? formatShortDate(r.pagoFecha) : '—';
    const acc=`<button class='btn' onclick=\"nominaGen.load('${r.id}')\">Editar</button> <button class='btn' onclick=\"nominaGen.duplicar('${r.id}')\">Duplicar</button> <button class='btn danger' onclick=\"nominaGen.eliminar('${r.id}')\">Eliminar</button> <button class='btn' onclick=\"nominaGen.sharePDF('${r.id}')\">PDF</button>`;
    const com=Number(r.comisiones||0), bon=Number(r.bonos||0), ant=Number(r.anticipos||0); const bruto=Number(r.bruto|| (Number(r.total||0)+ant)); const neto=Number(r.total||0);
    return `<tr><td>${r.folio}</td><td>${r.empleadoNombre||''}</td><td>${sem}</td><td>${(r.horas||0).toFixed(2)}</td><td>${fmt.money(com)}</td><td>${fmt.money(bon)}</td><td>${fmt.money(ant)}</td><td>${fmt.money(bruto)}</td><td>${fmt.money(neto)}</td><td>${pago}</td><td>${r.metodoPago||''}</td><td>${acc}</td></tr>`;
  }).join('');
  bindNominaFilters();
  renderNominaInsights();
}

// KPI helpers y gráficas
function sumVentasEmpleadoSemana(empId, desde, hasta){
  if(!empId) return 0; const tickets=Data.get(Data.col.ventas_ticket).filter(t=> t.baristaId===empId && inRange(t.fechaHora, desde, hasta));
  return tickets.reduce((s,t)=> s + Number(t.total||0), 0);
}
let nomFiltersBound=false;
function bindNominaFilters(){
  if(nomFiltersBound) return;
  ['nom-v-group','nom-v-emp','nom-v-desde','nom-v-hasta'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.addEventListener('change', ()=> renderNominaInsights());
  });
  nomFiltersBound=true;
}
function renderNominaInsights(){
  try{
    const wk = nominaGen.weekRange?.() || {mon:todayISO(), sun:todayISO()};
    const desde=document.getElementById('nom-v-desde')?.value || wk.mon;
    const hasta=document.getElementById('nom-v-hasta')?.value || wk.sun;
    const empSel=document.getElementById('nom-v-emp')?.value||'';
    const group=document.getElementById('nom-v-group')?.value||'semana';
    const emps=Data.get(Data.col.empleados)||[];
    const nominas=Data.get(Data.col.nominas)||[];
    const inDateRange=(n)=>{
      if(!desde && !hasta) return true;
      const dias=(n.days||[]).map(d=>d.fecha).filter(Boolean);
      if(dias.length) return dias.some(fecha=> inRange(fecha, desde, hasta));
      const ref=n.pagoFecha || n.semanaSun || n.semanaMon;
      return ref? inRange(ref, desde, hasta):false;
    };
    const filtered=nominas.filter(n=> (!empSel || n.empleadoId===empSel) && inDateRange(n));
    const ensure=(map,key,label)=>{
      if(!map.has(key)) map.set(key,{key,label,com:0,ventas:0,nomina:0});
      return map.get(key);
    };
    const addDays=(iso,n)=>{ if(!iso) return ''; const d=new Date(iso+'T00:00:00'); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); };
    const formatDate=(iso)=>{ if(!iso) return 'Sin fecha'; const out=formatShortDate(iso); return out||'Sin fecha'; };
    const formatMonth=(ym)=>{ if(!ym) return 'Sin mes'; const [y,m]=ym.split('-'); if(!y||!m) return ym; try{ return new Intl.DateTimeFormat('es-MX',{month:'short',year:'numeric'}).format(new Date(`${ym}-01T00:00:00`)); }catch(e){ return ym; } };
    const formatWeek=(mon,sun)=>{ if(!mon) return 'Sin semana'; const fin=sun || addDays(mon,6); return `${formatDate(mon)} – ${formatDate(fin)}`; };
    const periodoMap=new Map();
    const diaMap=new Map();
    const semanaMap=new Map();
    const colaboradorMap=new Map();
    let totalCom=0, totalVentasEst=0, totalNomina=0;
    filtered.forEach(n=>{
      const comTot=Number(n.comisiones||0);
      const ventasEst=comTot/COMM_RATE;
      const nominaReal=Number(n.bruto || (Number(n.total||0)+Number(n.anticipos||0)));
      if(comTot>0){ totalCom+=comTot; totalVentasEst+=ventasEst; }
      if(nominaReal){ totalNomina+=nominaReal; }
      const labelPeriodo=(()=>{
        switch(group){
          case 'dia': return {key:n.pagoFecha||n.semanaSun||n.semanaMon||'', label:formatDate(n.pagoFecha||n.semanaSun||n.semanaMon||'')};
          case 'mes': { const base=(n.semanaMon||n.pagoFecha||'').slice(0,7); return {key:base,label:formatMonth(base)}; }
          case 'colaborador': return {key:n.empleadoId||'sin', label:n.empleadoNombre||'Sin asignar'};
          default: return {key:n.semanaMon||n.pagoFecha||'', label:formatWeek(n.semanaMon, n.semanaSun)};
        }
      })();
      if(labelPeriodo.key){
        const item=ensure(periodoMap,labelPeriodo.key,labelPeriodo.label);
        item.com += comTot;
        item.ventas += ventasEst;
        item.nomina += nominaReal;
      }
      const semanaKey=n.semanaMon || n.pagoFecha || '';
      if(semanaKey){
        const item=ensure(semanaMap, semanaKey, formatWeek(semanaKey, n.semanaSun));
        item.com += comTot;
        item.ventas += ventasEst;
        item.nomina += nominaReal;
      }
      const colKey=n.empleadoId||'sin';
      const colItem=ensure(colaboradorMap, colKey, n.empleadoNombre||'Sin asignar');
      colItem.com += comTot;
      colItem.ventas += ventasEst;
      colItem.nomina += nominaReal;
      let dayLogged=false;
      (n.days||[]).forEach(d=>{
        if(!d.fecha) return;
        const comDia=Number(d.comision||0);
        const ventasDia=comDia/COMM_RATE;
        if(!comDia && !ventasDia) return;
        const item=ensure(diaMap, d.fecha, formatDate(d.fecha));
        item.com += comDia;
        item.ventas += ventasDia;
        dayLogged=true;
      });
      if(!dayLogged && comTot){
        const fallback=n.pagoFecha || n.semanaSun || n.semanaMon || '';
        if(fallback){
          const item=ensure(diaMap, fallback, formatDate(fallback));
          item.com += comTot;
          item.ventas += ventasEst;
        }
      }
    });
    const sortChrono=(map)=>[...map.entries()].sort((a,b)=> new Date(a[0]) - new Date(b[0]));
    const sortAlpha=(map)=>[...map.entries()].sort((a,b)=> String(a[0]).localeCompare(String(b[0])));
    const sortDesc=(map)=>[...map.entries()].sort((a,b)=> b[1].com - a[1].com);
    let periodoEntries;
    if(group==='colaborador') periodoEntries=sortDesc(periodoMap);
    else if(group==='mes') periodoEntries=sortAlpha(periodoMap);
    else periodoEntries=sortChrono(periodoMap);
    const periodoLabels=periodoEntries.length? periodoEntries.map(([_,v])=>v.label):['Sin datos'];
    const periodoCom=periodoEntries.length? periodoEntries.map(([_,v])=>v.com):[0];
    const periodoVentas=periodoEntries.length? periodoEntries.map(([_,v])=>v.ventas):[0];
    const periodoNomina=periodoEntries.length? periodoEntries.map(([_,v])=>v.nomina):[0];
    const diaEntries=sortChrono(diaMap);
    const diaIso=diaEntries.length? diaEntries.map(([iso])=>iso):[];
    const diaLabels=diaEntries.length? diaEntries.map(([_,v])=>v.label):['Sin datos'];
    const diaCom=diaEntries.length? diaEntries.map(([_,v])=>v.com):[0];
    const semanaEntries=sortChrono(semanaMap);
    const semanaLabels=semanaEntries.length? semanaEntries.map(([_,v])=>v.label):['Sin datos'];
    const semanaCom=semanaEntries.length? semanaEntries.map(([_,v])=>v.com):[0];
    const colEntries=sortDesc(colaboradorMap);
    const colLabels=colEntries.length? colEntries.map(([_,v])=>v.label):['Sin datos'];
    const colCom=colEntries.length? colEntries.map(([_,v])=>v.com):[0];
    const colVentas=colEntries.length? colEntries.map(([_,v])=>v.ventas):[0];
    const rangoDesde=desde||wk.mon;
    const rangoHasta=hasta||wk.sun;
    const ticketsRango=Data.get(Data.col.ventas_ticket).filter(t=> inRange(t.fechaHora, rangoDesde, rangoHasta) && (!empSel || t.baristaId===empSel));
    const ventasRegistradas=ticketsRango.reduce((acc,t)=> acc + Number(t.total||0),0);
    const ventasTotalesPorDia={};
    ticketsRango.forEach(t=>{ const dia=businessDateISO(t.fechaHora); ventasTotalesPorDia[dia]=(ventasTotalesPorDia[dia]||0)+Number(t.total||0); });
    const diaVentas=diaEntries.length? diaEntries.map(([iso,v])=>Number(v.ventas||0)):[0];
    const diaPct=diaEntries.length? diaIso.map(iso=>{ const vend=diaMap.get(iso)?.ventas||0; const tot=ventasTotalesPorDia[iso]||0; return tot? (vend/tot*100):0; }):[0];
    drawBars('chart-ventas-com-dia', diaLabels, diaVentas, '#F87171', {labelRotation:-Math.PI/4});
    drawBars('chart-ventas-com-pct', diaLabels, diaPct, '#1D4ED8', {axisMode:'percent', labelRotation:-Math.PI/4});
    const chartData={
      periodoLabels, periodoCom, periodoVentas, periodoNomina,
      diaLabels, diaCom, diaVentas, diaPct,
      semanaLabels, semanaCom,
      colLabels, colCom, colVentas,
      ventasComparativo:[totalVentasEst, ventasRegistradas]
    };
    window._nominaChartsData = chartData;
    renderNominaCharts(chartData);
    const ticketIds=new Set(ticketsRango.map(t=> t.id));
    const productos=Data.get(Data.col.ventas_detalle).filter(d=> ticketIds.has(d.ticketId));
    const prodMap=new Map();
    productos.forEach(p=>{
      const key=p.descripcion||p.sku||'Producto';
      if(!prodMap.has(key)) prodMap.set(key,{cant:0, venta:0});
      const item=prodMap.get(key);
      item.cant += Number(p.cantidad||0);
      item.venta += Number(p.subtotal||0);
    });
    const topProductos=[...prodMap.entries()].sort((a,b)=> b[1].venta - a[1].venta).slice(0,8);
    window._topCommissionProducts = topProductos;
    const prodEl=document.getElementById('nom-v-productos');
    if(prodEl){
      if(!topProductos.length){
        prodEl.innerHTML='<small class="muted">Sin ventas registradas en el rango seleccionado.</small>';
      } else {
        const rows=topProductos.map(([nombre,data])=> `<tr><td>${nombre}</td><td>${data.cant.toFixed(2)}</td><td>${fmt.money(data.venta)}</td></tr>`).join('');
        prodEl.innerHTML=`<table class="table"><thead><tr><th>Producto</th><th>Cant.</th><th>Venta estimada</th></tr></thead><tbody>${rows}</tbody></table>`;
      }
    }
    const globalShare = ventasRegistradas? (totalVentasEst/ventasRegistradas*100):0;
    window._commissionShare = {ventasCom:totalVentasEst,total:ventasRegistradas,pct:globalShare};
    window._commissionDaily = {labels:diaEntries.length?diaLabels:[], ventas:diaEntries.length?diaVentas:[], pct:diaEntries.length?diaPct:[]};
    const shareBadge=document.querySelector('#kpi-share-card .big');
    if(shareBadge) shareBadge.textContent = ventasRegistradas? `${fmt.num(globalShare)}%` : '--';
    const ideasEl=document.getElementById('nom-v-ideas');
    if(ideasEl){
      ideasEl.innerHTML=`
        <li>Activa misiones semanales con metas de venta por producto estrella y desbloquea bonos progresivos al alcanzarlas.</li>
        <li>Habilita alertas en vivo que comparen la comisión acumulada vs. meta diaria para motivar cierres proactivos.</li>
        <li>Integra un ranking histórico que combine ventas estimadas y NPS por colaborador para premiar experiencias memorables.</li>`;
    }
    const kEl=document.getElementById('nom-v-kpis');
    if(kEl){
      const card=(label,value)=>`<div class='card kpi'><div><small>${label}</small><div class='big'>${value}</div></div></div>`;
      if(empSel){
        const empName=(emps.find(e=>e.id===empSel)?.nombre)||'Colaborador';
        const diasTrab=diaMap.size||1;
        kEl.innerHTML=[
          card(`${empName} · Comisiones`, fmt.money(totalCom)),
          card('Ventas estimadas 4%', fmt.money(totalVentasEst)),
          card('Nómina real (bruto)', fmt.money(totalNomina)),
          card('Promedio diario comisión', fmt.money(diasTrab? totalCom/diasTrab : 0)),
          card('Semanas registradas', semanaMap.size||0),
          card('Participación comisionada', ventasRegistradas? `${fmt.num(globalShare)}%`:'0%')
        ].join('');
      } else {
        const topCol=colEntries[0];
        const promCom = colEntries.length? totalCom/colEntries.length : 0;
        kEl.innerHTML=[
          card('Comisiones totales', fmt.money(totalCom)),
          card('Ventas estimadas totales', fmt.money(totalVentasEst)),
          card('Nómina real total', fmt.money(totalNomina)),
          card('Colaboradores con comisión', colEntries.length),
          card('Promedio comisión por colaborador', fmt.money(promCom)),
          card('Top comisión', topCol? `${topCol[1].label} · ${fmt.money(topCol[1].com)}`:'N/D'),
          card('Participación comisionada', ventasRegistradas? `${fmt.num(globalShare)}%`:'0%')
        ].join('');
      }
    }
    const formulaEl=document.getElementById('nom-v-formula');
    if(formulaEl){
      formulaEl.innerHTML=`
        <h4 style="margin:0 0 6px 0">Fórmula aplicada</h4>
        <p class="muted" style="margin:0 0 8px 0">Ventas estimadas = ${fmt.money(totalCom)} ÷ 0.04</p>
        <div class="kpi"><small>Resultado actual</small><strong>${fmt.money(totalVentasEst)}</strong></div>
        <div class="kpi"><small>Participación comisionada</small><strong>${ventasRegistradas? fmt.num(globalShare)+'%':'0%'}</strong></div>`;
    }
    if(window._dashboardInsights) renderGrowthInsights(window._dashboardInsights);
  }catch(e){ console.error(e); }
}

function renderNominaCharts(data){
  if(!data) return;
  drawBars('chart-nomina-com-periodo', data.periodoLabels, data.periodoCom, '#6366F1', {axisMode:'money'});
  drawBars('chart-nomina-ventas-periodo', data.periodoLabels, data.periodoVentas, '#22D3EE', {axisMode:'money'});
  drawBars('chart-nomina-real-periodo', data.periodoLabels, data.periodoNomina, '#34D399', {axisMode:'money'});
  drawBars('chart-nomina-com-dia', data.diaLabels, data.diaCom, '#F59E0B', {labelRotation:-Math.PI/4, axisMode:'money'});
  drawBars('chart-ventas-com-dia', data.diaLabels, data.diaVentas, '#F87171', {labelRotation:-Math.PI/4, axisMode:'money'});
  drawBars('chart-ventas-com-pct', data.diaLabels, data.diaPct, '#1D4ED8', {labelRotation:-Math.PI/4, axisMode:'percent', avgColor:'#2563EB'});
  drawBars('chart-nomina-com-semana', data.semanaLabels, data.semanaCom, '#A855F7', {axisMode:'money'});
  drawBars('chart-nomina-com-col', data.colLabels, data.colCom, '#F97316', {axisMode:'money'});
  drawBars('chart-nomina-ventas-col', data.colLabels, data.colVentas, '#10B981', {axisMode:'money'});
  drawBars('chart-nomina-ventas-total', ['Ventas estimadas','Ventas registradas'], data.ventasComparativo, '#EF4444', {axisMode:'money', labelRotation:0});
}

function toggleNominaHistorial(force){
  const body=document.getElementById('nom-hist-body');
  const btn=document.getElementById('nom-hist-toggle');
  if(!body || !btn) return;
  let collapsed=body.classList.contains('collapsed');
  if(typeof force==='string'){
    collapsed = force==='close';
  } else {
    collapsed=!collapsed;
  }
  body.classList.toggle('collapsed', collapsed);
  body.setAttribute('aria-hidden', collapsed?'true':'false');
  btn.textContent= collapsed? 'Expandir' : 'Contraer';
  btn.setAttribute('aria-expanded', collapsed?'false':'true');
}

function saveLedgerSaldos(){
  const se=Number(document.getElementById('ld-saldo-efec')?.value||0);
  const sb=Number(document.getElementById('ld-saldo-banco')?.value||0);
  cfg.saldoIniEfectivo=se; cfg.saldoIniBanco=sb; localStorage.setItem(LocalDB.key('cfg'), JSON.stringify(cfg));
  notify('Saldos iniciales guardados','success'); renderDashboard();
}

function renderDeposCalendar(){
  const tb=document.querySelector('#tbl-depositos tbody'); if(!tb) return;
  const ds=dailySeries(); const today=todayISO();
  const scope=(document.getElementById('dep-scope')?.value)||'proximos';
  const weekKey=(iso)=>{ const d=new Date(iso+'T00:00:00'); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); return d.toISOString().slice(0,10); }
  const mondayNext=(iso)=>{ const d=new Date(iso+'T00:00:00'); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day+7); return d.toISOString().slice(0,10); }
  const fridayOfWeek=(iso)=>{ const d=new Date(iso+'T00:00:00'); const dow=d.getDay(); const diff=(5 - dow + 7)%7; d.setDate(d.getDate()+diff); return d.toISOString().slice(0,10); }
  const nextFriday=(iso)=>{ const d=new Date(iso+'T00:00:00'); d.setDate(d.getDate()+7); return d.toISOString().slice(0,10); }
  const accU={}, accR={};
  ds.labels.forEach((d,i)=>{ accU[weekKey(d)]=(accU[weekKey(d)]||0)+(ds.dataByMethod['Uber'][i]||0); const fri=fridayOfWeek(d); accR[fri]=(accR[fri]||0)+(ds.dataByMethod['Rappi'][i]||0); });
  const rows=[];
  Object.entries(accU).forEach(([wk,sum])=>{ const dep=mondayNext(wk); const amt=Number((sum*0.65).toFixed(2)); if(amt>0){ const isFuture=dep>=today; const ok = scope==='todos' || (scope==='proximos' && isFuture) || (scope==='pasados' && !isFuture); if(ok) rows.push({fecha:dep, plataforma:'Uber', monto:amt}); } });
  Object.entries(accR).forEach(([fri,sum])=>{ const dep=nextFriday(fri); const amt=Number((sum*0.65).toFixed(2)); if(amt>0){ const isFuture=dep>=today; const ok = scope==='todos' || (scope==='proximos' && isFuture) || (scope==='pasados' && !isFuture); if(ok) rows.push({fecha:dep, plataforma:'Rappi', monto:amt}); } });
  rows.sort((a,b)=> new Date(a.fecha) - new Date(b.fecha));
  tb.innerHTML=rows.slice(0,10).map(r=>`<tr><td>${fmt.dateOnly(r.fecha)}</td><td>${r.plataforma}</td><td>${fmt.money(r.monto)}</td></tr>`).join('') || '<tr><td colspan="3">Sin depósitos próximos calculados</td></tr>';
}

/*******************
 * BMC: Render Tabs *
 *******************/
function renderVentas(){
  const tb=document.querySelector('#tbl-ventas tbody');
  let rows=Data.get(Data.col.ventas_ticket);
  const dEl=document.getElementById('v-desde'), hEl=document.getElementById('v-hasta');
  if(dEl && !dEl.value) dEl.value=document.getElementById('dash-desde')?.value||'';
  if(hEl && !hEl.value) hEl.value=document.getElementById('dash-hasta')?.value||'';
  const desde=dEl?.value||'', hasta=hEl?.value||''; const met=document.getElementById('v-met')?.value||'';
  rows = rows.filter(r=> (!met || String(r.metodoPago||'')===met) && (!desde || businessDateISO(r.fechaHora)>=desde) && (!hasta || businessDateISO(r.fechaHora)<=hasta));
  rows.sort((a,b)=> new Date(b.fechaHora)-new Date(a.fechaHora));
  tb.innerHTML=rows.map(r=>`<tr><td>${fmt.date(r.fechaHora)}</td><td>${r.folio||''}</td><td>${LocalDB.byId(Data.col.estaciones,r.estacionId)?.nombre||''}</td><td>${LocalDB.byId(Data.col.empleados,r.baristaId)?.nombre||''}</td><td>${r.metodoPago||''}</td><td>${fmt.money(r.subtotal)}</td><td>${fmt.money(r.impuestos)}</td><td>${fmt.money(r.total)}</td><td><button class='btn' onclick="ventasRapidas.openEdit('${r.id}')">Editar</button> <button class='btn' onclick="ventasRapidas.duplicar('${r.id}')">Duplicar</button> <button class='btn danger' onclick="ventasRapidas.eliminar('${r.id}')">Eliminar</button></td></tr>`).join('');
  const weekdayRange=document.getElementById('ventas-weekday-range');
  if(weekdayRange){
    if(desde || hasta){
      const prettyDesde=desde? fmt.dateOnly(desde):'inicio';
      const prettyHasta=hasta? fmt.dateOnly(hasta):'hoy';
      weekdayRange.textContent=`${prettyDesde} → ${prettyHasta}`;
    } else {
      weekdayRange.textContent='Todo el histórico disponible';
    }
  }
  const weekdayOrder=[1,2,3,4,5,6,0];
  const weekdayNames=['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
  const weekdayTotals=Array(7).fill(0); const weekdayCount=Array(7).fill(0);
  rows.forEach(r=>{
    const iso=businessDateISO(r.fechaHora);
    const day=new Date(iso+'T00:00:00').getDay();
    weekdayTotals[day]+=Number(r.total||0);
    weekdayCount[day]+=1;
  });
  const totalVentas=weekdayTotals.reduce((a,b)=>a+b,0);
  const weekdayData=weekdayOrder.map(dow=>{
    const total=weekdayTotals[dow]||0;
    const count=weekdayCount[dow]||0;
    const avg = count? total/count:0;
    const share = totalVentas? (total/totalVentas*100):0;
    return {dow,name:weekdayNames[dow],total,count,avg,share};
  });
  const nonZeroDays=weekdayData.filter(d=>d.total>0);
  const bestDay=nonZeroDays.length? nonZeroDays.reduce((best,item)=> item.total>best.total? item:best, nonZeroDays[0]):null;
  const worstDay=nonZeroDays.length? nonZeroDays.reduce((worst,item)=> item.total<worst.total? item:worst, nonZeroDays[0]):null;
  const avgDia = weekdayData.reduce((s,d)=> s+d.total,0) / (weekdayData.filter(d=>d.count>0).length||1);
  const summaryEl=document.getElementById('ventas-weekday-summary');
  if(summaryEl){
    if(rows.length){
      summaryEl.innerHTML=[
        bestDay? `<div class="summary-card"><small>Mejor día</small><strong>${bestDay.name}</strong><span>${fmt.money(bestDay.total)} · ${fmt.money(bestDay.avg)}/ticket</span></div>`:'',
        worstDay? `<div class="summary-card"><small>Día a reforzar</small><strong>${worstDay.name}</strong><span>${fmt.money(worstDay.total)} · ${fmt.money(worstDay.avg)}/ticket</span></div>`:'',
        `<div class="summary-card"><small>Promedio diario</small><strong>${fmt.money(avgDia)}</strong><span>Total periodo: ${fmt.money(totalVentas)}</span></div>`
      ].filter(Boolean).join('');
    } else {
      summaryEl.innerHTML='<div class="summary-card"><small>Sin datos</small><strong>--</strong><span>Captura ventas para ver tendencias</span></div>';
    }
  }
  const pillEl=document.getElementById('ventas-weekday-pills');
  if(pillEl){
    pillEl.innerHTML=weekdayData.map(d=>`<span class="sales-weekday-pill"><strong>${d.name}</strong>${fmt.money(d.total)} · ${fmt.num(d.share||0,1)}%</span>`).join('');
  }
  const bestIdx=bestDay? weekdayOrder.indexOf(bestDay.dow):-1;
  drawBars('chart-ventas-weekday', weekdayData.map(d=>d.name), weekdayData.map(d=>d.total), '#38BDF8', {axisMode:'money', highlightIdx:bestIdx>=0?bestIdx:null, avgColor:'#22d3ee'});
  // Tendencia semanal
  const weekMap=new Map();
  const weekStart=(iso)=>{
    const d=new Date(iso+'T00:00:00');
    const diff=(d.getDay()+6)%7;
    d.setDate(d.getDate()-diff);
    return d.toISOString().slice(0,10);
  };
  rows.forEach(r=>{
    const iso=businessDateISO(r.fechaHora);
    const start=weekStart(iso);
    weekMap.set(start,(weekMap.get(start)||0)+Number(r.total||0));
  });
  const weekEntries=[...weekMap.entries()].sort((a,b)=> new Date(a[0])-new Date(b[0]));
  const weekLabels=weekEntries.map(([start])=>{
    const end=new Date(start+'T00:00:00'); end.setDate(end.getDate()+6);
    return `${fmt.dateOnly(start)} → ${fmt.dateOnly(end.toISOString().slice(0,10))}`;
  });
  const weekValues=weekEntries.map(([,val])=>val);
  drawLineTrend('chart-ventas-weektrend', weekLabels, weekValues, '#A855F7', {axisMode:'money'});
  const trendMeta=document.getElementById('ventas-weektrend-meta');
  if(trendMeta){
    if(weekValues.length>1){
      const lastIdx=weekValues.length-1;
      const last=weekValues[lastIdx]||0;
      const prev=weekValues[lastIdx-1]||0;
      const diff=last-prev;
      const pct=prev? diff/prev*100: (last?100:0);
      const direction=diff>0? 'alza' : (diff<0? 'baja':'estable');
      const peakIdx=weekValues.reduce((best,v,i,arr)=> v>arr[best]?i:best,0);
      const lowIdx=weekValues.reduce((best,v,i,arr)=> v<arr[best]?i:best,0);
      trendMeta.textContent=`${weekValues.length} semanas · Tendencia ${direction}: ${diff>0?'+':''}${fmt.money(diff)} (${fmt.num(pct||0,1)}%) · Pico: ${weekLabels[peakIdx]} (${fmt.money(weekValues[peakIdx])}) · Más baja: ${weekLabels[lowIdx]} (${fmt.money(weekValues[lowIdx])})`;
    } else if(weekValues.length===1){
      trendMeta.textContent=`Semana analizada: ${fmt.money(weekValues[0])}`;
    } else {
      trendMeta.textContent='Sin semanas registradas en el rango';
    }
  }
  ventasRapidas.init?.();
}

function renderRecetas(){
  renderABCConfig();
  renderBreakevenCard();
  const tb=document.querySelector('#tbl-recetas tbody'); const rows=Data.get(Data.col.recetas);
  const q=(document.getElementById('rc-buscar')?.value||'').toLowerCase().trim();
  const list = q? rows.filter(r=> (r.nombre||'').toLowerCase().includes(q)) : rows;
  tb.innerHTML=list.map(r=>{
    const mp=r.mpPorcion ?? 0;
    const abcp=r.abcPorcion ?? 0;
    const costo=r.costoPorcion ?? ((r.precioSugerido||0)>0? (r.precioSugerido*(1-(Number(r.margenObj||0)/100))) : 0);
    const precio=r.precioSugerido ?? 0;
    return `<tr><td>${r.nombre}</td><td>${r.porciones||1}</td><td>${fmt.money(mp)}</td><td>${fmt.money(abcp)}</td><td>${fmt.money(costo)}</td><td>${fmt.money(precio)}</td><td><button class='btn' onclick="recetas.editar('${r.id}')">Editar</button> <button class='btn' onclick="recetas.duplicar('${r.id}')">Duplicar</button> <button class='btn' onclick="recetas.sharePDF('${r.id}')">PDF</button> <button class='btn' onclick="recetas.shareExcel('${r.id}')">Excel</button> <button class='btn danger' onclick="recetas.eliminar('${r.id}')">Eliminar</button></td></tr>`;
  }).join('');
}

function renderCostosInsumos(){
  const tb=document.querySelector('#tbl-costos tbody'); if(!tb) return; const rows=Data.get(Data.col.insumos_costeo);
  tb.innerHTML= rows.map(i=>`<tr><td>${i.nombre}</td><td>${LocalDB.byId(Data.col.proveedores,i.proveedorId)?.nombre||''}</td><td>${i.unidad||''}</td><td>${fmt.money(i.costoUnit||0)}</td><td><button class='btn' onclick="costosInsumos.editar('${i.id}')">Editar</button> <button class='btn' onclick="costosInsumos.duplicar('${i.id}')">Duplicar</button> <button class='btn danger' onclick="costosInsumos.eliminar('${i.id}')">Eliminar</button></td></tr>`).join('');
}

function renderInventario(){
  const tb=document.querySelector('#tbl-insumos tbody'); const rows=Data.get(Data.col.insumos);
  tb.innerHTML=rows.map(i=>`<tr><td>${i.nombre}</td><td>${i.unidad}</td><td>${fmt.num(i.existencia)}</td><td>${fmt.money(i.costoPromedio)}</td><td>${i.min||0}</td><td>${i.max||0}</td><td><button class='btn' onclick="inventario.ajuste('${i.id}')">Ajuste</button> <button class='btn' onclick="inventario.editar('${i.id}')">Editar</button> <button class='btn' onclick="inventario.duplicar('${i.id}')">Duplicar</button> <button class='btn danger' onclick="inventario.eliminar('${i.id}')">Eliminar</button></td></tr>`).join('');
  // filtro kardex
  const sel=document.getElementById('kdx-insumo'); sel.innerHTML='<option value="">(Todos)</option>'+rows.map(i=>`<option value='${i.id}'>${i.nombre}</option>`).join('');
  inventario.renderKardex();
}

inventario.ajuste=function(id){ const ins=LocalDB.byId(Data.col.insumos,id); const cant=Number(prompt('Cantidad (+/-):',0)||0); if(!cant) return; const nueva=(ins.existencia||0)+cant; LocalDB.update(Data.col.insumos, id, {existencia:nueva}); Data.add(Data.col.kardex,{fechaHora:new Date().toISOString(),insumoId:id,tipo:cant>=0?'entrada':'ajuste',cantidad:Math.abs(cant),costoUnit:ins.costoPromedio,ref:'AJ',notas:'Ajuste'}); renderInventario(); }
inventario.editar=function(id){ const ins=LocalDB.byId(Data.col.insumos,id); if(!ins) return; const nombre=prompt('Nombre', ins.nombre)||ins.nombre; const unidad=prompt('Unidad', ins.unidad||'g')||ins.unidad; const costo=Number(prompt('Costo promedio', ins.costoPromedio||0)||ins.costoPromedio||0); const ex=Number(prompt('Existencia', ins.existencia||0)||ins.existencia||0); const min=Number(prompt('Mínimo', ins.min||0)||ins.min||0); const max=Number(prompt('Máximo', ins.max||0)||ins.max||0); LocalDB.update(Data.col.insumos,id,{nombre:nombre,unidad:unidad,costoPromedio:costo,existencia:ex,min,max}); renderInventario(); }
inventario.duplicar=function(id){ const ins=LocalDB.byId(Data.col.insumos,id); if(!ins) return; const nombre=prompt('Nombre del duplicado', ins.nombre+' (copy)'); if(!nombre) return; Data.add(Data.col.insumos,{...ins,id:undefined,nombre}); notify('Insumo duplicado','success'); renderInventario(); }
inventario.eliminar=function(id){ if(!confirm('¿Eliminar insumo?')) return; Data.del(Data.col.insumos,id); notify('Insumo eliminado','success'); renderInventario(); }

function renderCompras(){
  const rows=Data.get(Data.col.compras).sort((a,b)=> new Date(b.fechaHora)-new Date(a.fechaHora));
  const tb=document.querySelector('#tbl-compras tbody');
  if(tb){ tb.innerHTML=rows.map(r=>`<tr><td>${fmt.date(r.fechaHora)}</td><td>${LocalDB.byId(Data.col.proveedores,r.proveedorId)?.nombre||''}</td><td>${r.folio||''}</td><td>${r.metodoPago||''}</td><td>${fmt.money(r.total)}</td><td><button class='btn' onclick="compras.editar('${r.id}')">Editar</button> <button class='btn' onclick="compras.duplicar('${r.id}')">Duplicar</button> <button class='btn danger' onclick="compras.eliminar('${r.id}')">Eliminar</button></td></tr>`).join(''); }
  const tbR=document.querySelector('#tbl-compras-recetas tbody');
  if(tbR){ tbR.innerHTML=rows.map(r=>`<tr><td>${fmt.date(r.fechaHora)}</td><td>${LocalDB.byId(Data.col.proveedores,r.proveedorId)?.nombre||''}</td><td>${r.folio||''}</td><td>${r.metodoPago||''}</td><td>${fmt.money(r.total)}</td><td><button class='btn' onclick="compras.editar('${r.id}')">Editar</button> <button class='btn' onclick="compras.duplicar('${r.id}')">Duplicar</button> <button class='btn danger' onclick="compras.eliminar('${r.id}')">Eliminar</button></td></tr>`).join(''); }
}

function renderGastos(){
  const table=document.querySelector('#tbl-gastos'); const tb=table.querySelector('tbody');
  // defaults al rango del dashboard si vacíos
  const gDesdeEl=document.getElementById('g-desde'); const gHastaEl=document.getElementById('g-hasta');
  if(gDesdeEl && !gDesdeEl.value) gDesdeEl.value=document.getElementById('dash-desde')?.value||'';
  if(gHastaEl && !gHastaEl.value) gHastaEl.value=document.getElementById('dash-hasta')?.value||'';
  const desde=document.getElementById('g-desde')?.value||''; const hasta=document.getElementById('g-hasta')?.value||'';
  setQuickPresetActive('gastos-quick', matchPresetForRange(desde, hasta));
  const met=document.getElementById('g-met')?.value||''; const tipoSel=document.getElementById('g-tipo')?.value||'';
  const provSel=document.getElementById('g-prov')?.value||''; const sourceSel=document.getElementById('g-source')?.value||'';
  const incComp=document.getElementById('g-inc-comp')?.checked!==false; const incAj=document.getElementById('g-inc-aj')?.checked!==false;
  const query=(document.getElementById('g-buscar')?.value||'').toLowerCase().trim();
  const providerOptions=new Map();
  const addProviderOption=(key,label)=>{
    if(!key || !label) return;
    if(!providerOptions.has(key)) providerOptions.set(key,label);
  };
  Data.get(Data.col.proveedores).forEach(p=>{
    if(p?.id) addProviderOption(`prov:${p.id}`, p.nombre||'Proveedor sin nombre');
  });
  const out=[];
  // Gastos
  Data.get(Data.col.gastos).forEach(g=>{
    if(!inRange(g.fecha,desde,hasta)) return; const m=String(g.metodoPago||'');
    if(met && m!==met) return; if(tipoSel && g.tipo!==tipoSel) return;
    const provId=g.proveedorId? String(g.proveedorId):'';
    const provInfo=provId? LocalDB.byId(Data.col.proveedores,g.proveedorId):null;
    const pagadoPor=(g.pagadoPor||'').trim();
    const provKey=provId? `prov:${provId}` : (pagadoPor? `pay:${pagadoPor}`:'');
    const provLabel=provId? (provInfo?.nombre||'Proveedor sin nombre') : (pagadoPor? `Pagado por ${pagadoPor}`:'Pagos internos');
    if(provKey) addProviderOption(provKey, provLabel);
    if(provSel && provSel!==provKey) return;
    const source='Gasto';
    if(sourceSel && sourceSel!==source) return;
    out.push({
      fecha:g.fecha,
      tipo:g.tipo,
      descripcion:g.descripcion||'',
      proveedor: provInfo?.nombre || pagadoPor || '',
      proveedorId: provId||null,
      proveedorKey: provKey,
      metodo:m,
      importe:Number(g.importe||0),
      folio:g.folio||'',
      source,
      gId:g.id
    });
  });
  // Compras
  if(incComp){
    Data.get(Data.col.compras).forEach(c=>{
      const fecha=(c.fechaHora||'').slice(0,10);
      if(!inRange(fecha,desde,hasta)) return;
      const m=String(c.metodoPago||'');
      if(met && m!==met) return;
      if(tipoSel && tipoSel!=='Compra') return;
      const provId=c.proveedorId? String(c.proveedorId):'';
      const prov=provId? LocalDB.byId(Data.col.proveedores,c.proveedorId)?.nombre||'':'';
      const provKey=provId? `prov:${provId}`:'';
      if(provKey) addProviderOption(provKey, prov||'Proveedor sin nombre');
      if(provSel && provSel!==provKey) return;
      const source='Compra';
      if(sourceSel && sourceSel!==source) return;
      out.push({
        fecha,
        tipo:'Compra',
        descripcion:`Compra insumos${prov?' · '+prov:''}`,
        proveedor:prov,
        proveedorId:provId||null,
        proveedorKey:provKey,
        metodo:m,
        importe:Number(c.total||0),
        folio:c.folio||'',
        source,
        compId:c.id
      });
    });
  }
  // Ajustes
  if(incAj){
    Data.get(Data.col.ajustes).forEach(a=>{
      if(!inRange(a.fecha,desde,hasta)) return;
      const imp=Number(a.salida||0); if(!(imp>0)) return;
      const m=(a.cuenta==='Efectivo')? 'Efectivo' : 'Tarjeta';
      if(met && m!==met) return;
      if(tipoSel && tipoSel!=='Ajuste') return;
      const source='Ajuste';
      if(sourceSel && sourceSel!==source) return;
      out.push({
        fecha:a.fecha,
        tipo:'Ajuste',
        descripcion:a.concepto||a.ref||'Ajuste',
        proveedor:'Ajuste interno',
        proveedorId:null,
        proveedorKey:'',
        metodo:m,
        importe:imp,
        folio:a.ref||'',
        source,
        ajId:a.id
      });
    });
  }
  const provSelect=document.getElementById('g-prov');
  if(provSelect){
    const current=provSelect.value;
    const entries=[...providerOptions.entries()].sort((a,b)=> a[1].localeCompare(b[1],'es',{sensitivity:'base'}));
    provSelect.innerHTML='<option value="">(Todos)</option>'+entries.map(([value,label])=>`<option value='${value}'>${label}</option>`).join('');
    if(current && providerOptions.has(current)) provSelect.value=current;
  }
  out.sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
  const rows = query
    ? out.filter(r=>{
        return [r.fecha, r.tipo, r.descripcion, r.proveedor, r.metodo, r.folio, r.source]
          .some(field=> String(field||'').toLowerCase().includes(query));
      })
    : out;
  tb.innerHTML= rows.map(r=>{
    const acc = r.source==='Gasto'
      ? `<button class='btn' data-action='edit' data-id='${r.gId||''}'>Editar</button> <button class='btn' data-action='dup' data-id='${r.gId||''}'>Duplicar</button> <button class='btn danger' data-action='del' data-id='${r.gId||''}'>Eliminar</button>`
      : (r.source==='Compra'
        ? `<button class='btn' onclick=\"compras.editar('${r.compId}')\">Editar</button> <button class='btn' onclick=\"compras.duplicar('${r.compId}')\">Duplicar</button> <button class='btn danger' onclick=\"compras.eliminar('${r.compId}')\">Eliminar</button>`
        : `<button class='btn danger' onclick=\"gastos.eliminarAjuste('${r.ajId}')\">Eliminar</button>`);
    const provCell = r.proveedor||'';
    return `<tr><td>${fmt.dateOnly(r.fecha)}</td><td>${r.tipo}</td><td>${r.descripcion}</td><td>${provCell}</td><td>${r.metodo}</td><td>${fmt.money(r.importe)}</td><td>${r.folio}</td><td><span class='badge'>${r.source}</span></td><td>${acc}</td></tr>`;
  }).join('');
  const gastosAnalytics=computeGastosAnalytics(rows);
  const mixChip=document.getElementById('gastos-mix-chip');
  if(mixChip){
    if(gastosAnalytics.total>0){
      const catSummary=Array.from(gastosAnalytics.catMap.entries()).sort((a,b)=>b[1]-a[1]);
      const topSummary=catSummary.slice(0,3).map(([cat,val])=>{
        const pct=gastosAnalytics.total? (val/gastosAnalytics.total*100):0;
        return `${cat} ${fmt.num(pct,1)}%`;
      });
      mixChip.textContent = topSummary.length? topSummary.join(' · ') : 'Sin movimientos en el periodo';
    }else{
      mixChip.textContent='Sin movimientos en el periodo';
    }
  }
  if(!renderGastos._bound){
    table.addEventListener('click', (e)=>{
      const btn=e.target.closest('button'); if(!btn) return; const a=btn.dataset.action; if(!a) return; const id=btn.dataset.id; if(!id) return; if(a==='edit') gastos.editar(id); else if(a==='dup') gastos.duplicar(id); else if(a==='del') gastos.eliminar(id);
    });
    renderGastos._bound=true;
  }
  renderGastosKPI(rows, gastosAnalytics);
}

function computeGastosAnalytics(rows){
  rows = rows || [];
  const tot = rows.reduce((s,r)=> s+Number(r.importe||0),0);
  const rawCat={};
  rows.forEach(r=>{
    const tipo=(r.tipo && String(r.tipo).trim()) || 'Sin categoría';
    rawCat[tipo]=(rawCat[tipo]||0)+Number(r.importe||0);
  });
  const sortedCats=Object.entries(rawCat).sort((a,b)=>b[1]-a[1]);
  const catAgg=new Map();
  sortedCats.forEach(([cat,val])=>{
    const normalizedCat = cat === '' ? 'Sin categoría' : cat;
    catAgg.set(normalizedCat, val);
  });
  if(!catAgg.size && tot>0){
    catAgg.set('Sin categoría', tot);
  }
  const porMet={};
  rows.forEach(r=>{
    const m=r.metodo||'N/D';
    porMet[m]=(porMet[m]||0)+Number(r.importe||0);
  });
  const porProvId={};
  let internosTotal=0;
  rows.forEach(r=>{
    const amount=Number(r.importe||0);
    if(r.proveedorId){
      porProvId[r.proveedorId]=(porProvId[r.proveedorId]||0)+amount;
    } else if(r.source!=='Ajuste'){
      internosTotal+=amount;
    }
  });
  const porDia={};
  rows.forEach(r=>{
    const d=r.fecha;
    porDia[d]=(porDia[d]||0)+Number(r.importe||0);
  });
  return {
    total:tot,
    rawCategorias:rawCat,
    catMap:catAgg,
    catTotals:Object.fromEntries(catAgg),
    metodos:porMet,
    proveedores:porProvId,
    internosTotal,
    dias:porDia
  };
}

function renderGastosKPI(rows, analytics){
  try{
    const kEl=document.getElementById('g-kpis'); if(!kEl) return;
    analytics = analytics || computeGastosAnalytics(rows||[]);
    const {total:tot, catTotals:porCat, catMap, metodos:porMet, proveedores:porProvId, internosTotal, dias:porDia} = analytics;
    // KPIs
    const nom=porCat['Nómina']||0;
    const ins=porCat['Insumos']||0;
    const productos=porCat['Productos']||0;
    const imp=porCat['Impuestos']||0;
    const seg=porCat['Seguridad']||0;
    const trans=porCat['Transporte']||0;
    const operativos=Math.max(0, tot - ins - productos);
    const otros=catMap.get('Otros')||0;
    const dias=Object.keys(porDia).length||1; const prom=tot/dias;
    kEl.innerHTML=`
      <div class='card kpi'><div><small>Total gasto</small><div class='big'>${fmt.money(tot)}</div></div></div>
      <div class='card kpi'><div><small>Nómina</small><div class='big'>${fmt.money(nom)}</div></div></div>
      <div class='card kpi'><div><small>Insumos</small><div class='big'>${fmt.money(ins)}</div></div></div>
      <div class='card kpi'><div><small>Productos</small><div class='big'>${fmt.money(productos)}</div></div></div>
      <div class='card kpi'><div><small>Operativo (sin ins./prod.)</small><div class='big'>${fmt.money(operativos)}</div></div></div>
      <div class='card kpi'><div><small>Seguridad</small><div class='big'>${fmt.money(seg)}</div></div></div>
      <div class='card kpi'><div><small>Transporte</small><div class='big'>${fmt.money(trans)}</div></div></div>
      <div class='card kpi'><div><small>Impuestos</small><div class='big'>${fmt.money(imp)}</div></div></div>
      <div class='card kpi'><div><small>Otros</small><div class='big'>${fmt.money(otros)}</div></div></div>
      <div class='card kpi'><div><small>Promedio diario</small><div class='big'>${fmt.money(prom)}</div></div></div>
      <div class='card kpi'><div><small>Part. Nómina</small><div class='big'>${tot?fmt.num(nom/tot*100):0}%</div></div></div>`;
    // Categorías (donut)
    const catEntries=Array.from(catMap.entries());
    const catLabs=catEntries.map(([cat])=>cat);
    const catVals=catEntries.map(([,val])=>val);
    const catCols=catEntries.map(([cat])=>EXPENSE_COLORS[cat]||'#999');
    drawDonut('chart-gastos-cat', catLabs, catVals, catCols, {centerLabel:'Total', centerValue:fmt.money(tot)});
    // Método (bars)
    const metLabs=Object.keys(porMet); const metVals=metLabs.map(k=>porMet[k]); const mCols=metLabs.map(k=> METHOD_COLORS[k]||'#999');
    drawBars('chart-gastos-met', metLabs, metVals, '#FFD74B');
    // Diario (bars)
    const dayLabs=Object.keys(porDia).sort(); const dayVals=dayLabs.map(k=>porDia[k]);
    drawBars('chart-gastos-diario', dayLabs, dayVals, '#9CA3AF');
    // Top proveedores (bars)
    const proveedorEntries=Object.entries(porProvId).map(([id,val])=>{
      const prov=LocalDB.byId(Data.col.proveedores,id);
      return [prov?.nombre||'Proveedor sin nombre', val];
    }).sort((a,b)=>b[1]-a[1]);
    if(internosTotal>0) proveedorEntries.push(['Pagos internos', internosTotal]);
    const provPairs=proveedorEntries.slice(0,12);
    drawBars('chart-gastos-prov', provPairs.map(p=>p[0]), provPairs.map(p=>p[1]), '#3B82F6');
  }catch(e){ console.error(e); }
}

const sobresManager={
  col:'sobres',
  _bound:false,
  _initialized:false,
  _rangeBound:false,
  _weekBound:false,
  load(){ return LocalDB.get(this.col)||[]; },
  save(arr){ LocalDB.set(this.col, arr); },
  generar(){
    const desdeEl=document.getElementById('sobres-desde');
    const hastaEl=document.getElementById('sobres-hasta');
    if(!desdeEl || !hastaEl) return;
    let desde=desdeEl.value||todayISO();
    let hasta=hastaEl.value||desde;
    if(desde>hasta){ const tmp=desde; desde=hasta; hasta=tmp; desdeEl.value=desde; hastaEl.value=hasta; }
    this.ensureRange(desde, hasta);
    this.render();
  },
  ensureRange(desde, hasta){
    if(!desde || !hasta) return;
    const arr=this.load();
    const map=new Map(arr.map(item=>[item.fecha, item]));
    let cursor=new Date(`${desde}T00:00:00`);
    const end=new Date(`${hasta}T00:00:00`);
    while(cursor<=end){
      const iso=localDateISO(cursor);
      if(!map.has(iso)){
        const entry={id:uid(), fecha:iso, monto:0, retirado:false, updatedAt:new Date().toISOString()};
        arr.push(entry);
        map.set(iso, entry);
      }
      cursor.setDate(cursor.getDate()+1);
    }
    arr.sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));
    this.save(arr);
  },
  setPreset(preset){
    const desdeEl=document.getElementById('sobres-desde');
    const hastaEl=document.getElementById('sobres-hasta');
    if(!desdeEl || !hastaEl) return;
    let range=null;
    if(preset==='prox7'){
      const hoy=todayISO();
      range={desde:hoy, hasta:addDaysISO(hoy,6)};
    } else {
      range=computeRangePreset(preset);
    }
    if(!range) return;
    desdeEl.value=range.desde;
    hastaEl.value=range.hasta;
    setQuickPresetActive('sobres-quick', preset==='prox7'? 'prox7':preset);
    const weekEl=document.getElementById('sobres-week'); if(weekEl) weekEl.value='';
    this.generar();
  },
  applyWeek(){
    const weekEl=document.getElementById('sobres-week');
    if(!weekEl || !weekEl.value) return;
    const range=weekRangeFromISOWeek(weekEl.value);
    if(!range) return;
    const desdeEl=document.getElementById('sobres-desde');
    const hastaEl=document.getElementById('sobres-hasta');
    if(desdeEl) desdeEl.value=range.desde;
    if(hastaEl) hastaEl.value=range.hasta;
    setQuickPresetActive('sobres-quick','');
    this.generar();
  },
  setWeekPreset(preset){
    const weekEl=document.getElementById('sobres-week'); if(!weekEl) return;
    let iso=currentISOWeek();
    if(preset==='prev'){
      const base=new Date();
      base.setDate(base.getDate()-7);
      iso=isoWeekFromDate(base);
    }
    weekEl.value=iso;
    this.applyWeek();
  },
  updateAmount(id, value){
    const arr=this.load();
    const idx=arr.findIndex(r=> r.id===id);
    if(idx<0) return;
    const monto=Number(value||0);
    arr[idx]={...arr[idx], monto, updatedAt:new Date().toISOString()};
    this.save(arr);
    this.render();
  },
  toggleRetiro(id, checked){
    const arr=this.load();
    const idx=arr.findIndex(r=> r.id===id);
    if(idx<0) return;
    arr[idx]={...arr[idx], retirado:checked, updatedAt:new Date().toISOString()};
    this.save(arr);
    this.render();
  },
  render(){
    const table=document.getElementById('tbl-sobres');
    if(!table) return;
    const tbody=table.querySelector('tbody');
    const desde=document.getElementById('sobres-desde')?.value||'';
    const hasta=document.getElementById('sobres-hasta')?.value||'';
    const all=this.load().slice().sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));
    const rows=all.filter(row=>{
      if(desde && row.fecha<desde) return false;
      if(hasta && row.fecha>hasta) return false;
      return true;
    });
    const preset=this.detectPreset(desde, hasta);
    setQuickPresetActive('sobres-quick', preset);
    if(!rows.length){
      tbody.innerHTML=`<tr><td colspan="4" class="muted">Define un rango y genera la lista de sobres.</td></tr>`;
    } else {
      tbody.innerHTML=rows.map(r=>{
        const monto=r.monto!=null? Number(r.monto):'';
        const updated=r.updatedAt? fmt.date(r.updatedAt):'—';
        return `<tr data-id='${r.id}'>
          <td>${fmt.dateOnly(r.fecha)}</td>
          <td><input type='number' step='0.01' min='0' value='${monto!==''? monto:''}' placeholder='0.00'></td>
          <td class='checkbox-cell'><input type='checkbox' ${r.retirado?'checked':''}></td>
          <td class='actions-cell'>${updated}</td>
        </tr>`;
      }).join('');
    }
    this.updateSummary(rows);
    this.renderDashboard(rows);
    this.bindEvents();
  },
  updateSummary(rows){
    const pending=rows.reduce((sum,row)=> row.retirado? sum : sum+Number(row.monto||0), 0);
    const pendingEl=document.getElementById('sobres-pendiente');
    if(pendingEl) pendingEl.textContent=fmt.money(pending);
  },
  renderDashboard(rows){
    const kpiEl=document.getElementById('sobres-kpis');
    if(kpiEl){
      if(!rows.length){
        kpiEl.innerHTML=`<div class="muted">Selecciona una semana o rango para ver estadísticas.</div>`;
      } else {
        const totalPlan=rows.reduce((sum,r)=> sum+Number(r.monto||0),0);
        const totalRet=rows.reduce((sum,r)=> sum + (r.retirado? Number(r.monto||0):0),0);
        const totalPend=Math.max(0,totalPlan-totalRet);
        const count=rows.length;
        const retirados=rows.filter(r=> r.retirado).length;
        const pendientes=count-retirados;
        const prom=count? totalPlan/count : 0;
        const maxDia=rows.reduce((max,r)=> Math.max(max, Number(r.monto||0)),0);
        const completado=totalPlan>0? (totalRet/totalPlan*100):0;
        kpiEl.innerHTML=`
          <div class='card kpi'><div><small>Total planificado</small><div class='big'>${fmt.money(totalPlan)}</div></div></div>
          <div class='card kpi'><div><small>Retirado</small><div class='big'>${fmt.money(totalRet)}</div><div class='muted'>${retirados} de ${count} sobres</div></div></div>
          <div class='card kpi'><div><small>Pendiente</small><div class='big'>${fmt.money(totalPend)}</div><div class='muted'>${pendientes} sobres sin retirar</div></div></div>
          <div class='card kpi'><div><small>% completado</small><div class='big'>${fmt.num(completado,1)}%</div><div class='muted'>Promedio diario ${fmt.money(prom)}</div></div></div>
          <div class='card kpi'><div><small>Promedio por sobre</small><div class='big'>${fmt.money(prom)}</div><div class='muted'>Máximo diario ${fmt.money(maxDia)}</div></div></div>
        `;
      }
    }
    const labels=rows.map(r=> r.fecha);
    const dataPend=rows.map(r=> r.retirado? 0 : Number(r.monto||0));
    const dataRet=rows.map(r=> r.retirado? Number(r.monto||0) : 0);
    drawBarsStacked('chart-sobres-plan', labels, [
      {label:'Retirado', color:'#10B981', data:dataRet},
      {label:'Pendiente', color:'#F97316', data:dataPend}
    ]);
    const cumulative=[];
    let running=0;
    rows.forEach(r=>{
      if(!r.retirado){
        running+=Number(r.monto||0);
      }
      cumulative.push(running);
    });
    drawBars('chart-sobres-pend', labels, cumulative, '#F97316', {axisMode:'money'});
  },
  detectPreset(desde, hasta){
    if(!desde || !hasta) return '';
    const match=matchPresetForRange(desde, hasta);
    if(match) return match;
    const hoy=todayISO();
    if(desde===hoy && hasta===addDaysISO(hoy,6)) return 'prox7';
    return '';
  },
  bindEvents(){
    if(this._bound){
      return;
    }
    const table=document.getElementById('tbl-sobres');
    if(!table) return;
    table.addEventListener('change', (e)=>{
      const tr=e.target.closest?.('tr[data-id]');
      if(!tr) return;
      if(e.target.matches("input[type='checkbox']")){
        this.toggleRetiro(tr.dataset.id, e.target.checked);
      } else if(e.target.matches("input[type='number']")){
        this.updateAmount(tr.dataset.id, e.target.value);
      }
    });
    this._bound=true;
  },
  init(){
    const desdeEl=document.getElementById('sobres-desde');
    const hastaEl=document.getElementById('sobres-hasta');
    if(!desdeEl || !hastaEl) return;
    if(!this._initialized){
      const range=computeRangePreset('mes') || {desde:todayISO(), hasta:todayISO()};
      desdeEl.value=range.desde;
      hastaEl.value=range.hasta;
      this.ensureRange(range.desde, range.hasta);
      this._initialized=true;
    }
    if(!this._rangeBound){
      desdeEl.addEventListener('change', ()=> this.render());
      hastaEl.addEventListener('change', ()=> this.render());
      this._rangeBound=true;
    }
    if(!this._weekBound){
      const weekEl=document.getElementById('sobres-week');
      if(weekEl){
        weekEl.addEventListener('change', ()=> this.applyWeek());
      }
      this._weekBound=true;
    }
    this.render();
  }
};

function renderCortes(){
  const tb=document.querySelector('#tbl-cortes tbody'); const rows=Data.get(Data.col.cortes).sort((a,b)=> new Date(b.fecha)-new Date(a.fecha));
  tb.innerHTML=rows.map(c=>`<tr><td>${fmt.dateOnly(c.fecha)}</td><td>${c.turno||''}</td><td>${fmt.money(c.efectivo)}</td><td>${fmt.money(c.tarjeta)}</td><td>${fmt.money(c.vales)}</td><td>${fmt.money(c.propinas)}</td><td>${fmt.money(c.cancelaciones)}</td><td>${fmt.money(c.devoluciones)}</td><td>${fmt.money(c.diferencia)}</td></tr>`).join('');
}

function renderAgenda(){
  const tb=document.querySelector('#tbl-agenda tbody'); const rows=(LocalDB.get('agenda_items')||[]).sort((a,b)=> new Date(a.fecha)-new Date(b.fecha));
  tb.innerHTML=rows.map(e=>{const hoy=new Date().toISOString().slice(0,10); const estado= e.fecha<hoy? 'Vencido': (e.fecha===hoy? 'Hoy':'Próximo'); return `<tr><td>${fmt.dateOnly(e.fecha)}</td><td>${e.titulo}</td><td><span class='badge'>${estado}</span></td><td>${e.notas||''}</td></tr>`}).join('');
}

function renderCatalogos(){ /* handled per modal */ }
function renderConfig(){
  document.getElementById('cfg-modo').value=cfg.modo; document.getElementById('cfg-iva').value=cfg.iva; document.getElementById('cfg-margen').value=cfg.margen; document.getElementById('cfg-dec').value=cfg.decimales; document.getElementById('cfg-alert').value=cfg.alertas; document.getElementById('cfg-saldo-efec').value=cfg.saldoIniEfectivo||0; document.getElementById('cfg-saldo-banco').value=cfg.saldoIniBanco||0;
}

function mockApiTest(){ notify('API mock: OK'); }

function renderAll(){ renderDashboard(); renderVentas(); renderRecetas(); renderCostosInsumos(); renderInventario(); renderCompras(); renderGastos(); sobresManager.init(); renderCortes(); renderAgenda(); renderCatalogos(); renderConfig(); nominaGen.init?.(); renderNominas(); }

// Filtro de recetas en vivo
document.addEventListener('input', (e)=>{ if(e.target && e.target.id==='rc-buscar'){ renderRecetas(); } });
// Selector de alcance de depósitos
document.addEventListener('change', (e)=>{ if(e.target && e.target.id==='dep-scope'){ renderDeposCalendar(); } });
document.addEventListener('change', (e)=>{ if(e.target && e.target.id==='dash-origen'){ renderDashboard(); } });
document.getElementById('dash-trends-block')?.addEventListener('toggle', (e)=>{ if(e.target.open){ setTimeout(()=> renderChartsDashboard(window._dashboardInsights), 80); } });
document.getElementById('dash-ledger-block')?.addEventListener('toggle', (e)=>{ if(e.target.open){ setTimeout(()=> renderLedgers(), 80); } });
document.addEventListener('click', (e)=>{
  const canvas=e.target instanceof HTMLCanvasElement? e.target : e.target.closest?.('canvas');
  if(canvas && !canvas.closest('.modal-content') && canvas._snapshot){ openChartModal(canvas); }
});
document.getElementById('chart-modal')?.addEventListener('click', (e)=>{ if(e.target.id==='chart-modal'){ closeChartModal(); } });
document.addEventListener('keyup', (e)=>{ if(e.key==='Escape'){ closeChartModal(); } });

/*******************
 * BMC: Nav / Init  *
 *******************/
const TABS=[
  {id:'dashboard', label:'Dashboard'},
  {id:'ventas', label:'Ventas'},
  {id:'gastos', label:'Gastos / Compras'},
  {id:'nomina', label:'Nómina'},
  {id:'recetas', label:'Recetas / Costeo'},
  {id:'inventario', label:'Inventario'},
  {id:'sobres', label:'Sobres'},
  {id:'cortes', label:'Cortes de caja'},
  {id:'agenda', label:'Agenda'},
  {id:'catalogos', label:'Catálogos'},
  {id:'config', label:'Config'},
];
function initNav(){
  const nav=document.getElementById('top-nav');
  nav.innerHTML=TABS.map(t=>`<button data-tab='${t.id}' onclick="showTab('${t.id}')">${t.label}</button>`).join('');
  showTab('dashboard');
}
function showTab(id){
  document.querySelectorAll('nav button').forEach(b=> b.classList.toggle('active', b.dataset.tab===id));
  document.querySelectorAll('section.panel').forEach(s=> s.classList.add('hidden'));
  document.getElementById('panel-'+id).classList.remove('hidden');
  // Re-render vistas con gráficas al hacerlas visibles para que ajusten ancho/hover
  const renderers={
    dashboard: ()=> renderDashboard(),
    ventas: ()=> renderVentas(),
    gastos: ()=>{ renderGastos?.(); renderCompras?.(); },
    nomina: ()=>{ renderNominas?.(); renderNominaCharts?.(); },
    recetas: ()=> renderRecetas?.(),
    inventario: ()=> renderInventario?.(),
    cortes: ()=> renderCortes?.(),
    agenda: ()=> renderAgenda?.(),
    catalogos: ()=> renderCatalogos?.(),
    config: ()=> renderConfig?.()
  };
  const fn=renderers[id];
  if(typeof fn==='function'){ requestAnimationFrame(fn); }
}

let appBooted=false;
function loadCfg(){
  const saved=JSON.parse(localStorage.getItem(LocalDB.key('cfg'))||'null');
  if(saved){ cfg={...cfg, ...saved}; }
  else { localStorage.setItem(LocalDB.key('cfg'), JSON.stringify(cfg)); }
  const badge=document.getElementById('mode-badge');
  if(badge) badge.textContent='Modo: '+cfg.modo;
}
function runMigrations(){
  // Limpieza puntual: eliminar gasto legado 'TOÑO' si existe (una sola vez)
  try{
    const doneKey=LocalDB.key('cleanup_tono_v1');
    if(!localStorage.getItem(doneKey)){
      const arr=Data.get(Data.col.gastos)||[];
      const before=arr.length;
      const arr2=arr.filter(g=> !(
        String((g.descripcion||'')).toUpperCase()==='TOÑO' &&
        String(g.tipo||'')==='Nómina' &&
        String(g.metodoPago||'')==='Efectivo' &&
        Number(g.importe||0)===1000
      ));
      if(arr2.length!==before){ LocalDB.set(Data.col.gastos, arr2); }
      localStorage.setItem(doneKey,'1');
    }
  }catch(e){}
  // Reinicio y normalización de folios de nómina (una sola vez)
  try{
    const doneKey2=LocalDB.key('nomina_reset_v1');
    if(!localStorage.getItem(doneKey2)){
      const ns=Data.get(Data.col.nominas)||[];
      if(ns.length){
        // ordenar por createdAt o semana
        ns.sort((a,b)=> new Date(a.createdAt||a.semanaMon||a.pagoFecha)-new Date(b.createdAt||b.semanaMon||b.pagoFecha));
        ns.forEach((r,i)=>{ const newF=String(i+1); if(r.folio!==newF){ Data.upd(Data.col.nominas,r.id,{folio:newF}); if(r.gastoId && LocalDB.byId(Data.col.gastos,r.gastoId)) Data.upd(Data.col.gastos,r.gastoId,{folio:newF}); }});
        // actualizar secuencia al último folio asignado
        localStorage.setItem(LocalDB.key('nomina_seq'), String(ns.length));
      } else {
        localStorage.setItem(LocalDB.key('nomina_seq'), '0');
      }
      localStorage.setItem(doneKey2,'1');
    }
  }catch(e){}
  // Migración única: mover ajustes de anticipos a gastos (si faltan) y limpiar ajustes
  try{
    const doneKey3=LocalDB.key('anticipo_migrate_v1');
    if(!localStorage.getItem(doneKey3)){
      const aj=Data.get(Data.col.ajustes)||[];
      const ants=aj.filter(a=> String(a.tipo||'')==='anticipo_nomina');
      ants.forEach(a=>{
        // Parse ref ANT-<empId>-<yyyy-mm-dd>
        const ref=a.ref||''; const m=/^ANT-([^\-]+)-(\d{4}-\d{2}-\d{2})$/.exec(ref);
        let empleadoId=null; let fecha=a.fecha||null;
        if(m){ empleadoId=m[1]; if(!fecha) fecha=m[2]; }
        const exist=Data.get(Data.col.gastos).find(g=> g.folio===ref);
        if(!exist){
          const emp=empleadoId? LocalDB.byId(Data.col.empleados, empleadoId):null;
          Data.add(Data.col.gastos, {fecha:fecha||a.fecha||todayISO(), tipo:'Nómina', empleadoId:empleadoId, descripcion:`Anticipo ${emp?.nombre||''}`.trim(), proveedorId:null, pagadoPor:'', metodoPago:'Efectivo', importe:Number(a.salida||0), folio:ref});
        }
        // remove ajuste
        Data.del(Data.col.ajustes, a.id);
      });
      localStorage.setItem(doneKey3,'1');
    }
  }catch(e){}
}
async function bootApp(){
  loadCfg();
  runMigrations();
  initTheme();
  if(!appBooted){
    initNav();
    appBooted=true;
  }
  renderAll();
}

// Persist cfg on change
['cfg-modo','cfg-iva','cfg-margen','cfg-dec','cfg-alert','cfg-saldo-efec','cfg-saldo-banco'].forEach(id=>{
  document.addEventListener('change',e=>{
    if(e.target && e.target.id===id){ cfg.modo=document.getElementById('cfg-modo').value; cfg.iva=Number(document.getElementById('cfg-iva').value||16); cfg.margen=Number(document.getElementById('cfg-margen').value||60); cfg.decimales=Number(document.getElementById('cfg-dec').value||2); cfg.alertas=Number(document.getElementById('cfg-alert').value||7); cfg.saldoIniEfectivo=Number(document.getElementById('cfg-saldo-efec').value||0); cfg.saldoIniBanco=Number(document.getElementById('cfg-saldo-banco').value||0); localStorage.setItem(LocalDB.key('cfg'), JSON.stringify(cfg)); document.getElementById('mode-badge').textContent = 'Modo: '+cfg.modo; ventas.recalcular?.(); renderDashboard(); }
  });
});

// Redibuja charts al redimensionar
window.addEventListener('resize', debounce(()=>{ try{ renderChartsDashboard(window._dashboardInsights); }catch(e){} }, 150));

const FutureOps={
  simulateCommissionGrowth(pct=5){
    const base=window._commissionShare?.ventasCom||0;
    const total=window._commissionShare?.total||0;
    const newCommission=base*(1+pct/100);
    return {
      expectedCommission:newCommission,
      expectedSales:newCommission/COMM_RATE,
      incremental:newCommission-base,
      projectedShare: total? ((newCommission/total)*100):0
    };
  },
  recommendStaffing(){
    const avg=window._dashboardInsights?.promDiario||0;
    const recommended=Math.max(1, Math.round(avg/350));
    return {averageDaily:avg, recommendedTeam:recommended};
  },
  nextMarketingPlan(){
    const evt=marketingCalendar.nextEvent?.();
    if(!evt) return null;
    const focus = evt.type==='marketing'? 'Campaña digital + degustación temática':'Comunicación institucional con clientes frecuentes';
    return {...evt, dateISO:localDateISO(evt.date), focus};
  }
};
window.FutureOps=FutureOps;
document.getElementById('ledger-modal')?.addEventListener('click', (e)=>{ if(e.target.id==='ledger-modal'){ LedgerModal.close(); } });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') LedgerModal.close(); });
Auth.init();
Auth.autoLogin();
toggleNominaHistorial('open');
</script>
</body>
</html>
